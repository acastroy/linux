#include "LINUXV4L2.h"
#include "property.h"
#include "wrapper.h"
#include "sa7160.h"
#include "ite6603.h"
#include "mst3367.h"


#define C_PLL_FREQ 2500

#define DECODER_STATUS_CHANGE_THRESHOLD 10 // 5 seconds

BYTE COLOR_BAR_720[ 720 * 2 ];
BYTE COLOR_BAR_1280[ 1280 * 2 ];
BYTE COLOR_BAR_1920[ 1920 * 2 ];
BYTE COLOR_BAR_3840[ 3840 * 2 ];
BYTE BLACK_LINE_3840[ 3840 * 2 ];

// ##############################################################################################################################################################################

//#define SA7160_COPYPORTECT_ARCHITECTURE

#ifdef SA7160_COPYPORTECT_ARCHITECTURE

static ULONG g_copy_protect_unlock_boradsA[ 16 ] = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };

static ULONG g_copy_protect_unlock_boradsB[ 16 ] = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };

#endif

extern CDevice * g_pDevice[ 128 ];

ULONG REG_RESOLUTION_TABLE_CUSTOM[ 1 ][ 7 ][ 2 ] = {

	{ { 0x0140, 0x00000000 + 0x00000000 }, { 0x0144, 0x00000000 + 0x00000000 }, { 0x0304, 0x00000000 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000000 }, { 0x0354, 0x00000000 } },
};

ULONG REG_RESOLUTION_TABLE_GV7601[   2 ][ 7 ][ 2 ] = {

	{ { 0x0140, 0x00860002 + 0x00020000 }, { 0x0144, 0x008600F2 + 0x02D20000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A1 }, { 0x0100, 0x00004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	{ { 0x0140, 0x008C0000 + 0x00020000 }, { 0x0144, 0x008C0120 + 0x02D20000 }, { 0x0304, 0x02D00120 }, { 0x0300, 0x800020A1 }, { 0x0100, 0x00004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  288 PAL
};

ULONG REG_RESOLUTION_TABLE_TW9910[   2 ][ 7 ][ 2 ] = {

	{ { 0x0140, 0x00840000 + 0x00020000 }, { 0x0144, 0x008400F0 + 0x02D20000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A1 }, { 0x0100, 0x00004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	{ { 0x0140, 0x008A0000 + 0x00020000 }, { 0x0144, 0x008A0120 + 0x02D20000 }, { 0x0304, 0x02D00120 }, { 0x0300, 0x800020A1 }, { 0x0100, 0x00004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  288 PAL
};

ULONG REG_RESOLUTION_TABLE_ADV7181[ 4 ][ 7 ][ 2 ] = {

	{ { 0x0140, 0x00880000 + 0x00000002 }, { 0x0144, 0x008800F0 + 0x02D00002 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A1 }, { 0x0100, 0x00004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	{ { 0x0140, 0x008E0000 + 0x00000000 }, { 0x0144, 0x008E0120 + 0x02D00000 }, { 0x0304, 0x02D00120 }, { 0x0300, 0x800020A1 }, { 0x0100, 0x00004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  288 PAL
	{ { 0x0140, 0x00840000 + 0x00020000 }, { 0x0144, 0x008400F0 + 0x02D20000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC (YCBCR)
	{ { 0x0140, 0x008A0000 + 0x00020000 }, { 0x0144, 0x008A0120 + 0x02D20000 }, { 0x0304, 0x02D00120 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  288 PAL  (YCBCR)
};

ULONG REG_RESOLUTION_TABLE_IVS_SONY_CAMERA[ 5 ][ 7 ][ 2 ] = {

	{ { 0x0140, 0x01020015 + 0x00020000 }, { 0x0144, 0x010202D0 + 0x05020015 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x03008201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 30FPS
	{ { 0x0140, 0x01020015 + 0x00020000 }, { 0x0144, 0x010202D0 + 0x05020015 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x03008201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 25FPS
	{ { 0x0140, 0x01020015 + 0x00020000 }, { 0x0144, 0x010202D0 + 0x05020015 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x03008201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 24FPS
	{ { 0x0140, 0x01000015 + 0x00020000 }, { 0x0144, 0x010002D0 + 0x05020015 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x03008201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 60FPS
	{ { 0x0140, 0x01000015 + 0x00020000 }, { 0x0144, 0x010002D0 + 0x05020015 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x03008201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 50FPS
};

ULONG REG_RESOLUTION_TABLE_ISMART_CAHC_CAMERA[ 6 ][ 7 ][ 2 ] = {

	{ { 0x0140, 0x000A0000 + 0x00000000 }, { 0x0144, 0x050002CF + 0x000A0000 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 60FPS
	{ { 0x0140, 0x000A0000 + 0x00000000 }, { 0x0144, 0x050002CF + 0x000A0000 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 50FPS
	{ { 0x0140, 0x000A0000 + 0x00000000 }, { 0x0144, 0x0780021B + 0x000A0000 }, { 0x0304, 0x0780021C }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00001E00 }, { 0x0354, 0x00000F00 } }, // 1920 ×  540 NTSC
	{ { 0x0140, 0x000A0000 + 0x00000000 }, { 0x0144, 0x0780021B + 0x000A0000 }, { 0x0304, 0x0780021C }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00001E00 }, { 0x0354, 0x00000F00 } }, // 1920 ×  540 PAL
	{ { 0x0140, 0x000A0000 + 0x00000000 }, { 0x0144, 0x07800437 + 0x000A0000 }, { 0x0304, 0x07800438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 1920 × 1080 30FPS
	{ { 0x0140, 0x000A0000 + 0x00000000 }, { 0x0144, 0x07800437 + 0x000A0000 }, { 0x0304, 0x07800438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 1920 × 1080 25FPS
};

#if 1

ULONG REG_RESOLUTION_TABLE_AUTO_ITE6603 [ 7 ] = { 0x0140, 0x0144, 0x0304, 0x0300, 0x0100, 0x0344, 0x0354 };

#else

ULONG REG_RESOLUTION_TABLE_ITE6603[ 75 ][ 7 ][ 2 ] = {

	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D0011F + 0x00040000 }, { 0x0304, 0x02D00120 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  288 PAL
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D001DF + 0x00040000 }, { 0x0304, 0x02D001E0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x000005A0 }, { 0x0354, 0x00000000 } }, //  720 ×  480 NTSC
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D0023F + 0x00040000 }, { 0x0304, 0x02D00240 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x000005A0 }, { 0x0354, 0x00000000 } }, //  720 ×  576 PAL
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x050002CF + 0x00040000 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 30FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x050002CF + 0x00040000 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 25FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x050002CF + 0x00040000 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 24FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x050002CF + 0x00040000 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 60FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x050002CF + 0x00040000 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 50FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x0780021B + 0x00040000 }, { 0x0304, 0x0780021C }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00001E00 }, { 0x0354, 0x00000F00 } }, // 1920 ×  540 NTSC
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x0780021B + 0x00040000 }, { 0x0304, 0x0780021C }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00001E00 }, { 0x0354, 0x00000F00 } }, // 1920 ×  540 PAL
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x07800437 + 0x00040000 }, { 0x0304, 0x07800438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 1920 × 1080 30FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x07800437 + 0x00040000 }, { 0x0304, 0x07800438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 1920 × 1080 25FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x07800437 + 0x00040000 }, { 0x0304, 0x07800438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 1920 × 1080 24FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x03C00437 + 0x00040000 }, { 0x0304, 0x03C00438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 1920 × 1080 60FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x03C00437 + 0x00040000 }, { 0x0304, 0x03C00438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 1920 × 1080 50FPS
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x028001DF + 0x00040000 }, { 0x0304, 0x028001E0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, //  640 ×  480 60FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x03200257 + 0x00040000 }, { 0x0304, 0x03200258 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000640 }, { 0x0354, 0x00000000 } }, //  800 ×  600 60FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x040002FF + 0x00040000 }, { 0x0304, 0x04000300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000800 }, { 0x0354, 0x00000000 } }, // 1024 ×  768 60FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x050003BF + 0x00040000 }, { 0x0304, 0x050003C0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  960 60FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x050003FF + 0x00040000 }, { 0x0304, 0x05000400 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 × 1024 60FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x05A00383 + 0x00040000 }, { 0x0304, 0x05A00384 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x00000000 } }, // 1440 ×  900 60FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x000005A0 }, { 0x0354, 0x00000000 } }, //  720 ×  240 60FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D0011F + 0x00040000 }, { 0x0304, 0x02D00120 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x000005A0 }, { 0x0354, 0x00000000 } }, //  720 ×  288 50FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x0280018F + 0x00040000 }, { 0x0304, 0x02800190 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, //  640 ×  400 60FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x0280017F + 0x00040000 }, { 0x0304, 0x02800180 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, //  640 ×  384 60FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x050002FF + 0x00040000 }, { 0x0304, 0x05000300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  768 60FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x0500031F + 0x00040000 }, { 0x0304, 0x05000320 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  800 60FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x055002FF + 0x00040000 }, { 0x0304, 0x05500300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000AA0 }, { 0x0354, 0x00000000 } }, // 1360 ×  768 60FPS
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x03200257 + 0x00040000 }, { 0x0304, 0x03200258 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000640 }, { 0x0354, 0x00000000 } }, //  800 ×  600 75FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x03200257 + 0x00040000 }, { 0x0304, 0x03200258 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000640 }, { 0x0354, 0x00000000 } }, //  800 ×  600 85FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x040002FF + 0x00040000 }, { 0x0304, 0x04000300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000800 }, { 0x0354, 0x00000000 } }, // 1024 ×  768 75FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x040002FF + 0x00040000 }, { 0x0304, 0x04000300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000800 }, { 0x0354, 0x00000000 } }, // 1024 ×  768 85FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x050002FF + 0x00040000 }, { 0x0304, 0x05000300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  768 75FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x050002FF + 0x00040000 }, { 0x0304, 0x05000300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, // 1280 ×  768 85FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x0500031F + 0x00040000 }, { 0x0304, 0x05000320 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  800 75FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02800320 + 0x00040000 }, { 0x0304, 0x02800320 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, // 1280 ×  800 85FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x028003C0 + 0x00040000 }, { 0x0304, 0x028003C0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, // 1280 ×  960 75FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x028003C0 + 0x00040000 }, { 0x0304, 0x028003C0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, // 1280 ×  960 85FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02800400 + 0x00040000 }, { 0x0304, 0x02800400 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, // 1280 × 1024 75FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02800400 + 0x00040000 }, { 0x0304, 0x02800400 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, // 1280 × 1024 85FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D00384 + 0x00040000 }, { 0x0304, 0x02D00384 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x000005A0 }, { 0x0354, 0x00000000 } }, // 1440 ×  900 75FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D00384 + 0x00040000 }, { 0x0304, 0x02D00384 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000780 }, { 0x0354, 0x00000000 } }, // 1440 ×  900 85FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x07800400 + 0x00040000 }, { 0x0304, 0x07800400 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 3840 × 1024 30FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x050002CF + 0x00040000 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 60FPS SPECIAL VESA
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x03C00437 + 0x00040000 }, { 0x0304, 0x03C00438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 1920 × 1080 60FPS SPECIAL VESA
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x050003FF + 0x00040000 }, { 0x0304, 0x05000400 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 × 1024 50FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x050002CF + 0x00040000 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 59FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x050003FF + 0x00040000 }, { 0x0304, 0x05000400 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 × 1024 59FPS
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC 
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC 
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC 
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC 
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC 
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC 
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC 
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC 
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC 
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC 
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D000EF + 0x00040000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	{ { 0x0140, 0x004C0000 + 0x00020000 }, { 0x0144, 0x004C0438 + 0x07820000 }, { 0x0304, 0x07800438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 3840 × 2160 --FPS
	{ { 0x0140, 0x004C0000 + 0x00020000 }, { 0x0144, 0x004C041A + 0x057A0000 }, { 0x0304, 0x0578041A }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000AF0 }, { 0x0354, 0x00000000 } }, // 2800 × 2100 --FPS
};

#endif

ULONG REG_RESOLUTION_TABLE[ 75 ][ 7 ][ 2 ] = { // 刻度為 PIXEL

	{ { 0x0140, 0x00840000 + 0x00020000 }, { 0x0144, 0x008400F0 + 0x02D20000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  240 NTSC
	{ { 0x0140, 0x008A0000 + 0x00020000 }, { 0x0144, 0x008A0120 + 0x02D20000 }, { 0x0304, 0x02D00120 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  720 ×  288 PAL
	{ { 0x0140, 0x00840000 + 0x00020000 }, { 0x0144, 0x008401E0 + 0x02D20000 }, { 0x0304, 0x02D001E0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x000005A0 }, { 0x0354, 0x00000000 } }, //  720 ×  480 NTSC
	{ { 0x0140, 0x008A0000 + 0x00020000 }, { 0x0144, 0x008A0240 + 0x02D20000 }, { 0x0304, 0x02D00240 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x000005A0 }, { 0x0354, 0x00000000 } }, //  720 ×  576 PAL
	{ { 0x0140, 0x07DE0000 + 0x00020000 }, { 0x0144, 0x07DE02D0 + 0x05020000 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 30FPS
	{ { 0x0140, 0x0A720000 + 0x00020000 }, { 0x0144, 0x0A7202D0 + 0x05020000 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 25FPS
	{ { 0x0140, 0x0A720000 + 0x00020000 }, { 0x0144, 0x0A7202D0 + 0x05020000 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 24FPS
	{ { 0x0140, 0x016C0000 + 0x00020000 }, { 0x0144, 0x016C02D0 + 0x05020000 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 60FPS
	{ { 0x0140, 0x02B60000 + 0x00020000 }, { 0x0144, 0x02B602D0 + 0x05020000 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 50FPS
	{ { 0x0140, 0x01120000 + 0x00020000 }, { 0x0144, 0x0112021C + 0x07820000 }, { 0x0304, 0x0780021C }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00001E00 }, { 0x0354, 0x00000F00 } }, // 1920 ×  540 NTSC
//	{ { 0x0140, 0x00060000 + 0x00020000 }, { 0x0144, 0x0006021B + 0x07820000 }, { 0x0304, 0x0780021B }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00001E00 }, { 0x0354, 0x00000F00 } }, // 1920 ×  540 NTSC
	{ { 0x0140, 0x02CA0000 + 0x00020000 }, { 0x0144, 0x02CA021C + 0x07820000 }, { 0x0304, 0x0780021C }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00001E00 }, { 0x0354, 0x00000F00 } }, // 1920 ×  540 PAL
	{ { 0x0140, 0x01120000 + 0x00020000 }, { 0x0144, 0x01120438 + 0x07820000 }, { 0x0304, 0x07800438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 1920 × 1080 30FPS
//	{ { 0x0140, 0x00040000 + 0x00020000 }, { 0x0144, 0x00040438 + 0x07820000 }, { 0x0304, 0x07800438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 1920 × 1080 30FPS (廣圓電子)
	{ { 0x0140, 0x02CA0000 + 0x00020000 }, { 0x0144, 0x02CA0438 + 0x07820000 }, { 0x0304, 0x07800438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 1920 × 1080 25FPS
	{ { 0x0140, 0x03380000 + 0x00020000 }, { 0x0144, 0x03380438 + 0x07820000 }, { 0x0304, 0x07800438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 1920 × 1080 24FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x03C00438 + 0x00040000 }, { 0x0304, 0x03C00438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 1920 × 1080 60FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x03C00438 + 0x00040000 }, { 0x0304, 0x03C00438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 1920 × 1080 50FPS
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	{ { 0x0140, 0x009A0000 + 0x00020000 }, { 0x0144, 0x009A01E0 + 0x02820000 }, { 0x0304, 0x028001E0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, //  640 ×  480 60FPS
	{ { 0x0140, 0x00FA0000 + 0x00020000 }, { 0x0144, 0x00FA0258 + 0x03220000 }, { 0x0304, 0x03200258 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000640 }, { 0x0354, 0x00000000 } }, //  800 ×  600 60FPS
	{ { 0x0140, 0x013A0000 + 0x00020000 }, { 0x0144, 0x013A0300 + 0x04020000 }, { 0x0304, 0x04000300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000800 }, { 0x0354, 0x00000000 } }, // 1024 ×  768 60FPS
	{ { 0x0140, 0x02020000 + 0x00020000 }, { 0x0144, 0x020203C0 + 0x05020000 }, { 0x0304, 0x050003C0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  960 60FPS
	{ { 0x0140, 0x01920000 + 0x00020000 }, { 0x0144, 0x01920400 + 0x05020000 }, { 0x0304, 0x05000400 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 × 1024 60FPS
	{ { 0x0140, 0x01CA0000 + 0x00020000 }, { 0x0144, 0x01CA0384 + 0x05A20000 }, { 0x0304, 0x05A00384 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x00000000 } }, // 1440 ×  900 60FPS
	{ { 0x0140, 0x00710000 + 0x00020000 }, { 0x0144, 0x007100F0 + 0x02D20000 }, { 0x0304, 0x02D000F0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x000005A0 }, { 0x0354, 0x00000000 } }, //  720 ×  240 60FPS
	{ { 0x0140, 0x007E0000 + 0x00020000 }, { 0x0144, 0x007E0120 + 0x02D20000 }, { 0x0304, 0x02D00120 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x000005A0 }, { 0x0354, 0x00000000 } }, //  720 ×  288 50FPS
	{ { 0x0140, 0x00CA0000 + 0x00020000 }, { 0x0144, 0x00CA0190 + 0x02820000 }, { 0x0304, 0x02800190 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, //  640 ×  400 60FPS
	{ { 0x0140, 0x00CA0000 + 0x00020000 }, { 0x0144, 0x00CA0180 + 0x02820000 }, { 0x0304, 0x02800180 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, //  640 ×  384 60FPS
	{ { 0x0140, 0x017A0000 + 0x00020000 }, { 0x0144, 0x017A0300 + 0x05020000 }, { 0x0304, 0x05000300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  768 60FPS	
	{ { 0x0140, 0x018C0000 + 0x00000000 }, { 0x0144, 0x018C0320 + 0x05000000 }, { 0x0304, 0x05000320 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  800 60FPS
	{ { 0x0140, 0x01AC0000 + 0x00000000 }, { 0x0144, 0x01AC0300 + 0x05500000 }, { 0x0304, 0x05500300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000AA0 }, { 0x0354, 0x00000000 } }, // 1360 ×  768 60FPS
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	{ { 0x0140, 0x00FA0000 + 0x00020000 }, { 0x0144, 0x00FA0258 + 0x03220000 }, { 0x0304, 0x03200258 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000640 }, { 0x0354, 0x00000000 } }, //  800 ×  600 75FPS
	{ { 0x0140, 0x00F20000 + 0x00020000 }, { 0x0144, 0x00F20258 + 0x03220000 }, { 0x0304, 0x03200258 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000640 }, { 0x0354, 0x00000000 } }, //  800 ×  600 85FPS
	{ { 0x0140, 0x011A0000 + 0x00020000 }, { 0x0144, 0x011A0300 + 0x04020000 }, { 0x0304, 0x04000300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000800 }, { 0x0354, 0x00000000 } }, // 1024 ×  768 75FPS
	{ { 0x0140, 0x015A0000 + 0x00020000 }, { 0x0144, 0x015A0300 + 0x04020000 }, { 0x0304, 0x04000300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000800 }, { 0x0354, 0x00000000 } }, // 1024 ×  768 85FPS
	{ { 0x0140, 0x019A0000 + 0x00020000 }, { 0x0144, 0x019A0300 + 0x05020000 }, { 0x0304, 0x05000300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  768 75FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02800300 + 0x00040000 }, { 0x0304, 0x02800300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, // 1280 ×  768 85FPS
	{ { 0x0140, 0x019C0000 + 0x00000000 }, { 0x0144, 0x019C0320 + 0x05000000 }, { 0x0304, 0x05000320 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  800 75FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02800320 + 0x00040000 }, { 0x0304, 0x02800320 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, // 1280 ×  800 85FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x028003C0 + 0x00040000 }, { 0x0304, 0x028003C0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, // 1280 ×  960 75FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x028003C0 + 0x00040000 }, { 0x0304, 0x028003C0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, // 1280 ×  960 85FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02800400 + 0x00040000 }, { 0x0304, 0x02800400 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, // 1280 × 1024 75FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02800400 + 0x00040000 }, { 0x0304, 0x02800400 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, // 1280 × 1024 85FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D00384 + 0x00040000 }, { 0x0304, 0x02D00384 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x000005A0 }, { 0x0354, 0x00000000 } }, // 1440 ×  900 75FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02D00384 + 0x00040000 }, { 0x0304, 0x02D00384 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000780 }, { 0x0354, 0x00000000 } }, // 1440 ×  900 85FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x07800400 + 0x00040000 }, { 0x0304, 0x07800400 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 3840 × 1024 30FPS
	{ { 0x0140, 0x017C0000 + 0x00020000 }, { 0x0144, 0x017C02D0 + 0x05020000 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 60FPS SPECIAL VESA
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x03C00438 + 0x00040000 }, { 0x0304, 0x03C00438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 1920 × 1080 60FPS SPECIAL VESA
	{ { 0x0140, 0x018A0000 + 0x00020000 }, { 0x0144, 0x018A0400 + 0x05020000 }, { 0x0304, 0x05000400 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 × 1024 50FPS
	{ { 0x0140, 0x042A0000 + 0x00020000 }, { 0x0144, 0x042A02D0 + 0x05020000 }, { 0x0304, 0x050002D0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 ×  720 59FPS
	{ { 0x0140, 0x01920000 + 0x00020000 }, { 0x0144, 0x01920400 + 0x05020000 }, { 0x0304, 0x05000400 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000A00 }, { 0x0354, 0x00000000 } }, // 1280 × 1024 59FPS
	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	{ { 0x0140, 0x00DA0000 + 0x00020000 }, { 0x0144, 0x00DA0258 + 0x03220000 }, { 0x0304, 0x03200258 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000640 }, { 0x0354, 0x00000000 } }, //  800 ×  600 56FPS
	{ { 0x0140, 0x00BA0000 + 0x00020000 }, { 0x0144, 0x00BA01E0 + 0x02820000 }, { 0x0304, 0x028001E0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, //  640 ×  480 72FPS 
	{ { 0x0140, 0x00C20000 + 0x00020000 }, { 0x0144, 0x00C201E0 + 0x02820000 }, { 0x0304, 0x028001E0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, //  640 ×  480 75FPS 
	{ { 0x0140, 0x00BA0000 + 0x00020000 }, { 0x0144, 0x00BA01E0 + 0x02820000 }, { 0x0304, 0x028001E0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000500 }, { 0x0354, 0x00000000 } }, //  640 ×  480 85FPS 
	{ { 0x0140, 0x00EA0000 + 0x00020000 }, { 0x0144, 0x00EA0258 + 0x03220000 }, { 0x0304, 0x03200258 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000640 }, { 0x0354, 0x00000000 } }, //  800 ×  600 72FPS
	{ { 0x0140, 0x012A0000 + 0x00020000 }, { 0x0144, 0x012A0300 + 0x04020000 }, { 0x0304, 0x04000300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000800 }, { 0x0354, 0x00000000 } }, // 1024 ×  768 70FPS
	{ { 0x0140, 0x01BA0000 + 0x00020000 }, { 0x0144, 0x01BC0360 + 0x04820000 }, { 0x0304, 0x04800360 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000800 }, { 0x0354, 0x00000000 } }, // 1152 ×  864 75FPS
//	{ { 0x0140, 0x01CA0000 + 0x00020000 }, { 0x0144, 0x01CA041A + 0x057A0000 }, { 0x0304, 0x0578041A }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000578 }, { 0x0354, 0x00000000 } }, // 1400 × 1050 60FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02BC041A + 0x00040000 }, { 0x0304, 0x02BC041A }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000578 }, { 0x0354, 0x00000000 } }, // 1400 × 1050 60FPS
	{ { 0x0140, 0x011A0000 + 0x00020000 }, { 0x0144, 0x011A0300 + 0x04020000 }, { 0x0304, 0x04000300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000800 }, { 0x0354, 0x00000000 } }, // 1024 ×  768 50FPS
	{ { 0x0140, 0x00D10000 + 0x00020000 }, { 0x0144, 0x00D10190 + 0x02D20000 }, { 0x0304, 0x02D00190 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x000005A0 }, { 0x0354, 0x00000000 } }, //  720 ×  400 85FPS
	{ { 0x0140, 0x011A0000 + 0x00020000 }, { 0x0144, 0x011A0270 + 0x03420000 }, { 0x0304, 0x03400270 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x000005A0 }, { 0x0354, 0x00000000 } }, //  832 ×  624 75FPS
	{ { 0x0140, 0x011A0000 + 0x00020000 }, { 0x0144, 0x011A0258 + 0x042A0000 }, { 0x0304, 0x04280258 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000800 }, { 0x0354, 0x00000000 } }, // 1064 ×  600 60FPS
//	{ { 0x0140, 0x009A0000 + 0x00020000 }, { 0x0144, 0x009A041A + 0x057A0000 }, { 0x0304, 0x0578041A }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000578 }, { 0x0354, 0x00000000 } }, // 1400 × 1050 61FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x02BC041A + 0x00040000 }, { 0x0304, 0x02BC041A }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000578 }, { 0x0354, 0x00000000 } }, // 1400 × 1050 60FPS

	//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	{ { 0x0140, 0x011A0000 + 0x00020000 }, { 0x0144, 0x011A0258 + 0x04020000 }, { 0x0304, 0x04000258 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000800 }, { 0x0354, 0x00000000 } }, // 1024 ×  600 60FPS SEGA
	{ { 0x0140, 0x019C0000 + 0x00000000 }, { 0x0144, 0x019C0300 + 0x05500000 }, { 0x0304, 0x05500300 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000AA0 }, { 0x0354, 0x00000000 } }, // 1360 ×  768 61FPS SEGA
	{ { 0x0140, 0x01CA0000 + 0x00020000 }, { 0x0144, 0x01CA021C + 0x05A20000 }, { 0x0304, 0x05A0021C }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00001680 }, { 0x0354, 0x00000B40 } }, // 1440 ×  540 50FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x0348041A + 0x00040000 }, { 0x0304, 0x0348041A }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000690 }, { 0x0354, 0x00000000 } }, // 1680 × 1050 --FPS
	{ { 0x0140, 0x00C20000 + 0x00020000 }, { 0x0144, 0x00C20258 + 0x03220000 }, { 0x0304, 0x03200258 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000640 }, { 0x0354, 0x00000000 } }, //  800 ×  600 75FPS SPECIAL ALOKA A10 (超聲波)

	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x07800258 + 0x00040000 }, { 0x0304, 0x07800258 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 1920 × 1200 --FPS

//	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x000004B0 + 0x03240000 }, { 0x0304, 0x032004B0 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000640 }, { 0x0354, 0x00000000 } }, // 1600 × 1200 --FPS
	{ { 0x0140, 0x00000000 + 0x00040000 }, { 0x0144, 0x00000258 + 0x06440000 }, { 0x0304, 0x06400258 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000C80 }, { 0x0354, 0x00000000 } }, // 1600 × 1200 --FPS
//	{ { 0x0140, 0x00040000 + 0x00000000 }, { 0x0144, 0x0004021C + 0x07800000 }, { 0x0304, 0x0780021C }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 3840 × 2160 --FPS
	{ { 0x0140, 0x00040000 + 0x00000000 }, { 0x0144, 0x00040438 + 0x07800000 }, { 0x0304, 0x07800438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 3840 × 2160 --FPS
//	{ { 0x0140, 0x00000000 + 0x00020000 }, { 0x0144, 0x00000438 + 0x07820000 }, { 0x0304, 0x07800438 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000F00 }, { 0x0354, 0x00000000 } }, // 3840 × 2160 --FPS
	{ { 0x0140, 0x00940000 + 0x00020000 }, { 0x0144, 0x00940120 + 0x03020000 }, { 0x0304, 0x03000120 }, { 0x0300, 0x800020A0 }, { 0x0100, 0x01004001 }, { 0x0344, 0x00000B40 }, { 0x0354, 0x000005A0 } }, //  768 ×  288 50FPS SPECAIL FOR VISION4CE
	{ { 0x0140, 0x01020000 + 0x00020000 }, { 0x0144, 0x01020258 + 0x03220000 }, { 0x0304, 0x03200258 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000640 }, { 0x0354, 0x00000000 } }, //  800 ×  600 56FPS
	{ { 0x0140, 0x014A0000 + 0x00020000 }, { 0x0144, 0x014A0200 + 0x03020000 }, { 0x0304, 0x03000200 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000600 }, { 0x0354, 0x00000000 } }, //  768 ×  512 56FPS
	{ { 0x0140, 0x00DA0000 + 0x00020000 }, { 0x0144, 0x00DA01F4 + 0x03220000 }, { 0x0304, 0x032001F4 }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000640 }, { 0x0354, 0x00000000 } }, //  800 ×  500 75FPS
	{ { 0x0140, 0x004C0000 + 0x00020000 }, { 0x0144, 0x004C041A + 0x057A0000 }, { 0x0304, 0x0578041A }, { 0x0300, 0x000020A0 }, { 0x0100, 0x01004201 }, { 0x0344, 0x00000AF0 }, { 0x0354, 0x00000000 } }, // 2800 × 2100 --FPS
}
;

// ##############################################################################################################################################################################
// #
// # PRODUCT NAME: SA7160
// #        CHIPS: NXP SAA7160
// #  MANUFACTORY: NXP
// #         DATE: 2010.08.02 ~ 2010.12.31
// #      CONTACT: 
// #      CONTACT: 
// #
// ##############################################################################################################################################################################
// 


ULONG SA7160_GetRegister( CDevice * pDevice, ULONG dwIndex )
{
/*
	if( nBytes == 4 ) { return readl( (pDevice->m_pRegBaseCommonBuffer[ 0 ] + dwIndex) ) & 0xFFFFFFFF; }

	if( nBytes == 2 ) { return readw( (pDevice->m_pRegBaseCommonBuffer[ 0 ] + dwIndex) ) & 0x0000FFFF; }

	if( nBytes == 1 ) { return readb( (pDevice->m_pRegBaseCommonBuffer[ 0 ] + dwIndex) ) & 0x000000FF; }
*/
	return readl( (pDevice->m_pRegBaseCommonBuffer[ 0 ] + dwIndex) ) & 0xFFFFFFFF;

	return 0x00000000;
}

BOOLEAN SA7160_SetRegister( CDevice * pDevice, ULONG dwIndex, ULONG dwValue)
{
/*
	if( nBytes == 4 ) { writel( (dwValue & 0xFFFFFFFF), (pDevice->m_pRegBaseCommonBuffer[ 0 ] + dwIndex) ); }

	if( nBytes == 2 ) { writew( (dwValue & 0x0000FFFF), (pDevice->m_pRegBaseCommonBuffer[ 0 ] + dwIndex) ); }

	if( nBytes == 1 ) { writeb( (dwValue & 0x000000FF), (pDevice->m_pRegBaseCommonBuffer[ 0 ] + dwIndex) ); }
*/
	writel( (dwValue & 0xFFFFFFFF), (pDevice->m_pRegBaseCommonBuffer[ 0 ] + dwIndex) ); 
	
	return TRUE;
}

BOOLEAN SA7160_GetSlaveDeviceByte( CDevice * pDevice, ULONG nBus, BYTE * pData )
{
	// -----> CI2CLayer_IP3204::ReceiveData()
	// 
	ULONG R0000B008 = 0x00000000;

	ULONG i = 0;

	for( i = 0 ; i < 10000 ; i++ ) {

		R0000B008 = SA7160_GetRegister( pDevice, 0x0000B000 + nBus * 0x00001000 + 0x0008 ); // I2C.STATUS

		if( (R0000B008 & 0x00000410) == 0x00000000 ) { break ; }
		else
		{
			if( pDevice->iManufacturer == 0x0A || pDevice->iManufacturer == 0x0D || pDevice->iManufacturer == 0x18 || pDevice->iManufacturer == 0x1A ) {
				
				wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(1) );
			}
		}

	//	DELAY_100NS( 100 );
	}
	if( R0000B008 & 0x00000410 ) { LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_GetSlaveDeviceByte( 1 ): GET BYTE 0x0000B008 = %08lX ERROR!!\n", pDevice->m_nKsDeviceNumber, R0000B008 ); return FALSE; }

   *pData = (BYTE)(SA7160_GetRegister( pDevice, 0x0000B000 + nBus * 0x00001000 + 0x0000 )); // I2C.RX.FIFO 

	return TRUE;
}

BOOLEAN SA7160_SetSlaveDeviceByte( CDevice * pDevice, ULONG nBus, USHORT wData )
{
	// -----> CI2CLayer_IP3204::SendData()
	// 
	ULONG R0000B008 = 0x00000000;

	ULONG i = 0 ;

	for( i = 0 ; i < 1000 ; i++ ) {

		R0000B008 = SA7160_GetRegister( pDevice, 0x0000B000 + nBus * 0x00001000 + 0x0008 ); // I2C.STATUS

		if( (R0000B008 & 0x00000880) == 0x00000000 ) { break ; }
		else
		{
			if( pDevice->iManufacturer == 0x0A || pDevice->iManufacturer == 0x0D || pDevice->iManufacturer == 0x18 || pDevice->iManufacturer == 0x1A ) {
			
				wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(1) );
			}
		}

	//	DELAY_100NS( 100 );
	}
	if( R0000B008 & 0x00000880 ) { LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_SetSlaveDeviceByte( 1 ): SET BYTE 0x0000B008 = %08lX ERROR!!\n", pDevice->m_nKsDeviceNumber, R0000B008 ); return FALSE; }

	SA7160_SetRegister( pDevice, 0x0000B000 + nBus * 0x00001000 + 0x0000, wData ); // I2C.TX.FIFO 

	for( i = 0 ; i < 5000; i++ ) {

		R0000B008 = SA7160_GetRegister( pDevice, 0x0000B000 + nBus * 0x00001000 + 0x0008 ); // I2C.STATUS

		if( R0000B008 & 0x00000040 ) { break ; }
		else
		{
			if( pDevice->iManufacturer == 0x0A || pDevice->iManufacturer == 0x0D || pDevice->iManufacturer == 0x18 || pDevice->iManufacturer == 0x1A ) {
				
				wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(1) );
			}
		}


	//	DELAY_100NS( 100 );
	}
	if( (R0000B008 & 0x00000040) == 0x00000000 )  { LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_SetSlaveDeviceByte( 2 ): SET BYTE 0x0000B008 = %08lX ERROR!!\n", pDevice->m_nKsDeviceNumber, R0000B008 );  return FALSE; }
//	LINUXV4L2_DEBUG( KERN_INFO, "kkk:SA7160_SetSlaveDeviceByte(%ld) = 0x%08X \n", nBus, wData );

	return TRUE;
}

BOOLEAN SA7160_GetSlaveDeviceRegister( CDevice * pDevice, ULONG nBus, BYTE * pIndex, ULONG nIndexLen, BYTE * pValue, ULONG nValueLen )
{
	SA7160_SetRegister( pDevice, 0x0000B000 + nBus * 0x00001000 + 0x0FE8, 0x00001FFF ); // I2C.INT.CLR.STATUS

	BYTE * po = pIndex;

	BYTE * pe = pValue;

	ULONG i = 0;

	ULONG j = 0;

	// -----> CI2CLayer_IP3204::ReadSequence() -----> CI2CLayer_IP3204::WriteSequence() 
	//
	for( i = 0 ; i < nIndexLen ; i++ ) {

		if( i == 0 ) { 
			
			ULONG R0000BFE0 = 0x00000000;

			if( FALSE == SA7160_SetSlaveDeviceByte( pDevice, nBus, 0x00000100 | *po++ ) ) { LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_GetSlaveDeviceRegister( 1 ): GET REGISTER %02X x %02X ERROR!!\n", pDevice->m_nKsDeviceNumber, pIndex[ 0 ], pIndex[ 1 ] ); goto I2C_GET_ERROR; }

			for( j = 0 ; j < 10000 ; j++ ) {

				R0000BFE0 = SA7160_GetRegister( pDevice, 0x0000B000 + nBus * 0x00001000 + 0x0FE0 ); // I2C.INT.STATUS

				if( R0000BFE0 & 0x000000C7 )
				{
					break;
				}
				else
				{
					if( pDevice->iManufacturer == 0x0A || pDevice->iManufacturer == 0x0D || pDevice->iManufacturer == 0x18 || pDevice->iManufacturer == 0x1A ) {
					
						wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(1) );
					}
				}

			//	DELAY_100NS( 100 );
			}
			SA7160_SetRegister( pDevice, 0x0000B000 + nBus * 0x00001000 + 0x0FE8, R0000BFE0 ); // I2C.INT.CLR.STATUS

			if( R0000BFE0 & 0x00000046 ) { LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_GetSlaveDeviceRegister( 1 ): GET REGISTER %02X x %02X x 0x0000BFE0 = %08lX ERROR!!\n", pDevice->m_nKsDeviceNumber, pIndex[ 0 ], pIndex[ 1 ], R0000BFE0 ); goto I2C_GET_ERROR; }
		} 
		else {

			if( FALSE == SA7160_SetSlaveDeviceByte( pDevice, nBus, *po++ ) ) { LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_GetSlaveDeviceRegister( 2 ): GET REGISTER %02X x %02X ERROR!!\n", pDevice->m_nKsDeviceNumber, pIndex[ 0 ], pIndex[ 1 ] ); goto I2C_GET_ERROR; }
		}
	}

	// -----> CI2CLayer_IP3204::ReadSequence() 
	//
	SA7160_SetSlaveDeviceByte( pDevice, nBus, 0x00000100 | pIndex[ 0 ] | 0x01 );

	for( i = 0 ; i < nValueLen - 1 ; i++ ) {

		if( FALSE == SA7160_SetSlaveDeviceByte( pDevice, nBus, 0x00 ) ) { LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_GetSlaveDeviceRegister( 4 ): GET REGISTER %02X x %02X ERROR!!\n", pDevice->m_nKsDeviceNumber, pIndex[ 0 ], pIndex[ 1 ] ); goto I2C_GET_ERROR; }

		if( FALSE == SA7160_GetSlaveDeviceByte( pDevice, nBus, pe++ ) ) { LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_GetSlaveDeviceRegister( 5 ): GET REGISTER %02X x %02X ERROR!!\n", pDevice->m_nKsDeviceNumber, pIndex[ 0 ], pIndex[ 1 ] ); goto I2C_GET_ERROR; }
	}
	if( FALSE == SA7160_SetSlaveDeviceByte( pDevice, nBus, 0x00000200 ) ) { LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_GetSlaveDeviceRegister( 6 ): GET REGISTER %02X x %02X ERROR!!\n", pDevice->m_nKsDeviceNumber, pIndex[ 0 ], pIndex[ 1 ] ); goto I2C_GET_ERROR; }

	if( FALSE == SA7160_GetSlaveDeviceByte( pDevice, nBus, pe++ ) ) { LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_GetSlaveDeviceRegister( 7 ): GET REGISTER %02X x %02X ERROR!!\n", pDevice->m_nKsDeviceNumber, pIndex[ 0 ], pIndex[ 1 ] ); goto I2C_GET_ERROR; }

	return TRUE;

I2C_GET_ERROR:

	SA7160_HARDWARE_I2C_RESET( pDevice );

	return FALSE;
}

BOOLEAN SA7160_SetSlaveDeviceRegister( CDevice * pDevice, ULONG nBus, BYTE * pIndexVlaue, ULONG nIndexVlaueLen )
{
	SA7160_SetRegister( pDevice, 0x0000B000 + nBus * 0x00001000 + 0x0FE8, 0x00001FFF ); // I2C.INT.CLR.STATUS

	BYTE * po = pIndexVlaue;

	ULONG i = 0;

	ULONG j = 0;

	// -----> CI2CLayer_IP3204::WriteSequence() 
	//
	for( i = 0 ; i < nIndexVlaueLen ; i++ ) {

		if( i == 0 ) { 
			
			ULONG R0000BFE0 = 0x00000000;

			if( FALSE == SA7160_SetSlaveDeviceByte( pDevice, nBus, 0x00000100 | *po++ ) ) { LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_SetSlaveDeviceRegister( 1 ): SET REGISTER %02X x %02X ERROR!!\n", pDevice->m_nKsDeviceNumber, pIndexVlaue[ 0 ], pIndexVlaue[ 1 ] ); goto I2C_SET_ERROR; }

			for( j = 0 ; j < 10000 ; j++ ) {

				R0000BFE0 = SA7160_GetRegister( pDevice, 0x0000B000 + nBus * 0x00001000 + 0x0FE0 ); // I2C.INT.STATUS

				if( R0000BFE0 & 0x000000C7 ) 
				{ 
					break;
				} 
				else
				{
					if( pDevice->iManufacturer == 0x0A || pDevice->iManufacturer == 0x0D || pDevice->iManufacturer == 0x18 || pDevice->iManufacturer == 0x1A ) {
					
						wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(1) );
					}
				}

			//	DELAY_100NS( 100 );
			}
			SA7160_SetRegister( pDevice, 0x0000B000 + nBus * 0x00001000 + 0x0FE8, R0000BFE0 ); // I2C.INT.CLR.STATUS

			if( R0000BFE0 & 0x00000046 ) { LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_SetSlaveDeviceRegister( 1 ): SET REGISTER %02X x %02X x 0x0000BFE0 = %08lX ERROR!!\n", pDevice->m_nKsDeviceNumber, pIndexVlaue[ 0 ], pIndexVlaue[ 1 ], R0000BFE0 ); goto I2C_SET_ERROR; }
		} 
		else if( i == nIndexVlaueLen - 1 ) { 
			
			if( FALSE == SA7160_SetSlaveDeviceByte( pDevice, nBus, 0x00000200 | *po++ ) ) { LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_SetSlaveDeviceRegister( 3 ): SET REGISTER %02X x %02X ERROR!!\n", pDevice->m_nKsDeviceNumber, pIndexVlaue[ 0 ], pIndexVlaue[ 1 ] ); goto I2C_SET_ERROR; }
		} 
		else {

			if( FALSE == SA7160_SetSlaveDeviceByte( pDevice, nBus, *po++ ) ) { LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_SetSlaveDeviceRegister( 2 ): SET REGISTER %02X x %02X ERROR!!\n", pDevice->m_nKsDeviceNumber, pIndexVlaue[ 0 ], pIndexVlaue[ 1 ] ); goto I2C_SET_ERROR; }
		}
	}

#if 0 // DEBUG

	for( i = 0 ; i < nIndexVlaueLen ; i++ ) {

		if( i == 0 ) { LINUXV4L2_DEBUG( KERN_INFO, "SA7160_SetSlaveDeviceRegister( )" ); }
			
		if( i == nIndexVlaueLen - 1 ) {
			
			LINUXV4L2_DEBUG( KERN_INFO, "0x%02X )\n", pIndexVlaue[ i ] );
		} 
		else { 
			
			LINUXV4L2_DEBUG( KERN_INFO, "0x%02X, ", pIndexVlaue[ i ] );
		}
	}

#endif
//	LINUXV4L2_DEBUG( KERN_INFO, "kkk:SA7160_SetSlaveDeviceRegister(%ld) = 0x%02X length=%ld \n", nBus, pIndexVlaue[0], nIndexVlaueLen );

	return TRUE;

I2C_SET_ERROR:

	SA7160_HARDWARE_I2C_RESET( pDevice );

	return FALSE;
}



void SwitchI2CBank( CDevice * pDevice, BYTE bank)
{
	BYTE TX[ 3 ] = { 0x9C, 0x00, 0x00 }; // MST3367

	BYTE RX = 0x00;

	BYTE temp;

	//read bank address

	SA7160_GetSlaveDeviceRegister( pDevice, 1, TX, 2, &RX, 1 );

	temp = RX;

	temp = temp & 0x3C;

	TX[ 2 ] = ( temp | bank );

	SA7160_SetSlaveDeviceRegister( pDevice, 1, TX, 3 );

	pDevice->m_MST3367_bank = bank;
}


BYTE SA7160_GetMST3367Register( CDevice * pDevice, BYTE nBank, BYTE nIndex )
{

	BYTE TX[ 3 ] = { 0x9C, 0x00, 0x00 }; // MST3367

	BYTE RX[ 1 ] = { 0x00 };
/*
	TX[ 1 ] = 0x00; 
	
	TX[ 2 ] = nBank; 

	SA7160_SetSlaveDeviceRegister( pDevice, 1, TX, 3 );

*/
	if(pDevice->m_MST3367_bank != nBank)
	{
		SwitchI2CBank( pDevice, nBank);
	}

	TX[ 1 ] = nIndex; 
	
	SA7160_GetSlaveDeviceRegister( pDevice, 1, TX, 2, RX, 1 );

	return RX[ 0 ];
}
 
BOOLEAN SA7160_SetMST3367Register( CDevice * pDevice, BYTE nBank, BYTE nIndex, BYTE bValue )
{

	BYTE TX[ 3 ] = { 0x9C, 0x00, 0x00 }; // MST3367

	BYTE RX[ 1 ] = { 0x00 };
/*
	TX[ 1 ] = 0x00; 
	
	TX[ 2 ] = nBank; 

	SA7160_SetSlaveDeviceRegister( pDevice, 1, TX, 3 );
*/
	if(pDevice->m_MST3367_bank != nBank)
	{
		SwitchI2CBank( pDevice, nBank);
	}

	TX[ 1 ] = nIndex; 

	TX[ 2 ] = bValue; 
	
	SA7160_SetSlaveDeviceRegister( pDevice, 1, TX, 3 );

	if( nIndex == 0x00)
	{
		pDevice->m_MST3367_bank = bValue;
	}

	return TRUE;
}

BYTE SA7160_GetAnalogVideoDecoderRegister( CDevice * pDevice, BYTE nIndex )
{
	BYTE TX[ 2 ] = { 0x88, 0x00 }; // TW9910

	TX[ 1 ] = nIndex; 

	BYTE RX =  0x00;

	SA7160_GetSlaveDeviceRegister( pDevice, 1, TX, 2, &RX, 1 );

	return RX;
}

BOOLEAN SA7160_SetAnalogVideoDecoderRegister( CDevice * pDevice, BYTE nIndex, BYTE bValue )
{
	BYTE TX[ 3 ] = { 0x88, 0x00, 0x00 }; // TW9910

	TX[ 1 ] = nIndex; 

	TX[ 2 ] = bValue; 
	
	SA7160_SetSlaveDeviceRegister( pDevice, 1, TX, 3 );

	return TRUE;
}

BYTE SA7160_GetAnalogAudioDecoderRegister( CDevice * pDevice, BYTE nIndex )
{
	BYTE TX[ 2 ] = { 0x94, 0x00 }; // CS53L21

	TX[ 1 ] = nIndex; 

	BYTE RX =  0x00;

	SA7160_GetSlaveDeviceRegister( pDevice, 1, TX, 2, &RX, 1 );

	return RX;
}

BOOLEAN SA7160_SetAnalogAudioDecoderRegister( CDevice * pDevice, BYTE nIndex, BYTE bValue )
{
	BYTE TX[ 3 ] = { 0x94, 0x00, 0x00 }; // CS53L21

	TX[ 1 ] = nIndex; 

	TX[ 2 ] = bValue; 
	
	SA7160_SetSlaveDeviceRegister( pDevice, 1, TX, 3 );

	return TRUE;
}

BYTE SA7160_GetITE6603Register( CDevice * pDevice, BYTE nIndex )
{
	if( pDevice )
	{
		BYTE TX[ 2 ] = { 0x90, 0x00 };
	
		BYTE RX[ 1 ] = { 0x00 };
	
		TX[ 1 ] = nIndex; 
		
		SA7160_GetSlaveDeviceRegister( pDevice, 1, TX, 2, RX, 1 );
	
		return RX[ 0 ];
	}
	return 0;

}

BOOLEAN SA7160_GetITE6603Register_EX( CDevice * pDevice, BYTE nIndex, ULONG bBytes, BYTE * pValue ) 
{
	if( pDevice )
	{
		BYTE TX[ 2 ] = { 0x90, 0x00 };
	
		TX[ 1 ] = nIndex; 
	
		return SA7160_GetSlaveDeviceRegister( pDevice, 1, TX, 2, pValue, bBytes );
	}
	return true;
}

BOOLEAN SA7160_SetITE6603Register( CDevice * pDevice, BYTE nIndex, BYTE bValue )
{
	if( pDevice )
	{
		BYTE TX[ 3 ] = { 0x90, 0x00, 0x00 };
	
		TX[ 1 ] = nIndex; 
	
		TX[ 2 ] = bValue; 
		
		SA7160_SetSlaveDeviceRegister( pDevice, 1, TX, 3 );
	}
	return TRUE;
}

BOOLEAN SA7160_SetITE6603Register_EX( CDevice * pDevice, BYTE nIndex, ULONG bBytes, BYTE * pValue )
{
	if( pDevice )
	{
		BYTE TX[ 2 + 20 ] = { 0x00, 0x00 }; // MAX_IT6003_I2C_NUM = 20
	
		TX[ 0 ] = 0x90; 
	
		TX[ 1 ] = nIndex; 
	
		ULONG i = 0;
		for( i = 0 ; i < bBytes ; i++ ) { TX[ i + 2 ] = pValue[ i ]; }
	
		SA7160_SetSlaveDeviceRegister( pDevice, 1, TX, bBytes + 2 );
	}
	return TRUE;
}

BOOLEAN SA7160_GetADV7619Register( CDevice * pDevice, BYTE nAddr, BYTE nIndex, BYTE * pValue )
{
	BYTE TX[ 2 ] = { 0x9A, 0x00 };

	TX[ 0 ] = nAddr;

	TX[ 1 ] = nIndex; 

	BYTE RX[ 1 ] = { 0x00 };

	ULONG i = 0;
	
	for( i = 0 ; i < 5 ; i++ ) {

		BOOLEAN returns = SA7160_GetSlaveDeviceRegister( pDevice, 1, TX, 2, RX, 1 );

		if( returns == TRUE ) {

		   *pValue = RX[ 0 ];

			return TRUE;
		}
		else {

			LINUXV4L2_DEBUG( KERN_INFO,"[CH%02d] SA7160_GetADV7619Register(): GET BYTE %02X ERROR!!\n", pDevice->m_nKsDeviceNumber, nIndex);
		}
		
		wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(1) );

	}
	return FALSE;
}

BOOLEAN SA7160_SetADV7619Register( CDevice * pDevice, BYTE nAddr, BYTE nIndex, BYTE bValue )
{
	BYTE TX[ 3 ] = { 0x9A, 0x00, 0x00 };
	
	TX[ 0 ] = nAddr;
	
	TX[ 1 ] = nIndex; 

	TX[ 2 ] = bValue;
	 
	ULONG i = 0;
	
	for( i = 0 ; i < 5 ; i++ ) {
	
		BOOLEAN returns = SA7160_SetSlaveDeviceRegister( pDevice, 1, TX, 3 );

		if( returns == TRUE ) {

			return TRUE;
		}
		else {

			LINUXV4L2_DEBUG( KERN_INFO,"[CH%02d] SA7160_GetADV7619Register(): SET BYTE %02X.%02X ERROR!!\n", pDevice->m_nKsDeviceNumber, nIndex, bValue);
		}
		wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(1) );

	}
	return FALSE;
}

BYTE SA7160_GetFpgaRegister( CDevice * pDevice, BYTE nIndex )
{
	if( pDevice->iManufacturer == 0x19 ||  // SC510N1.2ND

		pDevice->iManufacturer == 0x0A ||  // SC500N1.HDMI.ITE6603

		pDevice->iManufacturer == 0x0D ) { // SC500N1.MC.HDMI.ITE6603

		;
	}
	else if( (pDevice->iManufacturer == 0x01 && pDevice->iProduct == 0x07) || // EURESYS.SC510N1.1ST
		
			 (pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST
				
			 (pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST

	  		 pDevice->iManufacturer == 0x10 ||  // SC510N1.1ST

			 pDevice->iManufacturer == 0x12 ||  // SC510N1.SDI.1ST
			
			 (pDevice->iManufacturer == 0x13) ||  // SC510N2.HDMI.4K2K.ADV7619.1ST

			 (pDevice->iManufacturer == 0x14) ||  // SC510N1.SDI.1ST

			 (pDevice->iManufacturer == 0x16) ||  // SC512N1.DVI.1ST

			 pDevice->iManufacturer == 0x17 ||  // SC512N1.DVI.1ST

			 pDevice->iManufacturer == 0x18 ||  // SC510N1.HDMI.ITE6603.1ST
			
			 pDevice->iManufacturer == 0x1A ||  // SC510N4.HDMI.ITE6603
			
			 pDevice->iManufacturer == 0x1B ) { // SC510N4.SDI

		BYTE TX[ 2 ] = { 0x98, 0x00 };

		BYTE RX[ 1 ] = { 0x00 };

		TX[ 1 ] = nIndex;

		SA7160_GetSlaveDeviceRegister( pDevice, 1, TX, 2, RX, 1 );

		return RX[ 0 ];
	}
	else {

		BYTE TX[ 2 ] = { 0x90, 0x00 };

		BYTE RX[ 1 ] = { 0x00 };

		TX[ 1 ] = nIndex;

		SA7160_GetSlaveDeviceRegister( pDevice, 1, TX, 2, RX, 1 );

		return RX[ 0 ];
	}
	return 0x00;
}

BOOLEAN SA7160_SetFpgaRegister( CDevice * pDevice, BYTE nIndex, BYTE nValue )
{
	BOOLEAN returns = TRUE;

	if( pDevice->iManufacturer == 0x19 ||  // SC510N1.2ND

		pDevice->iManufacturer == 0x0A ||  // SC500N1.HDMI.ITE6603

		pDevice->iManufacturer == 0x0D ) { // SC500N1.MC.HDMI.ITE6603

		;
	}
	else if( (pDevice->iManufacturer == 0x01 && pDevice->iProduct == 0x07) || // EURESYS.SC510N1.1ST

			 (pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST
				
			 (pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST

			 pDevice->iManufacturer == 0x10 ||  // SC510N1.1ST
			
			 pDevice->iManufacturer == 0x12 ||  // SC510N1.SDI.1ST
			
			 (pDevice->iManufacturer == 0x13) ||  // SC510N2.HDMI.4K2K.ADV7619.1ST
			
			 (pDevice->iManufacturer == 0x14) ||  // SC510N1.SDI.1ST

			 (pDevice->iManufacturer == 0x16) ||  // SC512N1.DVI.1ST

			 pDevice->iManufacturer == 0x17 ||  // SC512N1.DVI.1ST

			 pDevice->iManufacturer == 0x18 ||  // SC510N1.HDMI.ITE6603.1ST

			 pDevice->iManufacturer == 0x1A ||  // SC510N4.HDMI.ITE6603
			
			 pDevice->iManufacturer == 0x1B ) { // SC510N4.SDI

		BYTE TX[ 3 ] = { 0x98, 0x00, 0x00 };

		TX[ 1 ] = nIndex;

		TX[ 2 ] = nValue;

		returns = SA7160_SetSlaveDeviceRegister( pDevice, 1, TX, 3 );
	}
	else {

		BYTE TX[ 3 ] = { 0x90, 0x00, 0x00 };

		TX[ 1 ] = nIndex;

		TX[ 2 ] = nValue;

		returns = SA7160_SetSlaveDeviceRegister( pDevice, 1, TX, 3 );
	}
	return returns;
}


VOID SA7160_I2C_SET_SCL( CDevice * pDevice, BYTE DATA, ULONGLONG DELAY )
{
	
	ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); R0000E004 &= 0xFFFF7FFF;

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 | (DATA << 15) );

	ndelay( DELAY * 100);
}

VOID SA7160_I2C_SET_SDA( CDevice * pDevice, BYTE DATA, ULONGLONG DELAY )
{
	ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); R0000E004 &= 0xFFFFBFFF;

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 | (DATA << 14) );

	ndelay( DELAY * 100);
}

VOID SA7160_I2C_SET_PIN( CDevice * pDevice, BYTE DATA, ULONGLONG DELAY ) 
{
	BYTE SCL = (DATA >> 0) & (0x01);

	BYTE SDA = (DATA >> 1) & (0x01);

	ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); R0000E004 &= 0xFFFF3FFF;

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 | (SDA << 14) | (SCL << 15) );

	ndelay( DELAY * 100);
}

BYTE SA7160_I2C_GET_SDA( CDevice * pDevice, ULONGLONG DELAY ) 
{
	ULONG R0000E00C = SA7160_GetRegister( pDevice, 0x0000E000 + 0x000C ); // GPIO.OEN

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x000C, R0000E00C | 0x00004000 ); // GPIO.OEN

	ULONG R0000E000 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0000 ); R0000E000 >>= 14; // GPIO.RD

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x000C, R0000E00C & 0xFFFFBFFF ); // GPIO.OEN

	ndelay( DELAY * 100);

	return (BYTE)(R0000E000 & 0x00000001);
}

BOOL SA7160_I2C_START( CDevice * pDevice, ULONGLONG DELAY )
{
	SA7160_I2C_SET_SDA( pDevice, 1, DELAY ); // //

	SA7160_I2C_SET_PIN( pDevice, 3, DELAY ); //

	SA7160_I2C_SET_PIN( pDevice, 1, DELAY ); // //

	SA7160_I2C_SET_PIN( pDevice, 0, DELAY ); //

	return TRUE;
}

BOOL SA7160_I2C_STOP( CDevice * pDevice, ULONGLONG DELAY )
{
	SA7160_I2C_SET_SCL( pDevice, 0, DELAY ); //

	SA7160_I2C_SET_PIN( pDevice, 0, DELAY ); // //

	SA7160_I2C_SET_PIN( pDevice, 1, DELAY ); //

	SA7160_I2C_SET_PIN( pDevice, 3, DELAY ); //

	return TRUE;
}

BOOL SA7160_I2C_WAIT_ACK( CDevice * pDevice, ULONGLONG DELAY )
{	
//	SA7160_I2C_SET_PIN( pDevice, 1, DELAY );         // 

	SA7160_I2C_SET_PIN( pDevice, 3, DELAY );         //

	BYTE ACK = SA7160_I2C_GET_SDA( pDevice, DELAY ); //

	SA7160_I2C_SET_PIN( pDevice, 0, DELAY );         //

	return (ACK == 0) ? TRUE : FALSE;                //
}

BOOL SA7160_I2C_REPLY_ACK( CDevice * pDevice, BYTE ACK, ULONGLONG DELAY )
{
	SA7160_I2C_SET_PIN( pDevice, (ACK) ? 2 : 0, DELAY ); //

	SA7160_I2C_SET_PIN( pDevice, (ACK) ? 3 : 1, DELAY ); //

	SA7160_I2C_SET_PIN( pDevice, (ACK) ? 2 : 0, DELAY ); //

	return TRUE;
}

BOOL SA7160_I2C_WRITE_BYTE( CDevice * pDevice, BYTE DATA, ULONGLONG DELAY )
{
	UINT i = 0;

	for( i = 0 ; i < 8 ; i++, DATA <<= 1 ) {                    //

		SA7160_I2C_SET_PIN( pDevice, (DATA & 0x80) ? 2 : 0, DELAY ); //

		SA7160_I2C_SET_PIN( pDevice, (DATA & 0x80) ? 3 : 1, DELAY ); //

		SA7160_I2C_SET_PIN( pDevice, (DATA & 0x80) ? 2 : 0, DELAY ); //
	}
	return SA7160_I2C_WAIT_ACK( pDevice, DELAY );                    //
}

BYTE SA7160_I2C_READ_BYTE( CDevice * pDevice, BYTE ACK, ULONGLONG DELAY )
{	
	BYTE DATA = 0x00;

	UINT i = 0;

	for( i = 0 ; i < 8 ; i++ ) {									//

		SA7160_I2C_SET_PIN( pDevice, 1, DELAY );					//

		DATA = (DATA << 1) | SA7160_I2C_GET_SDA( pDevice, DELAY );	//

		SA7160_I2C_SET_PIN( pDevice, 0, DELAY );					//
	}
	SA7160_I2C_REPLY_ACK( pDevice, ACK, DELAY );					//

	return DATA;
}

VOID SA7160_GSPI_SET_SCLK( CDevice * pDevice, BYTE DATA, ULONGLONG DELAY )
{
	ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); R0000E004 &= ~0x00000004; R0000E004 |= (DATA << 2); // GPIO.WR

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 ); // GPIO.WR

	ndelay( DELAY * 100);
}

VOID SA7160_GSPI_SET_CS( CDevice * pDevice, BYTE DATA, ULONGLONG DELAY )
{
	ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); R0000E004 &= ~0x00000040; R0000E004 |= (DATA << 6); // GPIO.WR

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 ); // GPIO.WR

	ndelay( DELAY * 100);
}

VOID SA7160_GSPI_SET_SDIN( CDevice * pDevice, BYTE DATA, ULONGLONG DELAY )
{
	ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); R0000E004 &= ~0x00000008; R0000E004 |= (DATA << 3); // GPIO.WR

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 ); // GPIO.WR

	ndelay( DELAY * 100);
}

BYTE SA7160_GSPI_GET_SDOUT( CDevice * pDevice, ULONGLONG DELAY )
{
	ULONG R0000E000 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0000 ); R0000E000 >>= 4; // GPIO.RD

	ndelay( DELAY * 100);

	return (BYTE)(R0000E000 & 0x00000001);
}

BOOLEAN SA7160_GSPI_WRITE_WORD( CDevice * pDevice, USHORT wAddress, USHORT wValue, ULONGLONG DELAY )
{
	ULONG i;

	wAddress &= 0x0FFF;

	SA7160_GSPI_SET_SCLK( pDevice, 0, DELAY );

	SA7160_GSPI_SET_CS( pDevice, 1, DELAY );

	SA7160_GSPI_SET_CS( pDevice, 0, DELAY );

	for( i = 0 ; i < 16 ; i++ ) {

		BYTE DATA = (wAddress >> (15 - i)) & (0x01);

		SA7160_GSPI_SET_SDIN( pDevice, DATA, DELAY );

		SA7160_GSPI_SET_SCLK( pDevice, 1, DELAY );

		SA7160_GSPI_SET_SCLK( pDevice, 0, DELAY );
	}

	wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 1 ) );
	
	for( i = 0 ; i < 16 ; i++ ) {

		BYTE DATA = (wValue >> (15 - i)) & (0x01);

		SA7160_GSPI_SET_SDIN( pDevice, DATA, DELAY );

		SA7160_GSPI_SET_SCLK( pDevice, 1, DELAY );

		SA7160_GSPI_SET_SCLK( pDevice, 0, DELAY );
	}
	SA7160_GSPI_SET_SCLK( pDevice, 0, DELAY );

	SA7160_GSPI_SET_CS( pDevice, 1, DELAY );

	return TRUE;
}

USHORT SA7160_GSPI_READ_WORD( CDevice * pDevice, USHORT wAddress, ULONGLONG DELAY )
{
	ULONG i;

	USHORT wValue = 0x0000;

	wAddress &= 0x0FFF;

	wAddress |= 0x8000;

	SA7160_GSPI_SET_SCLK( pDevice, 0, DELAY );

	SA7160_GSPI_SET_CS( pDevice, 1, DELAY );

	SA7160_GSPI_SET_CS( pDevice, 0, DELAY );

	for( i = 0 ; i < 16 ; i++ ) {

		BYTE DATA = (wAddress >> (15 - i)) & (0x01);

		SA7160_GSPI_SET_SDIN( pDevice, DATA, DELAY );

		SA7160_GSPI_SET_SCLK( pDevice, 1, DELAY );

		SA7160_GSPI_SET_SCLK( pDevice, 0, DELAY );
	}

	wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 1 ) );

	for( i = 0 ; i < 16 ; i++ ) {

		USHORT DATA;

		SA7160_GSPI_SET_SCLK( pDevice, 1, DELAY );

		DATA = SA7160_GSPI_GET_SDOUT( pDevice, DELAY );

		wValue |= DATA << (15 - i);

		SA7160_GSPI_SET_SCLK( pDevice, 0, DELAY );
	}
	SA7160_GSPI_SET_SCLK( pDevice, 0, DELAY );

	SA7160_GSPI_SET_CS( pDevice, 1, DELAY );

	return wValue;
}

BOOL SA7160_HARDWARE_I2C_RESET( CDevice * pDevice )
{
	// I2C PROGRAMMING (m_pMunit_I2C) (m_pI2CLayer) [PATCH PROGRAM] [2011.01.28] [I2C.RESET]
	//
	ULONG i = 0;

	for( i = 0 ; i < 2 ; i++ ) {

		ULONG R0000B008 = 0x00000000;

		ULONG R0000B00C = 0x00000000;

		ULONG R0000BFE4 = 0x00000000;

		// -----> CI2CLayer_IP3204::Init()
		//
		ULONG j = 0;

		for( j = 0 ; j < 100 ; j++ ) {

			R0000B008 = SA7160_GetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0008 ); // I2C.STATUS

			if( (R0000B008 & 0x0F) == 0x0D ) {

				break;
			}
//			SA7160_POLLING_DELAY_100NS( pDevice, 100 );
			wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 1 ) );
		}
		if( (R0000B008 & 0x0F) != 0x0D ) { ; }

		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x000C, 0x000000CC ); // I2C.CONTROL

		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0FD8, 0x00001FFF ); // I2C.INT.CLR.ENABLE

		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0FE8, 0x00001FFF ); // I2C.INT.CLR.STATUS

		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x000C, 0x000000C1 ); // I2C.CONTROL

		for( j = 0 ; j < 100 ; j++ ) {

			R0000B00C = SA7160_GetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x000C ); // I2C.CONTROL

			if( R0000B00C == 0x000000C0 ) {

				break;
			}
//			SA7160_POLLING_DELAY_100NS( pDevice, 100 );
			wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 1 ) );
		}
		if( R0000B00C != 0x000000C0 ) { return TRUE; }

		R0000B008 = SA7160_GetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0008 ); // I2C.STATUS

		if( (R0000B008 & 0x00000008) == 0x00 ) {

			SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x000C, 0x000000C0 ); // CONTROL

//			SA7160_POLLING_DELAY_100NS( pDevice, 100 );
			wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 1 ) );

			for( j = 0 ; j < 9 ; j++ ) {

				SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x000C, 0x00000040 ); // CONTROL

//				SA7160_POLLING_DELAY_100NS( pDevice, 100 );
				wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 1 ) );

				SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x000C, 0x000000C0 ); // CONTROL

//				SA7160_POLLING_DELAY_100NS( pDevice, 100 );
				wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 1 ) );
			}
		}
		if( (pDevice->m_pKsDevice->subsystem_vendor & 0xFF) == 0x1C ) { // SWITCHING.CARD

		//	SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0010, 0x00000068 ); // CLOCK.DIVISOR.HIGH (100K)

		//	SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0014, 0x00000087 ); // CLOCK.DIVISOR.LOW (100K)

		//	SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0028, 0x00000060 ); // SDA.HOLD (100K)

			SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0010, 0x00000016 ); // CLOCK.DIVISOR.HIGH (400K)

			SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0014, 0x0000001E ); // CLOCK.DIVISOR.LOW (400K)

			SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0028, 0x00000010 ); // SDA.HOLD (400K)
		}
		else {

	//		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0010, 0x000000AD ); // CLOCK.DIVISOR.HIGH (60K)

	//		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0014, 0x000000E1 ); // CLOCK.DIVISOR.LOW (60K)

	//		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0028, 0x000000A0 ); // SDA.HOLD (60K)

			SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0010, 0x00000104 ); // CLOCK.DIVISOR.HIGH (40K)

			SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0014, 0x00000151 ); // CLOCK.DIVISOR.LOW (40K)

			SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0028, 0x000000C0 ); // SDA.HOLD (40K)

			//SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0010, 0x00000068 ); // CLOCK.DIVISOR.HIGH (100K)

			//SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0014, 0x00000087 ); // CLOCK.DIVISOR.LOW (100K)

			//SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0028, 0x00000060 ); // SDA.HOLD (100K)

		}
		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0FD8, 0x00001FFF ); // INT.CLR.ENABLE

		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0FE8, 0x00001FFF ); // INT.CLR.STATUS

		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0FDC, 0x000000C7 ); // INT.SET.ENABLE

		R0000BFE4 = SA7160_GetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0FE4 ); // INT.ENABLE

		if( R0000BFE4 != 0x000000C7 ) { return TRUE; }

		R0000B008 = SA7160_GetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0008 ); // STATUS

		if( (R0000B008 & 0x0F) != 0x0D ) { return TRUE; }

		LINUXV4L2_DEBUG( KERN_INFO, "SA7160_HARDWARE_I2C_RESET( %d x I2C:%08X:%08X:%08X )\n", pDevice->m_nKsDeviceNumber, R0000B008, R0000B00C, R0000BFE4 );
	}
	return TRUE;
}

//custom fps
ULONGLONG SA7160_CALCULATE_FPS( CDevice * pDevice, ULONG fps )
{
	ULONG frames = 0;
	
	frames = pDevice->m_nCustomAnalogVideoFrameRateProperty;


	if( pDevice->m_nCustomAnalogVideoInterleavedProperty == 1 )
	{
		frames /= 2;
	}

	if(frames == 0)
	{
		frames = 1;
	}

	if(fps == 0)
	{
		fps = 1;
	}

	ULONGLONG R = 0x0000000000000000;

	ULONG counts = 0;

	ULONGLONG i = 0;

	for( i = 0 ; i < frames ; i++ ) {

		counts += fps;

		if( counts >= frames ) {

			counts -= frames;

			R = R | ((ULONGLONG)1 << i);
		}
	}

	//LINUXV4L2_DEBUG( KERN_INFO, "SA7160_CALCULATE_FPS() R(llx%llx) fps(%d) frames(%d)!!!!\n", R, fps, frames );

	return R;
}

BOOLEAN SA7160_IS_4K2K_ENABLED( CDevice * pDevice ) // +SC510N2.HDMI.4K2K
{
	if( pDevice->iManufacturer == 0x13 ) {

		SA7160_SYS_CFG * p_sys_cfg = (SA7160_SYS_CFG *)(pDevice->m_pCustomSystemConfigProperty);

		if( (p_sys_cfg->n_input_video_resolution_cx == 4096 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
			
			(p_sys_cfg->n_input_video_resolution_cx >= 3840 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
			
			(p_sys_cfg->n_input_video_resolution_cx >= 2800 && p_sys_cfg->n_input_video_resolution_cy == 2100 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 120) ) {

			//LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_IS_4K2K_ENABLED() 0x13 true\n", pDevice->m_nKsDeviceNumber );

			return TRUE;
		}
	}
	if( pDevice->iManufacturer == 0x18 ) {

		if( pDevice->m_nKsDeviceNumber > 1 ) {

			CDevice * p_brother_device = g_pDevice[ pDevice->m_nKsDeviceNumber - 2 ];

			if( p_brother_device ) {
				
				if( p_brother_device->iManufacturer == 0x13 ) {

					SA7160_SYS_CFG * p_brother_sys_cfg = (SA7160_SYS_CFG *)(p_brother_device->m_pCustomSystemConfigProperty);

					if( (p_brother_sys_cfg->n_input_video_resolution_cx == 4096 && p_brother_sys_cfg->n_input_video_resolution_cy == 2160 && p_brother_sys_cfg->n_input_video_resolution_fps >    0) ||
						
						(p_brother_sys_cfg->n_input_video_resolution_cx >= 3840 && p_brother_sys_cfg->n_input_video_resolution_cy == 2160 && p_brother_sys_cfg->n_input_video_resolution_fps >    0) ||
						
						(p_brother_sys_cfg->n_input_video_resolution_cx >= 2800 && p_brother_sys_cfg->n_input_video_resolution_cy == 2100 && p_brother_sys_cfg->n_input_video_resolution_fps >    0) ||

						(p_brother_sys_cfg->n_input_video_resolution_cx == 1920 && p_brother_sys_cfg->n_input_video_resolution_cy == 1080 && p_brother_sys_cfg->n_input_video_resolution_fps == 120) ) {

						//LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_IS_4K2K_ENABLED() 0x18 true\n", pDevice->m_nKsDeviceNumber );
						return TRUE;
					}
				}
			}
		}
	}
	//LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_IS_4K2K_ENABLED() iManufacturer(0x%x) false\n", pDevice->m_nKsDeviceNumber, pDevice->iManufacturer );

	return FALSE;
}

BOOL SA7160_GV7601_HwInitialize( CDevice * pDevice ) 
{
	LINUXV4L2_PRINT( KERN_INFO, "[%02d] SA7160_GV7601_HwInitialize()\n", (int)(pDevice->m_nKsDeviceNumber) );

	SA7160_SYS_CFG * p_sys_cfg = (SA7160_SYS_CFG *)(pDevice->m_pCustomSystemConfigProperty);

	ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
	
	if( (pDevice->iManufacturer == 0x01 && pDevice->iProduct == 0x07) ||
				
		(pDevice->iManufacturer == 0x10) ||
		
		(pDevice->iManufacturer == 0x12) ||
		
		(pDevice->iManufacturer == 0x14) ||

		(pDevice->iManufacturer == 0x1B) ) {

		R0000E004 |=  0x00020000; // BYPASS.MODE
	}
	else {
	
		R0000E004 &= ~0x00020000; // HDMI.SEL (0 = SDI / 1 = HDMI)
	}

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 |  0x00010000 ); wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(50) ); // GPIO.WR (HARDWARE.RESET)

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 & ~0x00010000 ); wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(50) ); // GPIO.WR (HARDWARE.RESET)

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 |  0x00010000 ); wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(50) ); // GPIO.WR (HARDWARE.RESET)

	if( (pDevice->iManufacturer == 0x01 && 
		
		 pDevice->iProduct      == 0x07) ) { SA7160_SetFpgaRegister( pDevice, 0x20, 0x01 ); } // PORT#01

	if( (pDevice->iManufacturer == 0x10) ) { SA7160_SetFpgaRegister( pDevice, 0x20, 0x01 ); } // PORT#01

	if( (pDevice->iManufacturer == 0x12) ) { SA7160_SetFpgaRegister( pDevice, 0x20, 0x00 ); } // PORT#00

	if( (pDevice->iManufacturer == 0x14) ) { SA7160_SetFpgaRegister( pDevice, 0x20, 0x00 ); } // PORT#00

	if( (pDevice->iManufacturer == 0x12) ) { SA7160_SetFpgaRegister( pDevice, 0x21, 0x01 ); } // BYPASS.MODE

	if( (pDevice->iManufacturer == 0x14) ) { SA7160_SetFpgaRegister( pDevice, 0x21, 0x01 ); } // BYPASS.MODE

	SA7160_GSPI_WRITE_WORD( pDevice, 0x0009, (11 << 10) | (4 << 5) | (3 << 0), 10 );
		
	p_sys_cfg->n_input_video_resolution_cx = 0;

	p_sys_cfg->n_input_video_resolution_cy = 0;

	p_sys_cfg->n_input_video_resolution_fps = 0;

	p_sys_cfg->n_input_video_resolution_fps_m = 0;

	p_sys_cfg->n_input_video_resolution_interleaved = 0;

	p_sys_cfg->n_input_video_resolution_vbi_lines = 0;

	p_sys_cfg->n_input_video_resolution_h_total = 0;

	p_sys_cfg->b_input_video_resolution_spliter_mode = FALSE;

	p_sys_cfg->b_input_video_resolution_external_sync = FALSE;

	p_sys_cfg->b_input_video_resolution_vga_period_us_counts = 0;

	p_sys_cfg->b_input_video_signal_changed = FALSE;

	p_sys_cfg->n_input_audio_sampling_frequency = 0;

	return TRUE;
}
BOOL SA7160_ITE6603_HwInitialize( CDevice * pDevice ) 
{
	LINUXV4L2_PRINT( KERN_INFO, "[%02d] SA7160_ITE6603_HwInitialize()\n", (int)(pDevice->m_nKsDeviceNumber) );

	SA7160_SYS_CFG * p_sys_cfg = (SA7160_SYS_CFG *)(pDevice->m_pCustomSystemConfigProperty);

	ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
	
	R0000E004 &= 0xFBFFFFFF; // HPD.CTRL

	R0000E004 &= 0xFFFFFFF3; // 

	R0000E004 |= 0x00000004; // BYPASS

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 |  0x00010000 ); wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(50) ); // GPIO.WR (HARDWARE.RESET)

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 & ~0x00010000 ); wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(50) ); // GPIO.WR (HARDWARE.RESET)

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 |  0x00010000 ); wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(50) ); // GPIO.WR (HARDWARE.RESET)

	if( pDevice->iManufacturer == 0x18 ) { SA7160_SetFpgaRegister( pDevice, 0x20, 0x00 ); } // PORT#00

	p_sys_cfg->n_input_video_resolution_cx = 0;

	p_sys_cfg->n_input_video_resolution_cy = 0;

	p_sys_cfg->n_input_video_resolution_fps = 0;

	p_sys_cfg->n_input_video_resolution_fps_m = 0;
	
	p_sys_cfg->n_input_video_resolution_interleaved = 0;

	p_sys_cfg->n_input_video_resolution_vbi_lines = 0;

	p_sys_cfg->n_input_video_resolution_h_total = 0;

	p_sys_cfg->b_input_video_resolution_spliter_mode = FALSE;

	p_sys_cfg->b_input_video_resolution_external_sync = FALSE;

	p_sys_cfg->b_input_video_resolution_vga_period_us_counts = 0;

	p_sys_cfg->b_input_video_signal_changed = FALSE;

	p_sys_cfg->n_input_audio_sampling_frequency = 0;

	InitCAT6023(pDevice);


	if( SA7160_IS_4K2K_ENABLED( pDevice ) ) {

		LINUXV4L2_PRINT( KERN_INFO, "[%02d] SA7160_ITE6603_HwInitialize() setting FPGA(ITE6603) for 4K2K\n", (int)(pDevice->m_nKsDeviceNumber) );

		ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
		
		R0000E004 &=  0xFBFFFFFF; // HPD.CTRL

		R0000E004 &=  0xFFFFFFF3; // 

	//	R0000E004 |=  0x00000004; // BYPASS

		R0000E004 &= ~0x00000004; // SPLIT

		SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 ); wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(50) ); // GPIO.WR (HARDWARE.RESET)

		SA7160_SetFpgaRegister( pDevice, 0x20, 0x01 ); // PORT#01

		SA7160_SetFpgaRegister( pDevice, 0x24, 0x01 );

		SA7160_SetFpgaRegister( pDevice, 0x25, 0x01 ); // EXTERNAL SYNC -> EMBEDDED SYNC
	}
	else
	{
		LINUXV4L2_PRINT( KERN_INFO, "[%02d] SA7160_ITE6603_HwInitialize() no 4K2K\n", (int)(pDevice->m_nKsDeviceNumber) );
	}

	return TRUE;
}

BOOL SA7160_ADV7619_HwInitialize( CDevice * pDevice ) 
{
	LINUXV4L2_PRINT( KERN_INFO, "[%02d] SA7160_ADV7619_HwInitialize() \n", (int)(pDevice->m_nKsDeviceNumber) );

	SA7160_SYS_CFG * p_sys_cfg = (SA7160_SYS_CFG *)(pDevice->m_pCustomSystemConfigProperty);

	ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
	
	R0000E004 &=  0xFBFFFFFF; // HPD.CTRL

	R0000E004 &=  0xFFFFFFF3; // 

//	R0000E004 |=  0x00000004; // BYPASS

	R0000E004 &= ~0x00000004; // SPLIT

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 |  0x00010000 ); wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(50) ); // GPIO.WR (HARDWARE.RESET)

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 & ~0x00010000 ); wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(50) ); // GPIO.WR (HARDWARE.RESET)

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 |  0x00010000 ); wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(50) ); // GPIO.WR (HARDWARE.RESET)

	SA7160_SetFpgaRegister( pDevice, 0x20, 0x00 ); // PORT#00

	p_sys_cfg->n_input_video_resolution_cx = 0;

	p_sys_cfg->n_input_video_resolution_cy = 0;

	p_sys_cfg->n_input_video_resolution_fps = 0;

	p_sys_cfg->n_input_video_resolution_fps_m = 0;
	
	p_sys_cfg->n_input_video_resolution_interleaved = 0;

	p_sys_cfg->n_input_video_resolution_vbi_lines = 0;

	p_sys_cfg->n_input_video_resolution_h_total = 0;

	p_sys_cfg->b_input_video_resolution_spliter_mode = FALSE;	

	p_sys_cfg->b_input_video_resolution_external_sync = FALSE;

	p_sys_cfg->b_input_video_resolution_vga_period_us_counts = 0;

	p_sys_cfg->b_input_video_signal_changed = FALSE;	

	p_sys_cfg->n_input_audio_sampling_frequency = 0;

	SA7160_SetADV7619Register( pDevice, 0x98, 0x1B, 0x01 );

	SA7160_SetADV7619Register( pDevice, 0x9A, 0xFF, 0x80 );

	wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(100) );

	SA7160_SetADV7619Register( pDevice, 0x9A, 0xF4, 0x80 );

	SA7160_SetADV7619Register( pDevice, 0x9A, 0xF5, 0x7C );
	
	SA7160_SetADV7619Register( pDevice, 0x9A, 0xF8, 0x4C );
	
	SA7160_SetADV7619Register( pDevice, 0x9A, 0xF9, 0x64 );
	
	SA7160_SetADV7619Register( pDevice, 0x9A, 0xFA, 0x6C );
	
	SA7160_SetADV7619Register( pDevice, 0x9A, 0xFB, 0x68 );
	
	SA7160_SetADV7619Register( pDevice, 0x9A, 0xFD, 0x44 );

	// 4K2K REGISTER TABLE
	// 
	/*
	{	SA7160_SetADV7619Register( pDevice, 0x68, 0xC0, 0x03 );
		SA7160_SetADV7619Register( pDevice, 0x9A, 0x01, 0x06 );
		SA7160_SetADV7619Register( pDevice, 0x9A, 0x02, 0xF2 );
		SA7160_SetADV7619Register( pDevice, 0x9A, 0x03, 0x94 );
		SA7160_SetADV7619Register( pDevice, 0x9A, 0x05, 0x28 );
		SA7160_SetADV7619Register( pDevice, 0x9A, 0x06, 0xA0 );
		SA7160_SetADV7619Register( pDevice, 0x9A, 0x0C, 0x42 );
		SA7160_SetADV7619Register( pDevice, 0x9A, 0x15, 0x80 );
		SA7160_SetADV7619Register( pDevice, 0x9A, 0x19, 0x83 );
		SA7160_SetADV7619Register( pDevice, 0x9A, 0x33, 0x40 );
		SA7160_SetADV7619Register( pDevice, 0x9A, 0xDD, 0xA0 );
		SA7160_SetADV7619Register( pDevice, 0x4C, 0xB5, 0x01 );
		SA7160_SetADV7619Register( pDevice, 0x4C, 0xC3, 0x80 );
		SA7160_SetADV7619Register( pDevice, 0x4C, 0xCF, 0x03 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x3E, 0x69 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x3F, 0x46 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x4E, 0x7E );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x4F, 0x42 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x02, 0x03 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x57, 0xA3 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x58, 0x07 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x83, 0xFC );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x84, 0x03 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x85, 0x10 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x86, 0x9B );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x89, 0x03 );
 		SA7160_SetADV7619Register( pDevice, 0x68, 0x9B, 0x03 );
	}
	*/
	//use non 4K2K setting otherwise FPGA will error, strange ??
	{	SA7160_SetADV7619Register( pDevice, 0x68, 0xC0, 0x03 );
		SA7160_SetADV7619Register( pDevice, 0x9A, 0x01, 0x06 );
		//SA7160_SetADV7619Register( pDevice, 0x9A, 0x02, 0xF2 );
		//SA7160_SetADV7619Register( pDevice, 0x9A, 0x03, 0x94 );
		//SA7160_SetADV7619Register( pDevice, 0x9A, 0x05, 0x28 );
		//SA7160_SetADV7619Register( pDevice, 0x9A, 0x06, 0xA0 );
		SA7160_SetADV7619Register( pDevice, 0x9A, 0x0C, 0x42 );
		SA7160_SetADV7619Register( pDevice, 0x9A, 0x15, 0x80 );
		SA7160_SetADV7619Register( pDevice, 0x9A, 0x19, 0x83 );
		SA7160_SetADV7619Register( pDevice, 0x9A, 0x33, 0x40 );
		//SA7160_SetADV7619Register( pDevice, 0x9A, 0xDD, 0xA0 );
		SA7160_SetADV7619Register( pDevice, 0x4C, 0xB5, 0x01 );
		//SA7160_SetADV7619Register( pDevice, 0x4C, 0xC3, 0x80 );
		//SA7160_SetADV7619Register( pDevice, 0x4C, 0xCF, 0x03 );

		SA7160_SetADV7619Register( pDevice, 0x9A, 0x02, 0xF5 ); //

		SA7160_SetADV7619Register( pDevice, 0x9A, 0x05, 0x2C ); // EMBEDDED SYNC

		SA7160_SetADV7619Register( pDevice, 0x9A, 0x06, 0xA6 ); //

		SA7160_SetADV7619Register( pDevice, 0x9A, 0x03, 0x80 );
									
		SA7160_SetADV7619Register( pDevice, 0x4C, 0xC3, 0x00 );
									
		SA7160_SetADV7619Register( pDevice, 0x4C, 0xCF, 0x00 );
									
		SA7160_SetADV7619Register( pDevice, 0x9A, 0xDD, 0x00 );

		SA7160_SetADV7619Register( pDevice, 0x68, 0x3E, 0x69 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x3F, 0x46 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x4E, 0x7E );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x4F, 0x42 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x02, 0x03 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x57, 0xA3 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x58, 0x07 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x83, 0xFC );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x84, 0x03 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x85, 0x10 );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x86, 0x9B );
		SA7160_SetADV7619Register( pDevice, 0x68, 0x89, 0x03 );
 		SA7160_SetADV7619Register( pDevice, 0x68, 0x9B, 0x03 );
	}


	return TRUE;
}

BOOL SA7160_TW9910_HwInitialize( CDevice * pDevice ) 
{

	if( (pDevice->iManufacturer == 0x10 && pDevice->iProduct == 0xE5 ) ||  // NINTENDO SC510N1.1ST
		
		(pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST
				
		(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST

		(pDevice->iManufacturer == 0x17)  ) { // SC512N1.DVI.1ST

		if( pDevice->m_nAnalogCrossbarVideoInputProperty == 5 ||  // COMPOSITE

			pDevice->m_nAnalogCrossbarVideoInputProperty == 6 ) { // SVIDEO

			LINUXV4L2_PRINT( KERN_INFO, "[%02d] SA7160_TW9910_HwInitialize()\n", (int)(pDevice->m_nKsDeviceNumber) );

			ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
			
			R0000E004 &= 0xFFFFFFBF; 

			SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 ); wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(50) ); // GPIO.WR (HARDWARE.RESET)

			R0000E004 |= 0x00000040; // GPIO06 HIGH TW9910 HIGH ACTIVE

			R0000E004 |= 0x00020000; // GPIO17 HIGH BYPASS MODE

			R0000E004 &= 0xFFFFFFDF; // GPIO05 LOW AUDIO LINE IN 

			SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 ); wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(50) ); // GPIO.WR (HARDWARE.RESET)

			SA7160_SetFpgaRegister( pDevice, 0x20, 0x01 ); // SET OUTPUT INTERSECTED

			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x06, 0x00 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x03, 0xA2 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x05, 0x01 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x08, 0x14 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x09, 0xF2 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0A, 0x0B );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0B, 0xD2 );
		//	SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x19, 0x57 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x19, 0xDE );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1A, 0x0F );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1B, 0x00 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x28, 0x0E );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x29, 0x03 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x2D, 0x07 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x2F, 0x06 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x4C, 0x0D );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x55, 0x00 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x6B, 0x26 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x6C, 0x36 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x6D, 0xF0 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x6E, 0x28 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x06, 0x80 );
			
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x6F, 0x98 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x64, 0x55 );
			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x06, 0x80 );

			SA7160_SYS_CFG * p_sys_cfg = (SA7160_SYS_CFG *)(pDevice->m_pCustomSystemConfigProperty);

			p_sys_cfg->n_input_video_resolution_cx = 0;

			p_sys_cfg->n_input_video_resolution_cy = 0;

			p_sys_cfg->n_input_video_resolution_fps = 0;

			p_sys_cfg->n_input_video_resolution_fps_m = 0;

			p_sys_cfg->n_input_video_resolution_interleaved = 0;

			p_sys_cfg->n_input_video_resolution_vbi_lines = 0;

			p_sys_cfg->n_input_video_resolution_h_total = 0;

			p_sys_cfg->b_input_video_resolution_spliter_mode = FALSE;

			p_sys_cfg->b_input_video_resolution_external_sync = FALSE;

			p_sys_cfg->b_input_video_resolution_vga_period_us_counts = 0;	

			p_sys_cfg->b_input_video_signal_changed = FALSE;

			p_sys_cfg->n_input_audio_sampling_frequency = 0;

			SA7160_SetAnalogVideoDecoderStandardProperty( pDevice, pDevice->m_nCustomVideoStandardProperty );
		}
	}
 	return TRUE;
}
extern void MST3367_ADJUST_CSC_TABLE( CDevice * pDevice, BYTE bright, BYTE contrast, BYTE saturation, BYTE hue, BYTE sharpness );


BOOLEAN SA7160_SetAnalogVideoProcAmpProperties( CDevice * pDevice )
{
	if( pDevice->iManufacturer == 0x19 ) { // SC510N1.2ND

		;
	}
	else if( pDevice->iManufacturer == 0x0A ||

			 pDevice->iManufacturer == 0x0D ||

			 pDevice->iManufacturer == 0x18 ||

			 pDevice->iManufacturer == 0x1A ) {
		;
	}
	else if( (pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x01) ||
			   
			 (pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x04) ||
			   
			 (pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x06) ||
			   
			 (pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x07) ||
			   
			 (pDevice->iProduct == 0xF5 && pDevice->iManufacturer == 0x02) ||

			 (pDevice->iManufacturer == 0x08) ||
			   
			 (pDevice->iManufacturer == 0x12) ||
			   
			 (pDevice->iManufacturer == 0x13) ||
			   
			 (pDevice->iManufacturer == 0x14) ||

			 (pDevice->iManufacturer == 0x1B) ||
			   
			 (pDevice->iManufacturer == 0x1C) ) {
		;
	}
	else {

		if( pDevice->m_nAnalogCrossbarVideoInputProperty == 5 ||  // COMPOSITE
			
			pDevice->m_nAnalogCrossbarVideoInputProperty == 6 ) { // SVIDEO

			if( (pDevice->iManufacturer == 0x10 && pDevice->iProduct == 0xE5) || // NINTENDO SC510N1.1ST
				
				(pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST
				
				(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST
		
				(pDevice->iManufacturer == 0x17) ) { // SC512N1.DVI.1ST

				//if( bByThread == FALSE ) { SA7160_CLOSE_THREAD(); }
				SA7160_StopControlPanelAnalysisThread( pDevice );

				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x10, (BYTE)(((g_n_analog_decoder_brightness[ pDevice->m_nKsDeviceNumber * 1 ][ 0 ] & 0xFF) >> 0) - 128 - 19) | 0x00 );
				
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x11, (BYTE)(((g_n_analog_decoder_contrast[ pDevice->m_nKsDeviceNumber * 1 ][ 0 ]   & 0xFF) >> 0) -        7) | 0x00 );
				
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x13, (BYTE)(((g_n_analog_decoder_saturation[ pDevice->m_nKsDeviceNumber * 1 ][ 0 ] & 0xFF) >> 0) -        0) | 0x00 );
				
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x14, (BYTE)(((g_n_analog_decoder_saturation[ pDevice->m_nKsDeviceNumber * 1 ][ 0 ] & 0xFF) >> 0) -        0) | 0x00 );
				
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x15, (BYTE)(((g_n_analog_decoder_hue[ pDevice->m_nKsDeviceNumber * 1 ][ 0 ]        & 0xFF) >> 0) -      128) | 0x00 );
				
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x12, (BYTE)(((g_n_analog_decoder_sharpness[ pDevice->m_nKsDeviceNumber * 1 ][ 0 ]  & 0xFF) >> 4) -        0) | 0x50 ); 

				//if( bByThread == FALSE ) { SA7160_START_THREAD(); }
				SA7160_StartControlPanelAnalysisThread( pDevice );
			}
		}
		else if( pDevice->m_nAnalogCrossbarVideoInputProperty == 4 ) { // SDI

			;
		}
		else {

			//if( bByThread == FALSE ) { SA7160_CLOSE_THREAD(); }
			SA7160_StopControlPanelAnalysisThread( pDevice );

			MST3367_ADJUST_CSC_TABLE( pDevice, (BYTE)(g_n_analog_decoder_brightness[ pDevice->m_nKsDeviceNumber * 1 ][ 0 ] & 0xFF), 
				
											   (BYTE)(g_n_analog_decoder_contrast[ pDevice->m_nKsDeviceNumber * 1 ][ 0 ] & 0xFF), 
											   
											   (BYTE)(g_n_analog_decoder_saturation[ pDevice->m_nKsDeviceNumber * 1 ][ 0 ] & 0xFF), 
											   
											   (BYTE)(g_n_analog_decoder_hue[ pDevice->m_nKsDeviceNumber * 1 ][ 0 ]  & 0xFF), 
												   
											  ((BYTE)(g_n_analog_decoder_sharpness[ pDevice->m_nKsDeviceNumber * 1 ][ 0 ] & 0xFF) >> 5) );

			//if( bByThread == FALSE ) { SA7160_START_THREAD(); }
			SA7160_StartControlPanelAnalysisThread( pDevice );
		}
	}

	return TRUE;
}


BOOLEAN SA7160_SetAnalogCrossbarRouteProperty( CDevice * pDevice )
{
//	SA7160_CLOSE_THREAD();
	SA7160_StopControlPanelAnalysisThread( pDevice );

	if( pDevice->m_nAnalogCrossbarVideoInputProperty != -1 ) {

		if( pDevice->iManufacturer == 0x19 ) { // SC510N1.2ND

			;
		}
		else if( pDevice->iManufacturer == 0x0A ||

				 pDevice->iManufacturer == 0x0D ||

				 pDevice->iManufacturer == 0x18 ||

				 pDevice->iManufacturer == 0x1A ) {
			//signal lock take too much time, depend on sa71600hw_int
			//SA7160_ITE6603_HwInitialize( pDevice );
		}
		else if( pDevice->iManufacturer == 0x13 ) { // SC510N2.HDMI.4K2K.ADV7619
			
			SA7160_ADV7619_HwInitialize( pDevice );
		}
		else if( (pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x01) ||
				   
				 (pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x04) ||
				   
				 (pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x06) ||
				   
				 (pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x07) ||
				   
				 (pDevice->iProduct == 0xF5 && pDevice->iManufacturer == 0x02) ||
				   
				 (pDevice->iManufacturer == 0x08) ||
				   
				 (pDevice->iManufacturer == 0x12) ||

				 (pDevice->iManufacturer == 0x14) ||

				 (pDevice->iManufacturer == 0x1B) ||
				   
				 (pDevice->iManufacturer == 0x1C) ) {

			SA7160_GV7601_HwInitialize( pDevice );
		}
		else {

			if( pDevice->m_nAnalogCrossbarVideoInputProperty == 5 ) { // COMPOSITE

				SA7160_TW9910_HwInitialize( pDevice );

				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x02, 0x0040 );

				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x06, 0x0042 );
			}
			else if( pDevice->m_nAnalogCrossbarVideoInputProperty == 6 ) { // SVIDEO

				SA7160_TW9910_HwInitialize( pDevice );

				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x02, 0x0054 );

				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x06, 0x0040 );
			}
			else if( pDevice->m_nAnalogCrossbarVideoInputProperty == 4 ) {

				SA7160_GV7601_HwInitialize( pDevice );
			}
			else {

				MST3367_HwInitialize( pDevice );
			}
		}
	}

	if( pDevice->m_nAnalogCrossbarAudioInputProperty != -1 ) {

		if( pDevice->iManufacturer != 0x09 ) { // SC502N1.MC.ADV7181

			ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 );
	
			if( pDevice->m_nAnalogCrossbarVideoInputProperty == 0 ||  // HDMI (TMDS.B)
	
				pDevice->m_nAnalogCrossbarVideoInputProperty == 1 ||  // DVI.DIGITAL (TMDS.A)
	
				pDevice->m_nAnalogCrossbarVideoInputProperty == 4 ) { // SDI
	
				if( pDevice->m_nAnalogCrossbarAudioInputProperty == 0 ) {
	
					R0000E004 |=  (1 << 5); // I2S.SEL = 1
				}
				if( pDevice->m_nAnalogCrossbarAudioInputProperty == 1 ) {
	
					R0000E004 &= ~(1 << 5); // I2S.SEL = 0

					R0000E004 |=  (1 << 3); // CLK.SEL1 = HIGH, USE CLOCK FROM OSC
				}
			}
			if( pDevice->m_nAnalogCrossbarVideoInputProperty == 2 ||  // COMPONENT
	
				pDevice->m_nAnalogCrossbarVideoInputProperty == 3 ||  // DVI.ANALOG
	
				pDevice->m_nAnalogCrossbarVideoInputProperty == 5 ||  // COMPOSITE
	
				pDevice->m_nAnalogCrossbarVideoInputProperty == 6 ) { // SVIDEO
	
				R0000E004 &= ~(1 << 5); // I2S.SEL = 0
	
				R0000E004 |= (1 << 3); // CLK.SEL1 = HIGH, USE CLOCK FROM OSC
			}
			SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );
		}

		if( (pDevice->iManufacturer == 0x10 && pDevice->iProduct == 0xE5) || // NINTENDO SC510N1.1ST
			
			(pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST
				
			(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST
		
			(pDevice->iManufacturer == 0x12) ||  // SC512N1.SDI.1ST

			(pDevice->iManufacturer == 0x14) ||  // SC512N1.SDI.1ST

			(pDevice->iManufacturer == 0x16) ||  // SC512N1.DVI.1ST

			(pDevice->iManufacturer == 0x17) ) { // SC512N1.DVI.1ST

			static BYTE CS53L21_REG_TABLE[ ] = { 0x03, 0x4E,
												 0x04, 0x44,
												 0x07, 0x00,
												 0x0A, 0x00,
												 0x0B, 0x00,
												 0x0C, 0x00,
												 0x0D, 0x00,
												 0x1C, 0xC0,
												 0x04, 0x46,
												 0x09, 0x42,
												 0x0E, 0x05, // DEFAULT = 0x18
												 0x0F, 0x05, // DEFAULT = 0x18
												 0x18, 0x00,
												 0xFF, 0xFF 
			};
			if( pDevice->iManufacturer == 0x12 ||
				
				pDevice->iManufacturer == 0x14 ) {
			}
			else {

				if( pDevice->m_nAnalogCrossbarVideoInputProperty == 5 ||  // COMPOSITE

					pDevice->m_nAnalogCrossbarVideoInputProperty == 6 ) { // SVIDEO

					if( (pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST
				
						(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST
		
						(pDevice->iManufacturer == 0x16) ||
						
						(pDevice->iManufacturer == 0x17) ) {

						CS53L21_REG_TABLE[ 5 ] = 0x00;
					}
					else {

						CS53L21_REG_TABLE[ 5 ] = 0x50;
					}
				}
				else {

					ULONG B0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
					
					B0000E004 &= 0xFFFFFFBF; 

					SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, B0000E004  );  wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 50 ) ); // GPIO.WR (HARDWARE.RESET)

					B0000E004 |= 0x00000040; // GPIO06 HIGH TW9910 HIGH ACTIVE (TURN ON AUDIO DECODER)

					SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, B0000E004  ); wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 50 ) ); // GPIO.WR (HARDWARE.RESET)

					CS53L21_REG_TABLE[ 5 ] = 0x00;
				}
			}
			ULONG i = 0;
			for( i = 0 ; i < sizeof(CS53L21_REG_TABLE) ; i += 2 ) { 
				
				SA7160_SetAnalogAudioDecoderRegister( pDevice, CS53L21_REG_TABLE[ i ], CS53L21_REG_TABLE[ i + 1 ] ); 
			}
		}
	}
//	SA7160_START_THREAD();
	SA7160_StartControlPanelAnalysisThread( pDevice );

	//In SA7160_TW9910_HwInitialize
	/*
	if( pDevice->m_nAnalogCrossbarVideoInputProperty != -1 ) {
		
		if( pDevice->m_nAnalogCrossbarVideoInputProperty == 5 ||  // COMPOSITE

			pDevice->m_nAnalogCrossbarVideoInputProperty == 6 ) { // SVIDEO
		
			SA7160_SetAnalogVideoDecoderStandardProperty( pDevice, pDevice->m_nCustomVideoStandardProperty );
		}
	}
	*/


	return TRUE;
}
BOOLEAN SA7160_SetAnalogVideoDecoderStandardProperty( CDevice * pDevice, ULONG nStandard )

{

	if( (pDevice->iManufacturer == 0x10 && pDevice->iProduct == 0xE5 ) ||  // NINTENDO SC510N1.1ST
		
		(pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST
				
		(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST

		(pDevice->iManufacturer == 0x17) ) { // SC512N1.DVI.1ST
	 
		
		if( pDevice->m_nAnalogCrossbarVideoInputProperty == 5 ||  // COMPOSITE

			pDevice->m_nAnalogCrossbarVideoInputProperty == 6 ) { // SVIDEO

			LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_TW9910 set standard(0x%x)\n", (int)(pDevice->m_nKsDeviceNumber), nStandard );

			//SA7160_CLOSE_THREAD();
			//already stop
			//SA7160_StopControlPanelAnalysisThread( pDevice ); //cause modprobe -r hang

			SA7160_SYS_CFG * p_sys_cfg = (SA7160_SYS_CFG *)(pDevice->m_pCustomSystemConfigProperty);

			BYTE R0C = (BYTE)(SA7160_GetAnalogVideoDecoderRegister( pDevice, 0x0C )) & 0xEF;

			switch( nStandard ) {
			
			case V4L2_STD_NTSC_M:      SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x00 );  break;
			case V4L2_STD_NTSC_M_JP:    SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x00 );  break;
			case V4L2_STD_NTSC_443:    SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x03 );  break;
			case V4L2_STD_PAL_60:      SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x07 );  break;
			case V4L2_STD_PAL_M:       SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x04 );  break;
			case V4L2_STD_PAL_B:       SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x01 );  break;
			case V4L2_STD_PAL_D:       SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x01 );  break;
			case V4L2_STD_PAL_G:       SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x01 );  break;
			case V4L2_STD_PAL_H:       SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x01 );  break;
			case V4L2_STD_PAL_I:       SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x01 );  break;
			case V4L2_STD_PAL_N:       SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x05 );  break;
			case V4L2_STD_PAL_Nc:	   SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x02 );  break;
			case V4L2_STD_SECAM_B:     SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x02 );  break;
			case V4L2_STD_SECAM_G:     SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x02 );  break;
			case V4L2_STD_SECAM_H:     SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x02 );  break;
			case V4L2_STD_SECAM_D:     SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x02 );  break;
			case V4L2_STD_SECAM_K:     SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x02 );  break;
			case V4L2_STD_SECAM_K1:    SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x02 );  break;
			case V4L2_STD_SECAM_L:     SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x02 );  break;
			case V4L2_STD_SECAM_LC:    SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x1C, 0x02 );  break;
			}
			switch( nStandard ) {
			
			case V4L2_STD_NTSC_M:      SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x10 );  break;
			case V4L2_STD_NTSC_M_JP:    SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x00 );  break;
			case V4L2_STD_NTSC_443:    SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x10 );  break;
			case V4L2_STD_PAL_60:      SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x00 );  break;
			case V4L2_STD_PAL_M:       SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x10 );  break;
			case V4L2_STD_PAL_B:       SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x00 );  break;
			case V4L2_STD_PAL_D:       SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x00 );  break;
			case V4L2_STD_PAL_G:       SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x00 );  break;
			case V4L2_STD_PAL_H:       SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x00 );  break;
			case V4L2_STD_PAL_I:       SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x00 );  break;
			case V4L2_STD_PAL_N:       SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x10 );  break;
			case V4L2_STD_PAL_Nc: SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x00 );  break;
			case V4L2_STD_SECAM_B:     SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x00 );  break;
			case V4L2_STD_SECAM_G:     SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x00 );  break;
			case V4L2_STD_SECAM_H:     SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x00 );  break;
			case V4L2_STD_SECAM_D:     SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x00 );  break;
			case V4L2_STD_SECAM_K:     SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x00 );  break;
			case V4L2_STD_SECAM_K1:    SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x00 );  break;
			case V4L2_STD_SECAM_L:     SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x00 );  break;
			case V4L2_STD_SECAM_LC:    SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0C, R0C | 0x00 );  break;
			}
			if( nStandard & V4L2_STD_525_60 ) {

				LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_TW9910 set NTSC\n", (int)(pDevice->m_nKsDeviceNumber) );

				BYTE R07 = (BYTE)(SA7160_GetAnalogVideoDecoderRegister( pDevice, 0x07 )) & 0x0F;
				
				BYTE R55 = (BYTE)(SA7160_GetAnalogVideoDecoderRegister( pDevice, 0x55 )) & 0xEF;

				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x07, 0x00 | R07 );
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x08, 0x14       );
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x09, 0xF2       );
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0A, 0x0B       );
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0B, 0xD2       );
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x55, 0x10 | R55 );
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0D, 0x00       );
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0E, 0x11       );
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0F, 0x00       );

				p_sys_cfg->n_input_video_resolution_cx = 720;

				p_sys_cfg->n_input_video_resolution_cy = 240;

				p_sys_cfg->n_input_video_resolution_fps = 60;

				p_sys_cfg->n_input_video_resolution_fps_m = 1;

				p_sys_cfg->n_input_video_resolution_interleaved = 1;

				p_sys_cfg->b_input_video_signal_changed = TRUE;

				p_sys_cfg->n_input_audio_sampling_frequency = 48000;

				pDevice->m_nCustomAnalogVideoResolutionProperty = (p_sys_cfg->n_input_video_resolution_cx << 16) | 

																  (p_sys_cfg->n_input_video_resolution_cy <<  0);

				pDevice->m_nCustomAnalogVideoFrameRateProperty = (p_sys_cfg->n_input_video_resolution_fps);

				pDevice->m_nCustomAnalogVideoInterleavedProperty = (p_sys_cfg->n_input_video_resolution_interleaved);

				pDevice->m_nCustomAnalogAudioSampleFrequencyProperty = 48000;
			}
			
//			if( pDevice->m_nAnalogVideoDecoderStandardProperty & SUPPORTED_ANALOG_VIDEO_STANDARDS_50HZ ) {

			if( nStandard & V4L2_STD_625_50 ) {

				LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_TW9910 set PAL\n", (int)(pDevice->m_nKsDeviceNumber) );

				BYTE R07 = (BYTE)(SA7160_GetAnalogVideoDecoderRegister( pDevice, 0x07 )) & 0x0F;
				
				BYTE R55 = (BYTE)(SA7160_GetAnalogVideoDecoderRegister( pDevice, 0x55 )) & 0xEF;

				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x07, 0x10 | R07 );
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x08, 0x19 +   0 );
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x09, 0x20       );
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0A, 0x0A       );
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0B, 0xD2       );
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x55, 0x00 | R55 );
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0D, 0x00       );
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0E, 0x11       );
				SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x0F, 0x00       );	

				p_sys_cfg->n_input_video_resolution_cx = 720;

				p_sys_cfg->n_input_video_resolution_cy = 288;

				p_sys_cfg->n_input_video_resolution_fps = 50;

				p_sys_cfg->n_input_video_resolution_fps_m = 1;

				p_sys_cfg->n_input_video_resolution_interleaved = 1;

				p_sys_cfg->b_input_video_signal_changed = TRUE;

				p_sys_cfg->n_input_audio_sampling_frequency = 48000;

				pDevice->m_nCustomAnalogVideoResolutionProperty = (p_sys_cfg->n_input_video_resolution_cx << 16) | 

																  (p_sys_cfg->n_input_video_resolution_cy <<  0);

				pDevice->m_nCustomAnalogVideoFrameRateProperty = (p_sys_cfg->n_input_video_resolution_fps);

				pDevice->m_nCustomAnalogVideoInterleavedProperty = (p_sys_cfg->n_input_video_resolution_interleaved);

				pDevice->m_nCustomAnalogAudioSampleFrequencyProperty = 48000;
			}
			//SA7160_START_THREAD();
			
			//SA7160_StartControlPanelAnalysisThread( pDevice );
		}
		else
		{
			LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_TW9910 set standard error, m_nAnalogCrossbarVideoInputProperty(0x%x)\n", (int)(pDevice->m_nKsDeviceNumber), pDevice->m_nAnalogCrossbarVideoInputProperty );
		}
	}
	else
	{
		LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_TW9910 set standard ID error, iProduct(0x%x) iManufacturer(0x%x)\n", (int)(pDevice->m_nKsDeviceNumber), pDevice->iProduct, pDevice->iManufacturer );
	}

	return TRUE;
}

#if LINUX_VERSION_CODE >= KERNEL_VERSION(2,6,39)
//typedef u64 dma64_addr_t;
#endif

BOOLEAN SA7160_HwAnalogComponentsInitialize( CDevice * pDevice, SA7160_SYS_CFG * p_brother_sys_cfg, BOOL is_ite_table)
{
	LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsInitialize() iManufacturer(0x%x) p_brother_sys_cfg(0x%x)\n",(int)(pDevice->m_nKsDeviceNumber) , pDevice->iManufacturer, p_brother_sys_cfg);	

	if( p_brother_sys_cfg == NULL ) {

		if( (pDevice->iManufacturer == 0x1A && pDevice->m_nCustomGpioSupportProperty == 0) ) { // +SC510N4

			if( pDevice->m_nKsDeviceNumber > 0 ) {

				CDevice * p_brother_device = g_pDevice[ pDevice->m_nKsDeviceNumber - 1 ];

				if( p_brother_device ) {
					
					ULONG R0000E004 = SA7160_GetRegister( p_brother_device, 0x0000E000 + 0x0004 ); // GPIO.WR
								
					if( (R0000E004 & 0x00000004) == 0x00000000 ) { // SPLITER.MODE

						return FALSE; //return while split mode
					}
				}
			}
		}
		if( (pDevice->iManufacturer == 0x1B && pDevice->m_nCustomGpioSupportProperty == 0) ) { // +SC510N4

			if( pDevice->m_nKsDeviceNumber > 0 ) {

				CDevice * p_brother_device = g_pDevice[ pDevice->m_nKsDeviceNumber - 1 ];

				if( p_brother_device ) {
					
					ULONG R0000E004 = SA7160_GetRegister( p_brother_device, 0x0000E000 + 0x0004 ); // GPIO.WR
							
					if( (R0000E004 & 0x00020000) == 0x00000000 ) { // SPLITER.MODE

						return FALSE;
					}
				}
			}
		}
		if( pDevice->iManufacturer == 0x18 ) {

			if( SA7160_IS_4K2K_ENABLED( pDevice ) ) {
				
				return FALSE;
			}
		}
	}

	if( p_brother_sys_cfg == NULL )
	{
		if( pDevice->m_nAnalogCaptureStreamPowerReference == 0 ) {
	
			pDevice->m_nAnalogCaptureStreamPowerReference++;
		}
		else { 
	
			pDevice->m_nAnalogCaptureStreamPowerReference++;

			return TRUE;
		}
	}	
	

	LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsInitialize() iManufacturer(0x%x) m_nAnalogCaptureStreamPowerReference(0d%d)\n",(int)(pDevice->m_nKsDeviceNumber) , pDevice->iManufacturer, pDevice->m_nAnalogCaptureStreamPowerReference);	

	pDevice->m_nDmaBaseCommonBufferNumber[ 0 ] = 0;

	pDevice->m_nDmaBaseCommonBufferCustomMiscProperty[ 0 ] = 0;


	//CLEAR DMA BUFFER
	int index = 0;
	for( index = 0; index < SA7160_MAX_BUFFER; index++ )
	{
		if(pDevice->m_SA7160_video_buffer[ index ])
		{
			memset( (UINT*)pDevice->m_SA7160_video_buffer[ index ], 0x00, 1920 * 1080 * 2);
		}
	}

	// CLEAR VIDEO DMA INSTRUCTION TABLE
	//
	{	ULONG j = 0;

		dma_addr_t physical_address_dummy = pDevice->m_pDmaBaseCommonPhysicalBuffer[ 0 ];

		UINT * pe = (UINT *)(pDevice->m_pDmaBaseCommonBuffer[ 0 ]);

		physical_address_dummy += 4096 * 2 * 8;

		for( j = 0 ; j < 8192 ; j++ ) {

		   *pe++ = physical_address_dummy & 0xFFFFF000;

		   *pe++ = 0;
		}
	}
	// CLEAR AUDIO DMA INSTRUCTION TABLE
	//
	{	ULONG j = 0;
		
		dma_addr_t physical_address_dummy = pDevice->m_pDmaBaseCommonPhysicalBuffer[ 1 ];

		UINT * pe = (UINT *)(pDevice->m_pDmaBaseCommonBuffer[ 1 ] );

//		physical_address_dummy += SA7160_MAX_VIDEO_DMA_BUFFER_SIZE;

		physical_address_dummy += 4096 * 1 * 8;

		for( j = 0 ; j < 4096 ; j++ ) {

		   *pe++ = physical_address_dummy & 0xFFFFF000;

		   *pe++ = 0;
		}
	}

#ifdef SA7160_COPYPORTECT_ARCHITECTURE

	if( g_copy_protect_unlock_boradsA[ pDevice->m_nKsDeviceBusNumber ] == 0 ) { return TRUE; }

	if( g_copy_protect_unlock_boradsB[ pDevice->m_nKsDeviceBusNumber ] == 0 ) { return TRUE; }

#endif

	// -----> tmHWStreamPort_VIP_Video::tmIAcquire() -----> tmHWStreamPort_VIP_Video::tmISetParameters()
	// 
	// BAM PROGRAMMING (m_pMunit_BAM)
	// 
	SA7160_SetRegister( pDevice, 0x00008000 + 0x0000, 0x00000040 ); // BAM.DMA.BUF.MODE

	// VIP PROGRAMMING (m_pMunit_VIP) (m_pVIP_Lite)
	// 
	ULONG R00000FFC = SA7160_GetRegister( pDevice, 0x00000000 + 0x0FFC ); // VIP.MODULE.ID

	if( R00000FFC != 0x011A5100 ) {

		;
	}
	LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsInitialize( VIP:%08lX )\n", pDevice->m_nKsDeviceNumber, R00000FFC );

	SA7160_SetRegister( pDevice, 0x00000000 + 0x0FF4, 0x00000000 ); // VIP.POWER.DOWN
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0020, 0x00000000 ); // VIP.ANC.DID.FIELD0
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0024, 0x00000000 ); // VIP.ANC.DID.FIELD1
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0040, 0x00000000 ); // VIP.LINE.THR
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0160, 0x00000000 ); // VIP.PRE.DIT.CTRL
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0164, 0x00000000 ); // VIP.POST.DIT.CTRL
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0284, 0x00000000 ); // VIP.CSM.CKEY
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0140, 0x03380001 ); // VIP.WIN.XYSTART
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0144, 0x0AB80439 ); // VIP.WIN.XYEND
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0304, 0x07800438 ); // VIP.PSU.WINDOW (1920 × 1080)
//	SA7160_SetRegister( pDevice, 0x00000000 + 0x0300, 0x000020A0 ); // VIP.PSU.FORMAT (SAA1997)
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0300, 0x000020A1 ); // VIP.PSU.FORMAT (MST3367)
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0100, 0x01004201 ); // VIP.VIN.FORMAT
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0340, 0x00000000 ); // VIP.PSU.BASE1
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0344, 0x00000F00 ); // VIP.PSU.PITCH1
	SA7160_SetRegister( pDevice, 0x00000000 + 0x034C, 0x00000000 ); // VIP.PSU.PITCH2
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0348, 0x00000000 ); // VIP.PSU.BASE2
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0350, 0x00000000 ); // VIP.PSU.BASE3
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0354, 0x00000000 ); // VIP.PSU.BASE4
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0358, 0x00000000 ); // VIP.PSU.BASE5
	SA7160_SetRegister( pDevice, 0x00000000 + 0x035C, 0x00000000 ); // VIP.PSU.BASE6

		// RESOLUTION TABLE SETTING
		//
	{//	SA7160_CLOSE_THREAD();
		SA7160_StopControlPanelAnalysisThread( pDevice );

		SA7160_SYS_CFG * p_sys_cfg = (p_brother_sys_cfg) ? (p_brother_sys_cfg) : (SA7160_SYS_CFG *)(pDevice->m_pCustomSystemConfigProperty);

	//	ULONG j = -1;

		ULONG j = 0;

		ULONG cx = p_sys_cfg->n_input_video_resolution_cx;

		ULONG cy = p_sys_cfg->n_input_video_resolution_cy;

		ULONG fps = p_sys_cfg->n_input_video_resolution_fps;

		ULONG interleaved = p_sys_cfg->n_input_video_resolution_interleaved;

		ULONG h_total = p_sys_cfg->n_input_video_resolution_h_total;

		if( cx == 0 || cy == 0 ) {

			cx = 720;

			cy = 240;

			fps = 60;

			interleaved = 1;

			h_total = 0;
		}
		if( cx ==  720 && cy ==  240 && fps == 60 ) { j =  0; }

		if( cx ==  720 && cy ==  288 && fps == 50 ) { j =  1; }

		if( cx ==  720 && cy ==  480 && fps == 60 ) { j =  2; }

		if( cx ==  720 && cy ==  576 && fps == 50 ) { j =  3; }

		if( cx == 1280 && cy ==  720 && fps == 30 ) { j =  4; }

		if( cx == 1280 && cy ==  720 && fps == 25 ) { j =  5; }

		if( cx == 1280 && cy ==  720 && fps == 24 ) { j =  6; }

		if( cx == 1280 && cy ==  720 && fps == 60 ) { j =  7; }

		if( cx == 1280 && cy ==  720 && fps == 50 ) { j =  8; }

		if( cx == 1920 && cy ==  540 && fps == 60 ) { j =  9; }

		if( cx == 1920 && cy ==  540 && fps == 50 ) { j = 10; }

		if( cx == 1920 && cy == 1080 && fps == 30 ) { j = 11; }

		if( cx == 1920 && cy == 1080 && fps == 25 ) { j = 12; }

		if( cx == 1920 && cy == 1080 && fps == 24 ) { j = 13; }

		if( cx == 1920 && cy == 1080 && fps == 60 ) { j = 14; }

		if( cx == 1920 && cy == 1080 && fps == 50 ) { j = 15; }

		///////////////////////////////////////////////////////

		if( cx ==  640 && cy ==  480 && fps == 60 ) { j = 16; }

		if( cx ==  800 && cy ==  600 && fps == 60 ) { j = 17; }

		if( cx == 1024 && cy ==  768 && fps == 60 ) { j = 18; }

		if( cx == 1280 && cy ==  960 && fps == 60 ) { j = 19; }

		if( cx == 1280 && cy == 1024 && fps == 60 ) { j = 20; }

		if( cx == 1440 && cy ==  900 && fps == 60 ) { j = 21; }

		if( cx == 1440 && cy ==  240 && fps == 60 ) { j = 22; }

		if( cx == 1440 && cy ==  288 && fps == 50 ) { j = 23; }

		if( cx ==  640 && cy ==  400 && fps == 60 ) { j = 24; }

		if( cx ==  640 && cy ==  384 && fps == 60 ) { j = 25; }

		if( cx == 1280 && cy ==  768 && fps == 60 ) { j = 26; }

		if( cx == 1280 && cy ==  800 && fps == 60 ) { j = 27; }

		if( cx == 1360 && cy ==  768 && fps == 60 ) { j = 28; }

		if( cx ==  800 && cy ==  600 && fps == 75 ) { j = 29; }

		if( cx ==  800 && cy ==  600 && fps == 85 ) { j = 30; }

		if( cx == 1024 && cy ==  768 && fps == 75 ) { j = 31; }

		if( cx == 1024 && cy ==  768 && fps == 85 ) { j = 32; }

		if( cx == 1280 && cy ==  768 && fps == 75 ) { j = 33; }

		if( cx == 1280 && cy ==  768 && fps == 85 ) { j = 34; }

		if( cx == 1280 && cy ==  800 && fps == 75 ) { j = 35; }

		if( cx == 1280 && cy ==  800 && fps == 85 ) { j = 36; }

		if( cx == 1280 && cy ==  960 && fps == 75 ) { j = 37; }

		if( cx == 1280 && cy ==  960 && fps == 85 ) { j = 38; }

		if( cx == 1280 && cy == 1024 && fps == 75 ) { j = 39; }

		if( cx == 1280 && cy == 1024 && fps == 85 ) { j = 40; }

		if( cx == 1440 && cy ==  900 && fps == 75 ) { j = 41; }

		if( cx == 1440 && cy ==  900 && fps == 85 ) { j = 42; }

		if( cx == 3840 && cy == 1024 && fps == 30 ) { j = 43; }

		if( cx == 1280 && cy ==  720 && fps == 61 ) { j = 44; }

		if( cx == 1920 && cy == 1080 && fps == 61 ) { j = 45; }

		if( cx == 1280 && cy == 1024 && fps == 50 ) { j = 46; }

		if( cx == 1280 && cy ==  720 && fps == 59 ) { j = 47; }

		if( cx == 1280 && cy == 1024 && fps == 59 ) { j = 48; }

		if( cx ==  800 && cy ==  600 && fps == 56 ) { j = 49; }
		
		if( cx ==  640 && cy ==  480 && fps == 72 ) { j = 50; }
		
		if( cx ==  640 && cy ==  480 && fps == 75 ) { j = 51; }
		
		if( cx ==  640 && cy ==  480 && fps == 85 ) { j = 52; }
		
		if( cx ==  800 && cy ==  600 && fps == 72 ) { j = 53; }
		
		if( cx == 1024 && cy ==  768 && fps == 70 ) { j = 54; }
		
		if( cx == 1152 && cy ==  864 && fps == 75 ) { j = 55; }
		
		if( cx == 1400 && cy == 1050 && fps == 60 ) { j = 56; }
		
		if( cx == 1024 && cy ==  768 && fps == 50 ) { j = 57; }
		
		if( cx ==  720 && cy ==  400 && fps == 85 ) { j = 58; }
		
		if( cx ==  832 && cy ==  624 && fps == 75 ) { j = 59; }

		if( cx == 1064 && cy ==  600 && fps == 60 ) { j = 60; }

		if( cx == 1400 && cy == 1050 && fps == 61 ) { j = 61; }

		if( cx == 1024 && cy ==  600 && fps == 60 ) { j = 62; }

		if( cx == 1360 && cy ==  768 && fps == 61 ) { j = 63; }

		if( cx == 1440 && cy ==  540 && fps == 50 ) { j = 64; }

		if( cx == 1680 && cy == 1050 && fps >   0 ) { j = 65; }

		if( cx ==  800 && cy ==  600 && fps == 76 ) { j = 66; }

		if( cx == 1920 && cy == 1200 && fps >   0 ) { j = 67; }

		if( cx == 1600 && cy == 1200 && fps >   0 ) { j = 68; }

		if( cx == 3840 && cy == 2160 && fps >   0 ) { j = 69; }

		if( cx ==  768 && cy ==  288 && fps == 50 ) { j = 70; }

		if( cx ==  800 && cy ==  600 && fps == 55 ) { j = 71; }

		if( cx ==  768 && cy ==  512 && fps == 55 ) { j = 72; }

		if( cx ==  800 && cy ==  500 && fps == 75 ) { j = 73; }
		
		if( cx == 2800 && cy == 2100 && fps >   0 ) { j = 74; }

		p_sys_cfg->b_input_video_signal_changed = FALSE;

		if( (pDevice->iManufacturer == 0x0A ||

			 pDevice->iManufacturer == 0x0D ||

			 pDevice->iManufacturer == 0x13 ||

			 pDevice->iManufacturer == 0x18 ||
			
			 pDevice->iManufacturer == 0x1A ||
			
			(pDevice->iManufacturer == 0x19 && is_ite_table) ) ) {

			ULONG REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE [ 7 ] = {
				
				0x00040000, 

			   ((cx << 16) | (cy - 1)) + 0x00040000, 

			   ((cx << 16) | (cy - 0)), 

				0x000020A0 | (interleaved ?  0x80000000 : 0x00000000), 

				0x01004201 & (interleaved ? ~0x00000200 : 0xFFFFFFFF), 

				0x00000000 | (interleaved ?  cx << 2 : cx << 1),

				0x00000000 | (interleaved ?  cx << 1 : 0x00000000)
			};
			if( p_sys_cfg->b_input_video_resolution_spliter_mode == TRUE ) {

				REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 1 ] = ((cx >> 1) << 16 | (cy - 1)) + 0x00040000,
				
				REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 2 ] = ((cx >> 1) << 16 | (cy - 0)); 

				REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 5 ] = ((cx >> 1) << 1);

				REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 6 ] = (0x00000000);

				if( cy == 1200 ) {

					REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 1 ] = ((cx << 16) | ((cy >> 1) - 1)) + 0x00040000,
					
					REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 2 ] = ((cx << 16) | ((cy >> 1) - 0)); 

					REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 5 ] = ((cx << 1));

					REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 6 ] = (0x00000000);
				}
				if( (cx == 4096 && cy == 2160) ||
					
					(cx >= 3840 && cy == 2160) ||
					
					(cx >= 2800 && cy == 2100) ) {

					REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 1 ] = ((cx >> 1) << 16 | ((cy >> 1) - 1)) + 0x00040000,
					
					REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 2 ] = ((cx >> 1) << 16 | ((cy >> 1) - 0)); 

					REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 5 ] = ((cx >> 1) << 1);

					REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 6 ] = (0x00000000);
				}
				if( cx == 1920 && 
					
					cy == 1080 && 
					
					fps == 120 ) {

					REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 1 ] = ((cx >> 1) << 16 | ((cy >> 1) - 1)) + 0x00040000,
					
					REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 2 ] = ((cx >> 1) << 16 | ((cy >> 1) - 0)); 

					REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 5 ] = ((cx >> 1) << 1);

					REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 6 ] = (0x00000000);
				}
			}
			else {

				if( pDevice->iManufacturer == 0x13 ) {

					REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 0 ] = REG_RESOLUTION_TABLE[ j ][ 0 ][ 1 ];

					REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 1 ] = REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 0 ] + ((cx << 16) | 

																												   (cy - 1));
				}
			}
			ULONG i = 0;
			for( i = 0 ; i < 7 ; i++ ) { 

				SA7160_SetRegister( pDevice, REG_RESOLUTION_TABLE_AUTO_ITE6603[ i ], REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ i ]);

				LINUXV4L2_DEBUG( KERN_INFO, "[%02d] reg(0x%x) value(0x%x) 2--\n", pDevice->m_nKsDeviceNumber, REG_RESOLUTION_TABLE_AUTO_ITE6603[ i ], REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ i ] );

			}
		}
		else if( h_total > 0 ) {

			if( p_sys_cfg->b_input_video_resolution_spliter_mode == FALSE ) {

				REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 0 ][ 1 ] = ((h_total - cx - 4) << 16);

				REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 2 ][ 1 ] = ((cx) << 16) + 

															 ((cy) << 0);

				REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 1 ][ 1 ] = (REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 0 ][ 1 ]) +

															 (REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 2 ][ 1 ]);

				REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 5 ][ 1 ] = ((cx) << 1);
			}
			else {

				ULONG lines = p_sys_cfg->n_input_video_resolution_vbi_lines; // [PROGRAM PATCH] SUPPORT VBI
				
				REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 0 ][ 1 ] = 0x00040000;

				REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 2 ][ 1 ] = ((cx >> 1) << 16) + 

															 ((cy + lines) << 0);

				REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 1 ][ 1 ] = (REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 0 ][ 1 ]) +

															 (REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 2 ][ 1 ]);

				REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 5 ][ 1 ] = ((cx >> 1) << 1);

				if( cy == 1200 ||
					
					cy == 2160 ||
					
					cy == 2100 ) {

					REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 2 ][ 1 ] = ((cx) << 16) + 

																 ((cy) >> 1);

					REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 1 ][ 1 ] = (REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 0 ][ 1 ]) +

																 (REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 2 ][ 1 ]);

					REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 5 ][ 1 ] = (cx << 1);
				}

				// [PROGRAM PATCH] SUPPORT VBI
				// 
				{	REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 3 ][ 1 ] = 0x000020A0 | (interleaved ?  0x80000000 : 0x00000000); 

					REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 4 ][ 1 ] = 0x01004201 & (interleaved ? ~0x00000200 : 0xFFFFFFFF); 

					REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 6 ][ 1 ] = 0x00000000 | (interleaved ?  cx >> 2 : 0x00000000);
				}
			}
			ULONG i = 0;
			for( i = 0 ; i < 7 ; i++ ) { 

				ULONG INDEX = REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ i ][ 0 ];

				ULONG VALUE = REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ i ][ 1 ];

				SA7160_SetRegister( pDevice, INDEX, VALUE );
			}
		}
		else {

			ULONG i = 0;
			for(  i = 0 ; i < 7 ; i++ ) { 

				ULONG INDEX = REG_RESOLUTION_TABLE[ j ][ i ][ 0 ];

				ULONG VALUE = REG_RESOLUTION_TABLE[ j ][ i ][ 1 ];

				if( j == 0 || j == 1 ) {

					if( (pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x01) ||
		   
						(pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x04) ||
						   
						(pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x06) ||
						   
						(pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x07) ||
						   
						(pDevice->iProduct == 0xF5 && pDevice->iManufacturer == 0x02) ||

						(pDevice->iManufacturer == 0x08) ||
						   
						(pDevice->iManufacturer == 0x12) ||
						   
						(pDevice->iManufacturer == 0x14) ||

						(pDevice->iManufacturer == 0x1B) ||
						   
						(pDevice->iManufacturer == 0x1C) ||
						
						(pDevice->m_nAnalogCrossbarVideoInputProperty == 4) ) { // SDI.SD

						INDEX = REG_RESOLUTION_TABLE_GV7601[ j ][ i ][ 0 ];

						VALUE = REG_RESOLUTION_TABLE_GV7601[ j ][ i ][ 1 ];
					}
					else if( pDevice->m_nAnalogCrossbarVideoInputProperty == 5 ||
						
							 pDevice->m_nAnalogCrossbarVideoInputProperty == 6 ) {

						if( pDevice->iManufacturer == 0x09 ) {

							INDEX = REG_RESOLUTION_TABLE_ADV7181[ j ][ i ][ 0 ];

							VALUE = REG_RESOLUTION_TABLE_ADV7181[ j ][ i ][ 1 ];
						}
						else {

							INDEX = REG_RESOLUTION_TABLE_TW9910[ j ][ i ][ 0 ];

							VALUE = REG_RESOLUTION_TABLE_TW9910[ j ][ i ][ 1 ];
						}
					}
					else if( pDevice->iManufacturer == 0x09 ) {

						INDEX = REG_RESOLUTION_TABLE_ADV7181[ j + 2 ][ i ][ 0 ];

						VALUE = REG_RESOLUTION_TABLE_ADV7181[ j + 2 ][ i ][ 1 ];
					}
				}
				if( j == 4 || j == 5 || j == 6 ) {

					if( pDevice->m_nCustomCompanyIvsProperty ) {

						INDEX = REG_RESOLUTION_TABLE_IVS_SONY_CAMERA[ j - 4 ][ i ][ 0 ];

						VALUE = REG_RESOLUTION_TABLE_IVS_SONY_CAMERA[ j - 4 ][ i ][ 1 ];
					}
					if( p_sys_cfg->b_input_video_resolution_external_sync == TRUE ) {

						INDEX = REG_RESOLUTION_TABLE_IVS_SONY_CAMERA[ j - 4 ][ i ][ 0 ];

						VALUE = REG_RESOLUTION_TABLE_IVS_SONY_CAMERA[ j - 4 ][ i ][ 1 ];
					}
				}		
				if( j == 7 || j == 8 ) {

					if( pDevice->m_nCustomCompanyIvsProperty ) {

						INDEX = REG_RESOLUTION_TABLE_IVS_SONY_CAMERA[ j - 4 ][ i ][ 0 ];

						VALUE = REG_RESOLUTION_TABLE_IVS_SONY_CAMERA[ j - 4 ][ i ][ 1 ];
					}
				}
				if( j == 7 || j == 8 || j == 9 || j == 10 || j == 11 || j == 12 ) {

					if( pDevice->m_nCustomSpecialCameraInputProperty == 1 ) {

						INDEX = REG_RESOLUTION_TABLE_ISMART_CAHC_CAMERA[ j - 7 ][ i ][ 0 ];

						VALUE = REG_RESOLUTION_TABLE_ISMART_CAHC_CAMERA[ j - 7 ][ i ][ 1 ];
					}
				}
				SA7160_SetRegister( pDevice, INDEX, VALUE );
			}
		}
		LINUXV4L2_PRINT( KERN_INFO, "[00] [FORMAT.EXCHANGE.%02d] [%d x %d x %d]\n", j, cx, cy, fps);

		#ifdef ENABLE_1920X1080PX60FPS // +SC500

		// FPGA
		// 
		if( (pDevice->iManufacturer == 0x01 && pDevice->iProduct == 0x07) || // EURESYS.SC510N1.1ST

			(pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST
				
			(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST
		
			(pDevice->iManufacturer == 0x1A && pDevice->m_nCustomGpioSupportProperty == 8) ||
			
			(pDevice->iManufacturer == 0x1B && pDevice->m_nCustomGpioSupportProperty == 8) ||
					
			(pDevice->iManufacturer == 0x10) ||

			(pDevice->iManufacturer == 0x12) ||

			(pDevice->iManufacturer == 0x13) ||

			(pDevice->iManufacturer == 0x14) ||

			(pDevice->iManufacturer == 0x16) ||

			(pDevice->iManufacturer == 0x17) ||
			
			(pDevice->iManufacturer == 0x18) ||
				
		   ((pDevice->iManufacturer & 0xF0) == 0x00 &&
		   
			(pDevice->iProduct & 0x0F) == 0x05) ) {

			if( (cx == 1280 && cy ==  768 && fps ==  85) ||

				(cx == 1280 && cy ==  800 && fps ==  85) ||

				(cx == 1280 && cy ==  960 && fps ==  75) ||

				(cx == 1280 && cy ==  960 && fps ==  85) ||

				(cx == 1280 && cy == 1024 && fps ==  75) ||

				(cx == 1280 && cy == 1024 && fps ==  85) ||

				(cx == 1400 && cy == 1050 && fps >    0) ||

				(cx == 1440 && cy ==  900 && fps ==  75) ||

				(cx == 1440 && cy ==  900 && fps ==  85) ||

				(cx == 1680 && cy == 1050 && fps >    0) ||

				(cx == 1920 && cy == 1080 && fps ==  61) ||

				(cx == 1920 && cy == 1080 && fps ==  60) ||

				(cx == 1920 && cy == 1080 && fps ==  50) ||

				(cx == 1920 && cy == 1080 && fps == 120) ||

				(cx == 1920 && cy == 1200 && fps >    0) ||

				(cx == 1600 && cy == 1200 && fps >    0) ||

				(cx == 3840 && cy == 1024 && fps >    0) ||

				(cx >= 3840 && cy == 2160 && fps >    0) ||
				
				(cx >= 2800 && cy == 2100 && fps >    0) ||

				(cx == 4096 && cy == 2160 && fps >    0) ||
				
				(h_total > 0 && 
				
				 p_sys_cfg->b_input_video_resolution_spliter_mode == TRUE) ) {

				if( ((pDevice->iManufacturer & 0xF0) == 0x00 &&
							   
					 (pDevice->iProduct & 0x0F) == 0x05) ) {

					SA7160_SetFpgaRegister( pDevice, 0x21, 0x01 ); // BYPASS.MODE

					SA7160_SetFpgaRegister( pDevice, 0x21, 0x00 ); // SPLIT.MODE
				}
				else if( pDevice->iManufacturer == 0x12 ||
					
						 pDevice->iManufacturer == 0x14 ) {

					SA7160_SetFpgaRegister( pDevice, 0x21, 0x01 ); // BYPASS.MODE

					SA7160_SetFpgaRegister( pDevice, 0x21, 0x00 ); // SPLIT.MODE
				}
				else if( pDevice->iManufacturer == 0x13 ||
					
						 pDevice->iManufacturer == 0x18 ||
					
						 pDevice->iManufacturer == 0x1A ) {
				
					ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
					
					R0000E004 |=  0x00000004; // BYPASS.MODE

					SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );

					R0000E004 &= ~0x00000004; // SPLITER.MODE

					SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );
				}
				else {

					ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
					
					R0000E004 |=  0x00020000; // BYPASS.MODE

					SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );

					R0000E004 &= ~0x00020000; // SPLITER.MODE

					SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );
				}
				
				LINUXV4L2_PRINT( KERN_INFO, "[CH%02d] [FPGA.RESET.#0] ---\n", pDevice->m_nKsDeviceNumber);
			}
		}
		#endif

		{	SA7160_SetRegister( pDevice, 0x00000000 + 0x00000FE8, 0x000003FF );	// VIP.INT.CLEAR

			SA7160_SetRegister( pDevice, 0x00000000 + 0x00000000, 0x00010000 );	// VIP.MODE

			SA7160_SetRegister( pDevice, 0x00000000 + 0x00000000, 0xD0020000 ); // VIP.MODE
		}
			
		//	SA7160_START_THREAD();
			SA7160_StartControlPanelAnalysisThread( pDevice );
		}

		ULONG R00008000 = 0x00000000;

		ULONG i = 0;

		for( i = 0 ; i < 100 ; i++ ) {

			R00008000 = SA7160_GetRegister( pDevice, 0x00008000 + 0x0000 );
			if( R00008000 == 0x00000000 ) { break; }

			wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(25) );
		}

	if( R00008000 == 0x00000000 ) {

		SA7160_SetRegister( pDevice, 0x00008000 + 0x0000, 0x00000007 );
		SA7160_SetRegister( pDevice, 0x00008000 + 0x0004, 0x00000000 );
		SA7160_SetRegister( pDevice, 0x00008000 + 0x0008, 0x00000000 );
		SA7160_SetRegister( pDevice, 0x00008000 + 0x000C, 0x00000000 );
		SA7160_SetRegister( pDevice, 0x00008000 + 0x0010, 0x00000000 );
		SA7160_SetRegister( pDevice, 0x00008000 + 0x0014, 0x00000000 );
		SA7160_SetRegister( pDevice, 0x00008000 + 0x0018, 0x00000000 );
		SA7160_SetRegister( pDevice, 0x00008000 + 0x001C, 0x00000000 );
		SA7160_SetRegister( pDevice, 0x00008000 + 0x0020, 0x00000000 );

		SA7160_SetRegister( pDevice, 0x00008000 + 0x0024, 0x00000007 );
		SA7160_SetRegister( pDevice, 0x00008000 + 0x0028, 0x00000000 );
		SA7160_SetRegister( pDevice, 0x00008000 + 0x002C, 0x00000000 );
		SA7160_SetRegister( pDevice, 0x00008000 + 0x0030, 0x00000000 );
		SA7160_SetRegister( pDevice, 0x00008000 + 0x0034, 0x00000000 );
		SA7160_SetRegister( pDevice, 0x00008000 + 0x0038, 0x00000000 );
		SA7160_SetRegister( pDevice, 0x00008000 + 0x003C, 0x00000000 );
		SA7160_SetRegister( pDevice, 0x00008000 + 0x0040, 0x00000000 );
		SA7160_SetRegister( pDevice, 0x00008000 + 0x0044, 0x00000000 );
	}

	// -----> tmHWStreamPort_VIP_Video::tmIPause()
	// 
	{	ULONG R00000000 = SA7160_GetRegister( pDevice, 0x00000000 + 0x00000000 ); // VIP.MODE
		ULONG R00000180 = SA7160_GetRegister( pDevice, 0x00000000 + 0x00000180 ); // VIP.AUX.XYSTART	
		ULONG R00000184 = SA7160_GetRegister( pDevice, 0x00000000 + 0x00000184 ); // VIP.AUX.XYEND  
		ULONG R00000380 = SA7160_GetRegister( pDevice, 0x00000000 + 0x00000380 ); // VIP.AUX.FORMAT 
		ULONG R00000390 = SA7160_GetRegister( pDevice, 0x00000000 + 0x00000390 ); // VIP.AUX.BASE   
		ULONG R00000394 = SA7160_GetRegister( pDevice, 0x00000000 + 0x00000394 ); // VIP.AUX.PITCH  

		ULONG i = 0;
		for( i = 0 ; i < 25 ; i++ ) { // CHECK IF VIDEO IS RUNNING

			R00000000 = SA7160_GetRegister( pDevice, 0x00000000 + 0x00000000 ); // VIP.MODE

			if( R00000000 != 0xFFFFFFFF ) { break; }

			wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(25) );
		}
		if( R00000000 == 0xFFFFFFFF ) { R00000000 = 0x00000000; }

		// -----> tmHWStreamPort_VIP_Video::tmIPause() -----> tmHWStreamPort_VIP_Video::tmSetInternalClock()
		//
		{	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x44, 0x00000001 ); // CGU.PCR.05

			SA7160_SetRegister( pDevice, 0x00013000 + 0x0000 + 0x04 * 5, 0x00000001 ); // CGU.SCR.05

			SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 * 5, 0x00000000 ); // CGU.FS1.05

			SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x44, 0x00000001 ); // CGU.ESR.05
		}
		SA7160_SetRegister( pDevice, 0x00000000 + 0x00000000, 0x00010000 );	// VIP.MODE
		SA7160_SetRegister( pDevice, 0x00000000 + 0x00000FE4, 0x00000000 );	// VIP.INT.ENABLE
		SA7160_SetRegister( pDevice, 0x00000000 + 0x00000FE8, 0x000003FF );	// VIP.INT.CLEAR
		SA7160_SetRegister( pDevice, 0x00000000 + 0x00000180, 0x00000000 ); // VIP.AUX.XYSTART
		SA7160_SetRegister( pDevice, 0x00000000 + 0x00000184, 0x00000000 ); // VIP.AUX.XYEND  
		SA7160_SetRegister( pDevice, 0x00000000 + 0x00000380, 0x00000000 ); // VIP.AUX.FORMAT 
		SA7160_SetRegister( pDevice, 0x00000000 + 0x00000390, 0x00000000 ); // VIP.AUX.BASE   
		SA7160_SetRegister( pDevice, 0x00000000 + 0x00000394, 0x00000000 ); // VIP.AUX.PITCH  
	}
	// -----> tmHWStreamPort_VIP_Video::tmIRun()
	//
	{	ULONG R0009004 = SA7160_GetRegister( pDevice, 0x00009000 + 0x0004 ); // MMU.DMA.CONFIG

		SA7160_SetRegister( pDevice, 0x00009000 + 0x0004, R0009004 & ~0x40 ); // MMU.DMA.CONFIG

		SA7160_SetRegister( pDevice, 0x00009000 + 0x0004, R0009004 |  0x40 ); // MMU.DMA.CONFIG

		ULONG R0009008 = SA7160_GetRegister( pDevice, 0x00009000 + 0x0008 ); // MMU.DMA.CONFIG

		SA7160_SetRegister( pDevice, 0x00009000 + 0x0008, R0009008 & ~0x40 ); // MMU.DMA.CONFIG

		SA7160_SetRegister( pDevice, 0x00009000 + 0x0008, R0009008 |  0x40 ); // MMU.DMA.CONFIG

		SA7160_SetRegister( pDevice, 0x00000000 + 0x0FE4, 0x000003FF ); // VIP.INT.ENABLE
		
		ULONG i = 0;
		for( i = 0 ; i < 1000 ; i++ ) {

			ULONG R0009004 = SA7160_GetRegister( pDevice, 0x00009000 + 0x0004 ); // MMU.DMA.CONFIG

			ULONG R0009008 = SA7160_GetRegister( pDevice, 0x00009000 + 0x0008 ); // MMU.DMA.CONFIG

			if( (R0009004 & 0x00000080) &&

				(R0009004 & 0x00000080) ) {

				break;
			}
			wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(1) );
		}
		ULONG R00000000 = SA7160_GetRegister( pDevice, 0x00000000 + 0x0000 ); // VIP.MODE

		SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 * 5, 0x00000002 ); // CGU.FS1.05

		SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x44, 0x00000000 ); // CGU.ESR.05

		SA7160_SetRegister( pDevice, 0x00000000 + 0x0000, R00000000 | 0xD0020000 ); // VIP.MODE
	}

	// -----> tmHWStreamPort_Audio::tmIAcquire()
	// 
	ULONG n_audio_port = 0x00000001;

	if( (pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x06) ||
		   
		(pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x07) ||
		  
		(pDevice->iManufacturer == 0x08) ||
	   
		(pDevice->iManufacturer == 0x0C) ||

		(pDevice->iManufacturer == 0x0D) ||
		
		(pDevice->iManufacturer == 0x14) ||

		(pDevice->iManufacturer == 0x16) ||

		(pDevice->iManufacturer == 0x1B) ) {

		if( pDevice->m_nAnalogCrossbarAudioInputProperty == 1 ) {

			n_audio_port = 0x00000000;
		}
	}
	if( (pDevice->iManufacturer == 0x0C) ||
	
		(pDevice->iManufacturer == 0x16) ) {
		
		if( pDevice->m_nAnalogCrossbarVideoInputProperty == 2 ||
			
			pDevice->m_nAnalogCrossbarVideoInputProperty == 3 ) {

			n_audio_port = 0x00000000;
		}
	}

	LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsInitialize( Audio port:%08X )\n", pDevice->m_nKsDeviceNumber, n_audio_port );

	if( n_audio_port == 0x00000000 ) {

		// -----> tmHWStreamPort_Audio::tmIAcquire() -----> tmHWStreamPort_Audio::tmISetParameters()
		// 
		// AIP PROGRAMMING (m_pMunit_AudioIn)
		// 
		SA7160_SetRegister( pDevice, 0x00006000 + 0x0004, 0x80000000 ); // AIP.CTL

		// BAM PROGRAMMING (m_pMunit_BAM)
		// 
		SA7160_SetRegister( pDevice, 0x00008000 + 0x0168, 0x00000040 ); // BAM.DMA.BUF.MODE -> BAM_DMA_Buf_Mode)

		// AIP PROGRAMMING (m_pMunit_AudioIn) (m_pAudio)
		// 
		SA7160_SetRegister( pDevice, 0x00006000 + 0x001C, 0x00000000 ); // AIP.SIZE

		ULONG R00007FFC = SA7160_GetRegister( pDevice, 0x00006000 + 0x0FFC ); // AIP.MODULE.ID

		if( R00007FFC != 0x010D1200 ) {

			;
		}
		LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsInitialize( AIP:%08X )\n", pDevice->m_nKsDeviceNumber, R00007FFC );

		SA7160_SetRegister( pDevice, 0x00006000 + 0x0008, 0x00000000 ); // AIP.SERIAL
		SA7160_SetRegister( pDevice, 0x00006000 + 0x0004, 0x30000000 ); // AIP.CTL
		SA7160_SetRegister( pDevice, 0x00006000 + 0x000C, 0x00000200 ); // AIP.FRAMING
		SA7160_SetRegister( pDevice, 0x00006000 + 0x0014, 0x01400000 ); // AIP.BASE1
		SA7160_SetRegister( pDevice, 0x00006000 + 0x0018, 0x01400000 ); // AIP.BASE2

		if( pDevice->iManufacturer == 0x0A ||

			pDevice->iManufacturer == 0x0D ||

			pDevice->iManufacturer == 0x18 ||

			pDevice->iManufacturer == 0x1A ) {

			SA7160_SetRegister( pDevice, 0x00006000 + 0x000C, 0x80000200 ); // AIP.FRAMING (L/R ADJUSTMENT)
		}
		else {

			SA7160_SetRegister( pDevice, 0x00006000 + 0x000C, 0x00000200 ); // AIP.FRAMING
		}

		ULONG R00008168 = 0x00000000;
		ULONG i = 0;
		for( i = 0 ; i < 100 ; i++ ) {

			R00008168 = SA7160_GetRegister( pDevice, 0x00008000 + 0x0168 );

			if( R00008168 == 0x00000000 ) { break; }

			//DELAY_100NS( 250000 );
			wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 25 ) );
		}
		if( R00008168 == 0x00000000 ) {

			SA7160_SetRegister( pDevice, 0x00008000 + 0x0168, 0x00000007 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x016C, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0170, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0174, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0178, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x017C, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0180, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0184, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0188, 0x00000000 );
		}

		// -----> tmHWStreamPort_Audio::tmIPause()
		// 
		{	ULONG R00007004 = SA7160_GetRegister( pDevice, 0x00006000 + 0x00000004 ); // AIP.CTL

			// -----> tmHWStreamPort_Audio::tmIPause() -----> tmHWStreamPort_Audio::tmSetInternalClock()
			//
			{	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x5C, 0x00000001 ); // CGU.PCR.11

				SA7160_SetRegister( pDevice, 0x00013000 + 0x0000 + 0x04 * 11, 0x00000001 ); // CGU.SCR.11

				SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 * 11, 0x00000000 ); // CGU.FS1.11

				SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x5C, 0x00000001 ); // CGU.ESR.11
			}
			SA7160_SetRegister( pDevice, 0x00006000 + 0x00000020, 0x0000000F );	// AIP.INT.ACKN
		}
		// -----> tmHWStreamPort_Audio::tmIRun()
		//
		{	ULONG R000902C = SA7160_GetRegister( pDevice, 0x00009000 + 0x002C ); // MMU.DMA.CONFIG

			SA7160_SetRegister( pDevice, 0x00009000 + 0x002C, R000902C & ~0x40 ); // MMU.DMA.CONFIG

			SA7160_SetRegister( pDevice, 0x00009000 + 0x002C, R000902C |  0x40 ); // MMU.DMA.CONFIG

			for( i = 0 ; i < 1000 ; i++ ) {

				R000902C = SA7160_GetRegister( pDevice, 0x00009000 + 0x002C ); // MMU.DMA.CONFIG

				if( R000902C & 0x00000080 ) {

					break;
				}
				//DELAY_100NS( 100 );
				wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 1 ) );

			}
			ULONG R00007004 = SA7160_GetRegister( pDevice, 0x00006000 + 0x00000004 ); R00007004 |= 0x000000F0; // AIP.CTL

			SA7160_SetRegister( pDevice, 0x00006000 + 0x00000004, R00007004 ); // AIP.CTL

			SA7160_SetRegister( pDevice, 0x00006000 + 0x00000020, 0x0000000F );	// AIP.INT.ACKN

			SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 * 11, 0x00000008 ); // CGU.FS1.11

			SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x5C, 0x00000000 ); // CGU.ESR.11

			SA7160_SetRegister( pDevice, 0x00006000 + 0x00000004, R00007004 | 0x40000000 ); // AIP.CTL

			//DELAY_100NS( 100000 );
			wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 10 ) );

			SA7160_SetRegister( pDevice, 0x00006000 + 0x0000001C, 0x00000400 ); // AIP.SIZE (4096)
		}
	}
	if( n_audio_port == 0x00000001 ) {

		// -----> tmHWStreamPort_Audio::tmIAcquire() -----> tmHWStreamPort_Audio::tmISetParameters()
		// 
		// AIP PROGRAMMING (m_pMunit_AudioIn)
		// 
		SA7160_SetRegister( pDevice, 0x00007000 + 0x0004, 0x80000000 ); // AIP.CTL

		// BAM PROGRAMMING (m_pMunit_BAM)
		// 
		SA7160_SetRegister( pDevice, 0x00008000 + 0x018C, 0x00000040 ); // BAM.DMA.BUF.MODE

		// AIP PROGRAMMING (m_pMunit_AudioIn) (m_pAudio)
		// 
		SA7160_SetRegister( pDevice, 0x00007000 + 0x001C, 0x00000000 ); // AIP.SIZE

		ULONG R00007FFC = SA7160_GetRegister( pDevice, 0x00007000 + 0x0FFC ); // AIP.MODULE.ID

		if( R00007FFC != 0x010D1200 ) {

			;
		}
		LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsInitialize( AIP:%08X )\n", pDevice->m_nKsDeviceNumber, R00007FFC );

		SA7160_SetRegister( pDevice, 0x00007000 + 0x0008, 0x00000000 ); // AIP.SERIAL
		SA7160_SetRegister( pDevice, 0x00007000 + 0x0004, 0x30000000 ); // AIP.CTL
		SA7160_SetRegister( pDevice, 0x00007000 + 0x000C, 0x00000200 ); // AIP.FRAMING
		SA7160_SetRegister( pDevice, 0x00007000 + 0x0014, 0x01600000 ); // AIP.BASE1 
		SA7160_SetRegister( pDevice, 0x00007000 + 0x0018, 0x01600000 ); // AIP.BASE2

		if( pDevice->iManufacturer == 0x0A ||

			pDevice->iManufacturer == 0x0D ||

			pDevice->iManufacturer == 0x18 ||

			pDevice->iManufacturer == 0x1A ) {

			SA7160_SetRegister( pDevice, 0x00007000 + 0x000C, 0x80000200 ); // AIP.FRAMING (L/R ADJUSTMENT)
		}
		else {

			SA7160_SetRegister( pDevice, 0x00007000 + 0x000C, 0x00000200 ); // AIP.FRAMING
		}

		ULONG R0000818C = 0x00000000;
		ULONG i = 0;
		for( i = 0 ; i < 100 ; i++ ) {

			R0000818C = SA7160_GetRegister( pDevice, 0x00008000 + 0x018C );

			if( R0000818C == 0x00000000 ) { break; }

			//DELAY_100NS( 250000 );
			wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 25 ) );

		}
		if( R0000818C == 0x00000000 ) {

			SA7160_SetRegister( pDevice, 0x00008000 + 0x018C, 0x00000007 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0190, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0194, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0198, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x019C, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x01A0, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x01A4, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x01A8, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x01AC, 0x00000000 );
		}

		// -----> tmHWStreamPort_Audio::tmIPause()
		// 
		{	ULONG R00007004 = SA7160_GetRegister( pDevice, 0x00007000 + 0x00000004 ); // AIP.CTL

			// -----> tmHWStreamPort_Audio::tmIPause() -----> tmHWStreamPort_Audio::tmSetInternalClock()
			//
			{	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x60, 0x00000001 ); // CGU.PCR.12

				SA7160_SetRegister( pDevice, 0x00013000 + 0x0000 + 0x04 * 12, 0x00000001 ); // CGU.SCR.12

				SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 * 12, 0x00000000 ); // CGU.FS1.12

				SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x60, 0x00000001 ); // CGU.ESR.12
			}
			SA7160_SetRegister( pDevice, 0x00007000 + 0x00000020, 0x0000000F );	// AIP.INT.ACKN
		}
		// -----> tmHWStreamPort_Audio::tmIRun()
		//
		{	ULONG R0009030 = SA7160_GetRegister( pDevice, 0x00009000 + 0x0030 ); // MMU.DMA.CONFIG

			SA7160_SetRegister( pDevice, 0x00009000 + 0x0030, R0009030 & ~0x40 ); // MMU.DMA.CONFIG

			SA7160_SetRegister( pDevice, 0x00009000 + 0x0030, R0009030 |  0x40 ); // MMU.DMA.CONFIG
			
			for( i = 0 ; i < 1000 ; i++ ) {

				R0009030 = SA7160_GetRegister( pDevice, 0x00009000 + 0x0030 ); // MMU.DMA.CONFIG

				if( R0009030 & 0x00000080 ) {

					break;
				}
				//DELAY_100NS( 100 );
				wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 1 ) );

			}
			ULONG R00007004 = SA7160_GetRegister( pDevice, 0x00007000 + 0x00000004 ); R00007004 |= 0x000000F0; // AIP.CTL

			SA7160_SetRegister( pDevice, 0x00007000 + 0x00000004, R00007004 ); // AIP.CTL

			SA7160_SetRegister( pDevice, 0x00007000 + 0x00000020, 0x0000000F );	// AIP.INT.ACKN

			SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 * 12, 0x00000009 ); // CGU.FS1.12

			SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x60, 0x00000000 ); // CGU.ESR.12

			SA7160_SetRegister( pDevice, 0x00007000 + 0x00000004, R00007004 | 0x40000000 ); // AIP.CTL

			//DELAY_100NS( 100000 );
			wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 10 ) );

			SA7160_SetRegister( pDevice, 0x00007000 + 0x0000001C, 0x00000400 ); // AIP.SIZE (4096)
		}
	}
		// -----> tmHWInterrupts_mUncle::tmIAddInterruptCallback()
		//
//		SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FE8, 0x00000801 ); // MSI.INT.ENA.SET.L

//		SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FEC, 0x00000000 ); // MSI.INT.ENA.SET.H

		if( (pDevice->iManufacturer == 0x19) || (pDevice->iManufacturer == 0x18 && SA7160_IS_4K2K_ENABLED( pDevice )) )
		{
			NULL; // no interrupt
		}
		else if( (pDevice->iManufacturer == 0x1A && pDevice->m_nCustomGpioSupportProperty == 0) ) { // +SC510N4 HDMI

			if( pDevice->m_nKsDeviceNumber > 0 ) {

				CDevice * p_brother_device = g_pDevice[ pDevice->m_nKsDeviceNumber - 1 ];

				if( p_brother_device ) {
					
					ULONG R0000E004 = SA7160_GetRegister( p_brother_device, 0x0000E000 + 0x0004 ); // GPIO.WR
							
					if( (R0000E004 & 0x00000004) == 0x00000000 ) { // SPLITER.MODE

						LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsInitialize() no interrupt 0x1A\n", pDevice->m_nKsDeviceNumber );
					}
					else
					{
						// ...
						SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FC8, 0xFFFFFFFF ); // MSI.INT.STATUS.CLR.L

						SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FCC, 0xFFFFFFFF ); // MSI.INT.STATUS.CLR.H

						// ...
						SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FE8, 0x00000C01 ); // MSI.INT.ENA.SET.L

						SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FEC, 0x00000000 ); // MSI.INT.ENA.SET.H

						pDevice->m_hInterruptAccessLock = TRUE;

						LINUXV4L2_PRINT( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsInitialize() enable interrupt 0x1A\n", pDevice->m_nKsDeviceNumber );
					}
				}
			}
		}
		else if( (pDevice->iManufacturer == 0x1B && pDevice->m_nCustomGpioSupportProperty == 0) ) { // +SC510N4 SDI

			if( pDevice->m_nKsDeviceNumber > 0 ) {

				CDevice * p_brother_device = g_pDevice[ pDevice->m_nKsDeviceNumber - 1 ];

				if( p_brother_device ) {
					
					ULONG R0000E004 = SA7160_GetRegister( p_brother_device, 0x0000E000 + 0x0004 ); // GPIO.WR
							
					if( (R0000E004 & 0x00020000) == 0x00000000 ) { // SPLITER.MODE

						LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsInitialize() no interrupt 0x1B\n", pDevice->m_nKsDeviceNumber );
					}
					else
					{
						// ...
						SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FC8, 0xFFFFFFFF ); // MSI.INT.STATUS.CLR.L

						SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FCC, 0xFFFFFFFF ); // MSI.INT.STATUS.CLR.H

						// ...
						SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FE8, 0x00000C01 ); // MSI.INT.ENA.SET.L

						SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FEC, 0x00000000 ); // MSI.INT.ENA.SET.H

						pDevice->m_hInterruptAccessLock = TRUE;

						LINUXV4L2_PRINT( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsInitialize() enable interrupt 0x1B\n", pDevice->m_nKsDeviceNumber );
					}
				}
			}
		}
		else
		{

			// ...
			SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FC8, 0xFFFFFFFF ); // MSI.INT.STATUS.CLR.L

			SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FCC, 0xFFFFFFFF ); // MSI.INT.STATUS.CLR.H

			// ...
			SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FE8, 0x00000C01 ); // MSI.INT.ENA.SET.L

			SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FEC, 0x00000000 ); // MSI.INT.ENA.SET.H

			pDevice->m_hInterruptAccessLock = TRUE;

			LINUXV4L2_PRINT( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsInitialize() enable interrupt\n", pDevice->m_nKsDeviceNumber );

		}

		pDevice->m_nDmaBaseCommonBufferNumber[ 0 ] = 0;

		pDevice->m_nDmaBaseCommonBufferCustomMiscProperty[ 0 ] = 1;

		pDevice->previous_field_ts.tv_sec = 0;

		pDevice->previous_field_ts.tv_usec = 0;	

		pDevice->field_counter = 0;


#ifdef ENABLE_1920X1080PX60FPS

	if( (pDevice->iManufacturer == 0x01 && pDevice->iProduct == 0x07) ||
		
		(pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) ||
				
		(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) ||

		(pDevice->iManufacturer == 0x1A && pDevice->m_nCustomGpioSupportProperty == 8) ||
		
		(pDevice->iManufacturer == 0x1B && pDevice->m_nCustomGpioSupportProperty == 8) ||

		pDevice->iManufacturer == 0x10 ||

		pDevice->iManufacturer == 0x12 ||

		pDevice->iManufacturer == 0x13 ||
		
		pDevice->iManufacturer == 0x14 ||
		
		pDevice->iManufacturer == 0x16 ||

		pDevice->iManufacturer == 0x17 ||
		
		pDevice->iManufacturer == 0x18 ) {

		if( p_brother_sys_cfg == NULL ) {

			SA7160_SYS_CFG * p_sys_cfg = (SA7160_SYS_CFG *)(pDevice->m_pCustomSystemConfigProperty);

			ULONG nums = 1;
			
			if( (p_sys_cfg->n_input_video_resolution_cx == 4096 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
				
				(p_sys_cfg->n_input_video_resolution_cx >= 3840 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
				
				(p_sys_cfg->n_input_video_resolution_cx >= 2800 && p_sys_cfg->n_input_video_resolution_cy == 2100 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
				
				(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 120) ) {

				nums = 3;
			}
			else {

				nums = 1;
			}

			//initial all 4 chips in case resolution is not detected
			if(pDevice->iManufacturer == 0x13)
			{
				nums = 3;
			}

			LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsInitialize( nums:%X )\n", pDevice->m_nKsDeviceNumber, nums );

			BOOL is_ite_table = FALSE;

			if( (pDevice->iManufacturer == 0x1A && pDevice->m_nCustomGpioSupportProperty == 8) ||
							
				(pDevice->iManufacturer == 0x13) ||

				(pDevice->iManufacturer == 0x18) ) {

				is_ite_table = TRUE;
			}
			
			ULONG n = 0;
			
			for( n = 0 ; n < nums ; n++ ) {

				CDevice * p_brother_device = g_pDevice[ pDevice->m_nKsDeviceNumber + n + 1 ];

				if( p_brother_device ) {
				
					if( p_brother_device->m_nAnalogCaptureStreamPowerReference > 0 ) { LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsInitialize() already used(0x%x)\n", pDevice->m_nKsDeviceNumber, pDevice->m_nKsDeviceNumber + n + 1 ); break ; } // +SC510N4 [已經在使用]

					SA7160_HwAnalogComponentsInitialize( p_brother_device, p_sys_cfg, is_ite_table );
				}
				else
				{
					LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsInitialize() no device(0x%x)\n", pDevice->m_nKsDeviceNumber, pDevice->m_nKsDeviceNumber + n + 1 );
				}
				if( n == (nums - 1) ) {

					return TRUE;
				}
			}
		}
		else {

			//never come here
			//pDevice->m_hInterruptAccessLock = 0x00000000;

			//SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FC8, 0xFFFFFFFF ); // MSI.INT.STATUS.CLR.L

			//SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FCC, 0xFFFFFFFF ); // MSI.INT.STATUS.CLR.H

			//SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FE8, 0x00000C01 ); // MSI.INT.ENA.SET.L

			//SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FEC, 0x00000000 ); // MSI.INT.ENA.SET.H

			//pDevice->m_hInterruptAccessLock = 0x00000001;
		}
	}
#endif

	return TRUE;
}

BOOLEAN SA7160_HwAnalogComponentsUnInitialize( CDevice * pDevice, SA7160_SYS_CFG * p_brother_sys_cfg )
{
	if( p_brother_sys_cfg == NULL ) {

		if( pDevice->m_nAnalogCaptureStreamPowerReference == 0 ) return TRUE;
		
		if( pDevice->m_nAnalogCaptureStreamPowerReference != 1 ) {

			pDevice->m_nAnalogCaptureStreamPowerReference--;

			return TRUE;
		}
		pDevice->m_nAnalogCaptureStreamPowerReference = 0;

	}

	pDevice->m_nAnalogCaptureStreamPowerReference = 0;

	LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsUnInitialize()\n", pDevice->m_nKsDeviceNumber );


	// ...
	SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FE0, 0x00000C01 ); // MSI.INT.CLR.SET.L

	SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FE4, 0x00000000 ); // MSI.INT.CLR.SET.H

	pDevice->m_nDmaBaseCommonBufferNumber[ 0 ] = 0;

	pDevice->m_nDmaBaseCommonBufferCustomMiscProperty[ 0 ] = 0;

	pDevice->m_nAnalogCopyProtMacrovisionProperty = 0;

	pDevice->m_nAnalogVideoDecoderStatusProperty = 0;

	// -----> tmHWStreamPort_VIP_Video::tmIPause()
	// 
	ULONG R00000000 = SA7160_GetRegister( pDevice, 0x00000000 + 0x00000000 ); // VIP.MODE

	ULONG i = 0;
	for( i = 0 ; i < 25 ; i++ ) { // CHECK IF VIDEO IS RUNNING

		R00000000 = SA7160_GetRegister( pDevice, 0x00000000 + 0x00000000 ); // VIP.MODE

		if( R00000000 != 0xFFFFFFFF ) { break; }

		wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(25) );
	}
	if( R00000000 == 0xFFFFFFFF ) { R00000000 = 0xC0000000; }

	if( R00000000 & 0xC0000000 ) {

		SA7160_SetRegister( pDevice, 0x00000000 + 0x00000000, R00000000 & 0x3FFFFFFF );	// VIP.MODE

		//wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(25) );
		mdelay(25);
	}
	// -----> tmHWStreamPort_VIP_Video::tmIPause() -----> tmHWStreamPort_VIP_Video::tmSetInternalClock()
	//
	{	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x44, 0x00000001 ); // CGU.PCR.05

		SA7160_SetRegister( pDevice, 0x00013000 + 0x0000 + 0x04 * 5, 0x00000001 ); // CGU.SCR.05

		SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 * 5, 0x00000000 ); // CGU.FS1.05

		SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x44, 0x00000001 ); // CGU.ESR.05
	}
	if( R00000000 & 0xC0000000 ) {

		// -----> tmHWStreamPort_VIP_Video::tmIPause() -----> tmHWStreamPort_VIP_Video::tmISetParameters()
		// 
		// BAM PROGRAMMING (m_pMunit_BAM)
		// 
		SA7160_SetRegister( pDevice, 0x00008000 + 0x0000, 0x00000040 ); // BAM.DMA.BUF.MODE

		// VIP PROGRAMMING (m_pMunit_VIP) (m_pVIP_Lite)
		// 
		ULONG R00000FFC = SA7160_GetRegister( pDevice, 0x00000000 + 0x0FFC ); // VIP.MODULE.ID

		if( R00000FFC != 0x011A5100 ) {

			;
		}
		LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsUnInitialize( VIP:%08lX )\n", pDevice->m_nKsDeviceNumber, R00000FFC );

		SA7160_SetRegister( pDevice, 0x00000000 + 0x0FF4, 0x00000000 ); // VIP.POWER.DOWN
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0020, 0x00000000 ); // VIP.ANC.DID.FIELD0
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0024, 0x00000000 ); // VIP.ANC.DID.FIELD1
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0040, 0x00000000 ); // VIP.LINE.THR
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0160, 0x00000000 ); // VIP.PRE.DIT.CTRL
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0164, 0x00000000 ); // VIP.POST.DIT.CTRL
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0284, 0x00000000 ); // VIP.CSM.CKEY
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0140, 0x03380001 ); // VIP.WIN.XYSTART
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0144, 0x0AB80439 ); // VIP.WIN.XYEND
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0304, 0x07800438 ); // VIP.PSU.WINDOW (1920 × 1080)
	//	SA7160_SetRegister( pDevice, 0x00000000 + 0x0300, 0x000020A0 ); // VIP.PSU.FORMAT (SAA1997)
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0300, 0x000020A1 ); // VIP.PSU.FORMAT (MST3367)
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0100, 0x01004201 ); // VIP.VIN.FORMAT
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0340, 0x00000000 ); // VIP.PSU.BASE1
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0344, 0x00000F00 ); // VIP.PSU.PITCH1
		SA7160_SetRegister( pDevice, 0x00000000 + 0x034C, 0x00000000 ); // VIP.PSU.PITCH2
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0348, 0x00000000 ); // VIP.PSU.BASE2
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0350, 0x00000000 ); // VIP.PSU.BASE3
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0354, 0x00000000 ); // VIP.PSU.BASE4
		SA7160_SetRegister( pDevice, 0x00000000 + 0x0358, 0x00000000 ); // VIP.PSU.BASE5
		SA7160_SetRegister( pDevice, 0x00000000 + 0x035C, 0x00000000 ); // VIP.PSU.BASE6

		ULONG R00008000 = 0x00000000;
		
		ULONG i = 0;
		for( i = 0 ; i < 100 ; i++ ) {

			R00008000 = SA7160_GetRegister( pDevice, 0x00008000 + 0x0000 );

			if( R00008000 == 0x00000000 ) { break; }

			//wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(25) );
			mdelay(25);

		}
		if( R00008000 == 0x00000000 ) {

			SA7160_SetRegister( pDevice, 0x00008000 + 0x0000, 0x00000007 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0004, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0008, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x000C, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0010, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0014, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0018, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x001C, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0020, 0x00000000 );

			SA7160_SetRegister( pDevice, 0x00008000 + 0x0024, 0x00000007 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0028, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x002C, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0030, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0034, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0038, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x003C, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0040, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0044, 0x00000000 );
		}
	}
	{	// -----> tmHWStreamPort_Audio::tmIPause()
		// 
		ULONG R00007004 = SA7160_GetRegister( pDevice, 0x00006000 + 0x00000004 ); // AIP.CTL
	
		if( R00007004 & 0x40000000 ) {
	
			SA7160_SetRegister( pDevice, 0x00006000 + 0x0000001C, 0x00000000 ); // AIP.SIZE
	
			SA7160_SetRegister( pDevice, 0x00006000 + 0x00000004, R00007004 & 0xBFFFFF0F ); // AIP.CTL
	
			//DELAY_100NS( 250000 );
			//wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 25 ) );
			mdelay(25);


		}
		// -----> tmHWStreamPort_Audio::tmIPause() -----> tmHWStreamPort_Audio::tmSetInternalClock()
		//
		{	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x5C, 0x00000001 ); // CGU.PCR.11
	
			SA7160_SetRegister( pDevice, 0x00013000 + 0x0000 + 0x04 * 11, 0x00000001 ); // CGU.SCR.11
	
			SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 * 11, 0x00000000 ); // CGU.FS1.11
	
			SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x5C, 0x00000001 ); // CGU.ESR.11
		}
		if( R00007004 & 0x40000000 ) {
	
			// -----> tmHWStreamPort_Audio::tmIPause() -----> tmHWStreamPort_Audio::tmISetParameters()
			// 
			// AIP PROGRAMMING (m_pMunit_AudioIn)
			// 
			SA7160_SetRegister( pDevice, 0x00006000 + 0x0004, 0x80000000 ); // AIP.CTL
	
			// BAM PROGRAMMING (m_pMunit_BAM)
			// 
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0168, 0x00000040 ); // BAM.DMA.BUF.MODE
	
			// AIP PROGRAMMING (m_pMunit_AudioIn) (m_pAudio)
			// 
			SA7160_SetRegister( pDevice, 0x00006000 + 0x001C, 0x00000000 ); // AIP.SIZE
	
			ULONG R00007FFC = SA7160_GetRegister( pDevice, 0x00006000 + 0x0FFC ); // AIP.MODULE.ID
	
			if( R00007FFC != 0x010D1200 ) {
	
				;
			}
			LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsUnInitialize( AIP:%08X )\n", pDevice->m_nKsDeviceNumber, R00007FFC );
	
			SA7160_SetRegister( pDevice, 0x00006000 + 0x0008, 0x00000000 ); // AIP.SERIAL
			SA7160_SetRegister( pDevice, 0x00006000 + 0x0004, 0x30000000 ); // AIP.CTL
			SA7160_SetRegister( pDevice, 0x00006000 + 0x000C, 0x00000200 ); // AIP.FRAMING
			SA7160_SetRegister( pDevice, 0x00006000 + 0x0014, 0x01400000 ); // AIP.BASE1
			SA7160_SetRegister( pDevice, 0x00006000 + 0x0018, 0x01400000 ); // AIP.BASE2
	
			ULONG R00008168 = 0x00000000;
			
			ULONG i = 0;
			for( i = 0 ; i < 100 ; i++ ) {
	
				R00008168 = SA7160_GetRegister( pDevice, 0x00008000 + 0x0168 );
	
				if( R00008168 == 0x00000000 ) { break; }
	
				//DELAY_100NS( 250000 );
				//wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 25 ) );
				mdelay(25);

			}
			if( R00008168 == 0x00000000 ) {
	
				SA7160_SetRegister( pDevice, 0x00008000 + 0x0168, 0x00000007 );
				SA7160_SetRegister( pDevice, 0x00008000 + 0x016C, 0x00000000 );
				SA7160_SetRegister( pDevice, 0x00008000 + 0x0170, 0x00000000 );
				SA7160_SetRegister( pDevice, 0x00008000 + 0x0174, 0x00000000 );
				SA7160_SetRegister( pDevice, 0x00008000 + 0x0178, 0x00000000 );
				SA7160_SetRegister( pDevice, 0x00008000 + 0x017C, 0x00000000 );
				SA7160_SetRegister( pDevice, 0x00008000 + 0x0180, 0x00000000 );
				SA7160_SetRegister( pDevice, 0x00008000 + 0x0184, 0x00000000 );
				SA7160_SetRegister( pDevice, 0x00008000 + 0x0188, 0x00000000 );
			}
	    }
		SA7160_SetRegister( pDevice, 0x00006000 + 0x00000020, 0x0000000F );	// AIP.INT.ACKN
	}
	// -----> tmHWStreamPort_Audio::tmIPause()
	// 
	ULONG R00007004 = SA7160_GetRegister( pDevice, 0x00007000 + 0x00000004 ); // AIP.CTL

	if( R00007004 & 0x40000000 ) {

		SA7160_SetRegister( pDevice, 0x00007000 + 0x0000001C, 0x00000000 ); // AIP.SIZE

		SA7160_SetRegister( pDevice, 0x00007000 + 0x00000004, R00007004 & 0xBFFFFF0F ); // AIP.CTL

		//wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(25) );
		mdelay(25);

    }
	// -----> tmHWStreamPort_Audio::tmIPause() -----> tmHWStreamPort_Audio::tmSetInternalClock()
	//
	{	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x60, 0x00000001 ); // CGU.PCR.12

		SA7160_SetRegister( pDevice, 0x00013000 + 0x0000 + 0x04 * 12, 0x00000001 ); // CGU.SCR.12

		SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 * 12, 0x00000000 ); // CGU.FS1.12

		SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x60, 0x00000001 ); // CGU.ESR.12
	}
	if( R00007004 & 0x40000000 ) {

		// -----> tmHWStreamPort_Audio::tmIPause() -----> tmHWStreamPort_Audio::tmISetParameters()
		// 
		// AIP PROGRAMMING (m_pMunit_AudioIn)
		// 
		SA7160_SetRegister( pDevice, 0x00007000 + 0x0004, 0x80000000 ); // AIP.CTL

		// BAM PROGRAMMING (m_pMunit_BAM)
		// 
		SA7160_SetRegister( pDevice, 0x00008000 + 0x018C, 0x00000040 ); // BAM.DMA.BUF.MODE

		// AIP PROGRAMMING (m_pMunit_AudioIn) (m_pAudio)
		// 
		SA7160_SetRegister( pDevice, 0x00007000 + 0x001C, 0x00000000 ); // AIP.SIZE

		ULONG R00007FFC = SA7160_GetRegister( pDevice, 0x00007000 + 0x0FFC ); // AIP.MODULE.ID

		if( R00007FFC != 0x010D1200 ) {

			;
		}
		LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwAnalogComponentsUnInitialize( AIP:%08lX )\n", pDevice->m_nKsDeviceNumber, R00007FFC );

		SA7160_SetRegister( pDevice, 0x00007000 + 0x0008, 0x00000000 ); // AIP.SERIAL
		SA7160_SetRegister( pDevice, 0x00007000 + 0x0004, 0x30000000 ); // AIP.CTL
		SA7160_SetRegister( pDevice, 0x00007000 + 0x000C, 0x00000200 ); // AIP.FRAMING
		SA7160_SetRegister( pDevice, 0x00007000 + 0x0014, 0x01600000 ); // AIP.BASE1 
		SA7160_SetRegister( pDevice, 0x00007000 + 0x0018, 0x01600000 ); // AIP.BASE2

		ULONG R0000818C = 0x00000000;

		ULONG i = 0;
		for( i = 0 ; i < 100 ; i++ ) {

			R0000818C = SA7160_GetRegister( pDevice, 0x00008000 + 0x018C );

			if( R0000818C == 0x00000000 ) { break; }

			//wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(25) );
			mdelay(25);

		}
		if( R0000818C == 0x00000000 ) {

			SA7160_SetRegister( pDevice, 0x00008000 + 0x018C, 0x00000007 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0190, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0194, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x0198, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x019C, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x01A0, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x01A4, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x01A8, 0x00000000 );
			SA7160_SetRegister( pDevice, 0x00008000 + 0x01AC, 0x00000000 );
		}
    }
	SA7160_SetRegister( pDevice, 0x00007000 + 0x00000020, 0x0000000F );	// AIP.INT.ACKN

	// ...

	// ...
	//SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FE0, 0x00000C01 ); // MSI.INT.CLR.SET.L

	//SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FE4, 0x00000000 ); // MSI.INT.CLR.SET.H

#ifdef ENABLE_1920X1080PX60FPS

	if( (pDevice->iManufacturer == 0x01 && pDevice->iProduct == 0x07) ||
					
		(pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) ||
				
		(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) ||
		
		(pDevice->iManufacturer == 0x1A && pDevice->m_nCustomGpioSupportProperty == 8) ||
		
		(pDevice->iManufacturer == 0x1B && pDevice->m_nCustomGpioSupportProperty == 8) ||

		pDevice->iManufacturer == 0x10 ||

		pDevice->iManufacturer == 0x12 ||
		
		pDevice->iManufacturer == 0x13 ||
		
		pDevice->iManufacturer == 0x14 ||
		
		pDevice->iManufacturer == 0x16 ||

		pDevice->iManufacturer == 0x17 ||
		
		pDevice->iManufacturer == 0x18 ) {

		if( p_brother_sys_cfg == NULL ) {

			SA7160_SYS_CFG * p_sys_cfg = (SA7160_SYS_CFG *)(pDevice->m_pCustomSystemConfigProperty);

			ULONG nums = 1;

			if( (p_sys_cfg->n_input_video_resolution_cx == 4096 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
				
				(p_sys_cfg->n_input_video_resolution_cx >= 3840 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
				
				(p_sys_cfg->n_input_video_resolution_cx >= 2800 && p_sys_cfg->n_input_video_resolution_cy == 2100 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
				
				(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 120) ) {

				nums = 3;
			}
			else {

				nums = 1;
			}

			//uninitial all 4 chips in case resolution is not detected
			if(pDevice->iManufacturer == 0x13)
			{
				nums = 3;
			}

			ULONG n = 0;
			
			for( n = 0 ; n < nums ; n++ ) {

				CDevice * p_brother_device = g_pDevice[ pDevice->m_nKsDeviceNumber + n + 1 ];

				if( p_brother_device ) {

					if( p_brother_device->m_nAnalogCaptureStreamPowerReference > 0 ) { break ; } // +SC510N4

					return SA7160_HwAnalogComponentsUnInitialize( p_brother_device, p_sys_cfg );
				}
				if( n == (nums - 1) ) {

					return TRUE;
				}
			}
		}
		else {

			//never come here
			//pDevice->m_hInterruptAccessLock = 0x00000000;

			//SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FE8, 0x00000C01 ); // MSI.INT.CLR.SET.L

			//SA7160_SetRegister( pDevice, 0x0000A000 + 0x00000FEC, 0x00000000 ); // MSI.INT.CLR.SET.H

			//pDevice->m_hInterruptAccessLock = 0x00000001;
		}
	}
#endif

	return SA7160_PowerDownPeripherals( pDevice );
}

BOOLEAN SA7160_PowerDownPeripherals( CDevice * pDevice )
{
	LINUXV4L2_DEBUG( KERN_INFO, "SA7160_PowerDownPeripherals()\n" );

	return TRUE;
}

BOOLEAN SA7160_HwInitialize( CDevice * pDevice )
{
	ULONG i = 0;

	ULONG j = 0;



	pDevice->m_nKsDeviceBusNumber = pDevice->m_pKsDevice->bus->number % 16;

	LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwInitialize()\n", pDevice->m_nKsDeviceNumber );

	pDevice->m_pCustomSystemConfigProperty = (SA7160_SYS_CFG *)wrapper_kmalloc( sizeof(SA7160_SYS_CFG), GFP_KERNEL );

	memset( pDevice->m_pCustomSystemConfigProperty, 0, sizeof(SA7160_SYS_CFG) );

	g_pDevice[ pDevice->m_nKsDeviceNumber ] = pDevice;

	SA7160_SYS_CFG * p_sys_cfg = (SA7160_SYS_CFG *)(pDevice->m_pCustomSystemConfigProperty);

	// CHECK IF BAR0 IS FINE
	//
	// -----> CJetPackDevice::CJetPackDevice()
	//
	{
		DWORD CFG10 = 0x00000000; 

		DWORD CFG14 = 0x00000000; 
		
		wrapper_pci_read_config_dword( pDevice->m_pKsDevice, 0x00000010, &CFG10 );

		wrapper_pci_read_config_dword( pDevice->m_pKsDevice, 0x00000014, &CFG14 );

		if( (pDevice->m_pRegBaseCommonPhysicalBuffer[ 0 ] | 0x00000004) != CFG10 ) {
		
			LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwInitialize() error m_pRegBaseCommonPhysicalBuffer[ 0 ](0x%x)\n", pDevice->m_nKsDeviceNumber, pDevice->m_pRegBaseCommonPhysicalBuffer[ 0 ] );

			if( pDevice->m_pRegBaseCommonPhysicalBuffer[ 0 ] == 0x0000000000000000 ) {	goto ERROR_HARDWARE_INITIALIZE; }

			CFG10 |= 0x00000004;

			wrapper_pci_write_config_dword( pDevice->m_pKsDevice, 0x00000010, CFG10 );

			wrapper_pci_read_config_dword( pDevice->m_pKsDevice, 0x00000010, &CFG10 );

			if( (pDevice->m_pRegBaseCommonPhysicalBuffer[ 0 ] | 0x00000004) != CFG10 ) { goto ERROR_HARDWARE_INITIALIZE; }
		}

		LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwInitialize() CFG10(0x%x) m_pRegBaseCommonPhysicalBuffer[ 0 ](0x%x)\n", pDevice->m_nKsDeviceNumber, CFG10, pDevice->m_pRegBaseCommonPhysicalBuffer[ 0 ] );

	}

	// CGU (CLOCK.SHOP) PROGRAMMING (m_pMunit_CGU) (m_pClockShop)
	//
	// -----> tmClockShop::GetBootScriptSetup()
	// 
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x00 + 0x04 * 6, 0x00000001 ); // CGU.PCR.R00.06 GREG
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x00 + 0x04 * 3, 0x00000001 ); // CGU.PCR.R00.03 PSS_MMU
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x00 + 0x04 * 4, 0x00000001 ); // CGU.PCR.R00.04 PSS_DTL2MTL
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x00 + 0x04 * 5, 0x00000001 ); // CGU.PCR.R00.05 MSI
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x30 + 0x04 * 2, 0x00000001 ); // CGU.PCR.R03.02 I2C
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x3C + 0x04 * 1, 0x00000001 ); // CGU.PCR.R04.01 PHI
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x00 + 0x04 * 7, 0x00000001 ); // CGU.PCR.R00.07 GPIO
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x28 + 0x04 * 1, 0x00000001 ); // CGU.PCR.R02.01 SPI
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x20 + 0x04 * 1, 0x00000001 ); // CGU.PCR.R01.01 DCS
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x30 + 0x04 * 1, 0x00000001 ); // CGU.PCR.R03.01 BOOT

    // [PSS   = 00] 00013218
    // [DCS   = 01] 0001321C
    // [SPI   = 02] 00013220
    // [I2C   = 03] 00013224
    // [PHI   = 04] 00013228
    // [VIP0  = 05] 0001322C
    // [VIP1  = 06] 00013230
    // [FGPI0 = 07] 00013234
    // [FGPI1 = 08] 00013238
    // [FGPI2 = 09] 0001323C
    // [FGPI3 = 10] 00013240
    // [AI0   = 11] 00013244
    // [AI1   = 12] 00013248
    // [PHY   = 13] 0001324C
	// 
	p_sys_cfg->n_min_frequency = C_PLL_FREQ / 255;

	p_sys_cfg->n_max_frequency = C_PLL_FREQ;

	if( (C_PLL_FREQ) > (p_sys_cfg->n_min_frequency * 255) ) {

		p_sys_cfg->n_min_frequency++;
	}
	for( i = 0 ; i < C_CGU_CLKS ; i++ ) {

		CHAR N = 0;

		SHORT M = 0;

		p_sys_cfg->n_boot_clock_divider[ i ] = SA7160_GetRegister( pDevice, 0x00013000 + 0x0218 + 0x04 * i ); // CGU.FDC.R**

        p_sys_cfg->n_current_clock_divider[ i ] = p_sys_cfg->n_boot_clock_divider[ i ];

        N = (CHAR)((p_sys_cfg->n_current_clock_divider[ i ] >> 11) & 0xFF);

        N *= -1;

        M = (CHAR)((p_sys_cfg->n_current_clock_divider[ i ] >>  3) & 0xFF);

		M += N;

        if( M > 0 ) {

            p_sys_cfg->n_frequency_table[ i ] = (((ULONG)(N)) * C_PLL_FREQ) / ((ULONG)(M));
        }
        else {

            p_sys_cfg->n_frequency_table[ i ] = 0;
        }
	}

	// -----> tmClockShop::tmSetInternalClock( STREAM_PORT_ALL )
	// 
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x44, 0x00000001 ); // CGU.PCR.R05 VIP 0
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x48, 0x00000001 ); // CGU.PCR.R06 VIP 1
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x4C, 0x00000001 ); // CGU.PCR.R07 FGPI 0
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x50, 0x00000001 ); // CGU.PCR.R08 FGPI 1
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x54, 0x00000001 ); // CGU.PCR.R09 FGPI 2
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x58, 0x00000001 ); // CGU.PCR.R10 FGPI 3
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x5C, 0x00000001 ); // CGU.PCR.R11 AI0
	SA7160_SetRegister( pDevice, 0x00013000 + 0x00E0 + 0x60, 0x00000001 ); // CGU.PCR.R12 AI1

	SA7160_SetRegister( pDevice, 0x00013000 + 0x0000 + 0x04 *  5, 0x00000001 ); // CGU.SCR.05 VIP 0
	SA7160_SetRegister( pDevice, 0x00013000 + 0x0000 + 0x04 *  6, 0x00000001 ); // CGU.SCR.06 VIP 1
	SA7160_SetRegister( pDevice, 0x00013000 + 0x0000 + 0x04 *  7, 0x00000001 ); // CGU.SCR.07 FGPI 0
	SA7160_SetRegister( pDevice, 0x00013000 + 0x0000 + 0x04 *  8, 0x00000001 ); // CGU.SCR.08 FGPI 1
	SA7160_SetRegister( pDevice, 0x00013000 + 0x0000 + 0x04 *  9, 0x00000001 ); // CGU.SCR.09 FGPI 2
	SA7160_SetRegister( pDevice, 0x00013000 + 0x0000 + 0x04 * 10, 0x00000001 ); // CGU.SCR.10 FGPI 3
	SA7160_SetRegister( pDevice, 0x00013000 + 0x0000 + 0x04 * 11, 0x00000001 ); // CGU.SCR.11 AI0
	SA7160_SetRegister( pDevice, 0x00013000 + 0x0000 + 0x04 * 12, 0x00000001 ); // CGU.SCR.12 AI1

	SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 *  5, 0x00000000 ); // CGU.FS1.05 VIP 0
	SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 *  6, 0x00000000 ); // CGU.FS1.06 VIP 1
	SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 *  7, 0x00000000 ); // CGU.FS1.07 FGPI 0
	SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 *  8, 0x00000000 ); // CGU.FS1.08 FGPI 1
	SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 *  9, 0x00000000 ); // CGU.FS1.09 FGPI 2
	SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 * 10, 0x00000000 ); // CGU.FS1.10 FGPI 3
	SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 * 11, 0x00000000 ); // CGU.FS1.11 AI0
	SA7160_SetRegister( pDevice, 0x00013000 + 0x0038 + 0x04 * 12, 0x00000000 ); // CGU.FS1.12 AI1

	SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x44, 0x00000001 ); // CGU.ESR.05 VIP 0
	SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x48, 0x00000001 ); // CGU.ESR.06 VIP 1
	SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x4C, 0x00000001 ); // CGU.ESR.07 FGPI 0
	SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x50, 0x00000001 ); // CGU.ESR.08 FGPI 1
	SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x54, 0x00000001 ); // CGU.ESR.09 FGPI 2
	SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x58, 0x00000001 ); // CGU.ESR.10 FGPI 3
	SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x5C, 0x00000001 ); // CGU.ESR.11 AI0
	SA7160_SetRegister( pDevice, 0x00013000 + 0x01B0 + 0x60, 0x00000001 ); // CGU.ESR.12 AI1

	wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(10) );

	// GREG PROGRAMMING (m_pMunit_GREG)

	// GPIO PROGRAMMING (m_pMunit_GPIO) (m_pGPIOLayer)
	//
	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0FF0, 0x00000001 ); // GPIO.SW.RST

	// PHI PROGRAMMING (m_pMunit_SPI) (m_pSPILayer) (None)

	// PHI PROGRAMMING (m_pMunit_PHI) (m_pPHILayer) (None)
	//
	SA7160_SetRegister( pDevice, 0x0000F000 + 0x0FF0, 0x00000001 ); // PHI.SW.RST

	// DCS PROGRAMMING (m_pMunit_DCS)

	// I2C PROGRAMMING (m_pMunit_I2C) (m_pI2CLayer)
	//
	for( i = 0 ; i < 1 ; i++ ) {

		ULONG R0000B008 = 0x00000000;

		ULONG R0000B00C = 0x00000000;

		ULONG R0000BFE4 = 0x00000000;

		// -----> CI2CLayer_IP3204::Init()
		//
		for( j = 0 ; j < 100 ; j++ ) {

			R0000B008 = SA7160_GetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0008 ); // I2C.STATUS

			if( (R0000B008 & 0x0F) == 0x0D ) {

				break;
			}
			wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(1) );
		}
		if( (R0000B008 & 0x0F) != 0x0D ) { ; }

		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x000C, 0x000000CC ); // I2C.CONTROL

		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0FD8, 0x00001FFF ); // I2C.INT.CLR.ENABLE

		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0FE8, 0x00001FFF ); // I2C.INT.CLR.STATUS

		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x000C, 0x000000C1 ); // I2C.CONTROL

		for( j = 0 ; j < 100 ; j++ ) {

			R0000B00C = SA7160_GetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x000C ); // I2C.CONTROL

			if( R0000B00C == 0x000000C0 ) {

				break;
			}
			wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(1) );
		}
		if( R0000B00C != 0x000000C0 ) { goto ERROR_HARDWARE_INITIALIZE; }

		R0000B008 = SA7160_GetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0008 ); // I2C.STATUS

		if( (R0000B008 & 0x00000008) == 0x00 ) {

			SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x000C, 0x000000C0 ); // CONTROL

			wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(1) );

			for( j = 0 ; j < 9 ; j++ ) {

				SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x000C, 0x00000040 ); // CONTROL

				wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(1) );

				SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x000C, 0x000000C0 ); // CONTROL

				wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(1) );
			}
		}
//		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0010, 0x00000068 ); // CLOCK.DIVISOR.HIGH

//		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0014, 0x00000087 ); // CLOCK.DIVISOR.LOW

//		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0028, 0x00000060 ); // SDA.HOLD

		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0010, 0x00000104 ); // CLOCK.DIVISOR.HIGH (40K)

		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0014, 0x00000151 ); // CLOCK.DIVISOR.LOW (40K)

		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0028, 0x000000C0 ); // SDA.HOLD (40K)

		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0FD8, 0x00001FFF ); // INT.CLR.ENABLE

		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0FE8, 0x00001FFF ); // INT.CLR.STATUS

		SA7160_SetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0FDC, 0x000000C7 ); // INT.SET.ENABLE

		R0000BFE4 = SA7160_GetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0FE4 ); // INT.ENABLE

		if( R0000BFE4 != 0x000000C7 ) { goto ERROR_HARDWARE_INITIALIZE; }

		R0000B008 = SA7160_GetRegister( pDevice, 0x0000B000 + i * 0x00001000 + 0x0008 ); // STATUS

		if( (R0000B008 & 0x0F) != 0x0D ) { goto ERROR_HARDWARE_INITIALIZE; }

		LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwInitialize( I2C:%08lX:%08lX:%08lX )\n", pDevice->m_nKsDeviceNumber, R0000B008, R0000B00C, R0000BFE4 );
	}

	// MSI PROGRAMMING (m_pMunit_MSI) (m_pHWInterrupts)
	//
	// -----> tmHWInterrupts_mUncle::tmInitMSI()
	//
	ULONG R0000AFFC = SA7160_GetRegister( pDevice, 0x0000A000 + 0x0FFC ); // MSI.MODULE.ID

	if( R0000AFFC != 0x00030100 ) { ; }

	SA7160_SetRegister( pDevice, 0x0000A000 + 0x0000, 0x00000000 ); // MSI.DELAY.TIMER

	SA7160_SetRegister( pDevice, 0x0000A000 + 0x0004, 0x00000001 ); // MSI.INTA.POLARITY

	for( i = 0 ; i < 49 ; i++ ) {

		SA7160_SetRegister( pDevice, 0x0000A000 + 0x0008 + 0x04 * i, 0x01000000 ); // MSI.CONFIG
	}
	ULONG R0000A0FD8 = SA7160_GetRegister( pDevice, 0x0000A000 + 0x0FD8 ); // MSI.INT.ENA.L

	ULONG R0000A0FDC = SA7160_GetRegister( pDevice, 0x0000A000 + 0x0FDC ); // MSI.INT.ENA.H

	ULONG R0000A0FC0 = SA7160_GetRegister( pDevice, 0x0000A000 + 0x0FC0 ); // MSI.INT.STATUS.L

	ULONG R0000A0FC4 = SA7160_GetRegister( pDevice, 0x0000A000 + 0x0FC4 ); // MSI.INT.STATUS.H

	for( i = 0 ; i < 2 ; i++ ) {

		if( R0000A0FC0 ) { SA7160_SetRegister( pDevice, 0x0000A000 + 0x0FC8, R0000A0FC0 ); } // MSI.INT.STATUS.CLR.L

		if( R0000A0FC4 ) { SA7160_SetRegister( pDevice, 0x0000A000 + 0x0FCC, R0000A0FC4 ); } // MSI.INT.STATUS.CLR.H

		if( R0000A0FD8 ) { SA7160_SetRegister( pDevice, 0x0000A000 + 0x0FE0, R0000A0FD8 ); } // MSI.INT.ENA.CLR.L

		if( R0000A0FDC ) { SA7160_SetRegister( pDevice, 0x0000A000 + 0x0FE4, R0000A0FDC ); } // MSI.INT.ENA.CLR.H

		wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(5) );

		R0000A0FD8 = SA7160_GetRegister( pDevice, 0x0000A000 + 0x0FD8 ); // MSI.INT.ENA.L

		R0000A0FDC = SA7160_GetRegister( pDevice, 0x0000A000 + 0x0FDC ); // MSI.INT.ENA.H

		R0000A0FC0 = SA7160_GetRegister( pDevice, 0x0000A000 + 0x0FC0 ); // MSI.INT.STATUS.L

		R0000A0FC4 = SA7160_GetRegister( pDevice, 0x0000A000 + 0x0FC4 ); // MSI.INT.STATUS.H
	}
	if( R0000A0FD8 != 0x00000000 ) { ; }

	if( R0000A0FDC != 0x00000000 ) { ; }

	if( R0000A0FC0 != 0x00000000 ) { ; }

	if( R0000A0FC4 != 0x00000000 ) { ; }

	LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwInitialize( MSI:%08lX:%08lX:%08lX:%08lX:%08lX )\n", pDevice->m_nKsDeviceNumber, R0000AFFC, R0000A0FD8, R0000A0FDC, R0000A0FC0, R0000A0FC4 );

	// DCS PROGRAMMING (m_pMunit_DCS)
	// 
	SA7160_SetRegister( pDevice, 0x00014000 + 0x0000, 0x00000016 ); // DCS.CTRL

	// MSI PROGRAMMING (m_pMunit_MSI)
	// 
	SA7160_SetRegister( pDevice, 0x0000A000 + 0x0FF0, 0x00000001 ); // MSI.SW.RST

	// MMU PROGRAMMING (m_pMunit_MMU)
	// 
	SA7160_SetRegister( pDevice, 0x00009000 + 0x0FF0, 0x00000001 ); // MMU.SW.RST

	// BAM PROGRAMMING (m_pMunit_BAM)
	// 
	SA7160_SetRegister( pDevice, 0x00008000 + 0x0FF0, 0x00000001 ); // BAM.RST

	// MMU PROGRAMMING (m_pMunit_MMU)
	// 
	SA7160_SetRegister( pDevice, 0x00009000 + 0x0000, 0x00000014 ); // MMU.MODE

	// OTHERS
	// 
	// -----> tmHWStreamPort_VIP_Video::tmHWStreamPort_VIP_Video()
	// 
	SA7160_SetRegister( pDevice, 0x00000000 + 0x0000, 0x00010000 ); // VIP.MODE
	
	// -----> tmHWStreamPort_VIP_Video::InitPageTables()
	// 
	{	ULONG i = 0 ; 

		ULONGLONG memory_physical_address = pDevice->m_pDmaBaseCommonPhysicalBuffer[ 0 ];
		
		SA7160_SetRegister( pDevice, 0x00009000 + 0x0004, 0x00000007 ); // MMU.DMA.CONFIG
	
		SA7160_SetRegister( pDevice, 0x00009000 + 0x0008, 0x00000007 ); // MMU.DMA.CONFIG
				
		for( i = 0 ; i < 8 ; i++ ) {

			UINT R00009044 = (UINT)((memory_physical_address >>  0) & 0xFFFFFFFF);

			UINT R00009048 = (UINT)((memory_physical_address >> 32) & 0xFFFFFFFF);

			SA7160_SetRegister( pDevice, 0x00009000 + 0x0044 + 0x08 * i, R00009044 ); // MMU.PTA.LX

			SA7160_SetRegister( pDevice, 0x00009000 + 0x0048 + 0x08 * i, R00009048 ); // MMU.PTA.LX

			memory_physical_address += 4096;

			R00009044 = (UINT)((memory_physical_address >>  0) & 0xFFFFFFFF);

			R00009048 = (UINT)((memory_physical_address >> 32) & 0xFFFFFFFF);

			SA7160_SetRegister( pDevice, 0x00009000 + 0x0084 + 0x08 * i, R00009044 ); // MMU.PTA.LX

			SA7160_SetRegister( pDevice, 0x00009000 + 0x0088 + 0x08 * i, R00009048 ); // MMU.PTA.LX

			memory_physical_address += 4096;
		}
	}
	LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwInitialize() finish  tmHWStreamPort_VIP_Video::tmHWStreamPort_VIP_Video()\n", pDevice->m_nKsDeviceNumber );

	// -----> tmHWStreamPort_Audio::InitPageTables()
	// 
	{	ULONG i = 0 ;
			
		ULONGLONG memory_physical_address = pDevice->m_pDmaBaseCommonPhysicalBuffer[ 1 ];

		SA7160_SetRegister( pDevice, 0x00009000 + 0x002C, 0x00000007 ); // MMU.DMA.CONFIG
		
		for( i = 0 ; i < 8 ; i++ ) {

			UINT R000092C4 = (UINT)((memory_physical_address >>  0) & 0xFFFFFFFF);

			UINT R000092C8 = 0;

			SA7160_SetRegister( pDevice, 0x00009000 + 0x02C4 + 0x08 * i, R000092C4 ); // MMU.PTA.LX

			SA7160_SetRegister( pDevice, 0x00009000 + 0x02C8 + 0x08 * i, R000092C8 ); // MMU.PTA.LX

			memory_physical_address += 4096;
		}
	}
	{	ULONG i = 0 ;
			
		ULONGLONG memory_physical_address = pDevice->m_pDmaBaseCommonPhysicalBuffer[ 1 ];

		SA7160_SetRegister( pDevice, 0x00009000 + 0x0030, 0x00000007 ); // MMU.DMA.CONFIG
		
		for( i = 0 ; i < 8 ; i++ ) {

			UINT R00009304 = (UINT)((memory_physical_address >>  0) & 0xFFFFFFFF);

			UINT R00009308 = 0;

			SA7160_SetRegister( pDevice, 0x00009000 + 0x0304 + 0x08 * i, R00009304 ); // MMU.PTA.LX

			SA7160_SetRegister( pDevice, 0x00009000 + 0x0308 + 0x08 * i, R00009308 ); // MMU.PTA.LX

			memory_physical_address += 4096;
		}
	}
	LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwInitialize() finish  tmHWStreamPort_Audio::InitPageTables()\n", pDevice->m_nKsDeviceNumber );

	// GPIO PROGRAMMING (m_pMunit_GPIO) (m_pGPIOLayer)
	//
	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0008, 0x00000000 ); // GPIO.WR.MODE (BY PROGRAMMING IT, GPIO PIN ALSO CAN BE USED AS PHI INTERFACE)

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, 0x00000000 ); // GPIO.WR

	SA7160_SetRegister( pDevice, 0x0000E000 + 0x000C, 0xFBEC3F93 ); // GPIO.OEN

	// GREG PROGRAMMING (m_pMunit_GREG)
	//
	SA7160_SetRegister( pDevice, 0x00012000 + 0x0010, 0x06080F8C ); // GREG.VIP.CTRL

	SA7160_SetRegister( pDevice, 0x00012000 + 0x0014, 0x00000321 ); // GREG.FGPI.CTRL

	SA7160_SetRegister( pDevice, 0x00012000 + 0x0028, 0x00000000 ); // GREG.VIP.PORT.CTRL

	LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwInitialize() iManufacturer(0x%x)\n", pDevice->m_nKsDeviceNumber, pDevice->iManufacturer );

	if( pDevice->iManufacturer == 0x0A ||

		pDevice->iManufacturer == 0x0D ||

		pDevice->iManufacturer == 0x18 ||

		pDevice->iManufacturer == 0x1A ) {

		SA7160_SetRegister( pDevice, 0x00012000 + 0x000C, 0x00000C00 ); // GREG.PMCSR.DATA.2 (08.BITS)
	}
	else {

	//	SA7160_SetRegister( pDevice, 0x00012000 + 0x000C, 0x00000300 ); // GREG.PMCSR.DATA.2 (10.BITS)

		SA7160_SetRegister( pDevice, 0x00012000 + 0x000C, 0x00000C00 ); // GREG.PMCSR.DATA.2 (08.BITS)
	}
//	// GPIO PROGRAMMING (m_pMunit_GPIO) (m_pGPIOLayer)
//	//
//	ULONG R0000A008 = SA7160_GetRegister( pDevice, 0x0000A000 + 0x0008 + 0x04 * i ); // MSI.CONFIG
//  
//	SA7160_SetRegister( pDevice, 0x0000A000 + 0x0008 + 0x04 * i, R0000A008 ); // MSI.CONFIG (RISING.EDGE = 0x01000000 / FALLING.EDGE = 0x02000000 / ANY.EDGE = 0x03000000)
//  
//	ULONGLONG INTERRUPTS = (0x0000000000000001 << i);
//  
//	ULONG R0000A0FE8 = (ULONG)((INTERRUPTS >>  0) & (0xFFFFFFFF));
//  
//	ULONG R0000A0FEC = (ULONG)((INTERRUPTS >> 32) & (0xFFFFFFFF));
//  
//	SA7160_SetRegister( pDevice, 0x0000A000 + 0x0FE8, R0000A0FE8 ); // MSI.INT.ENA.SET.L
//  
//	SA7160_SetRegister( pDevice, 0x0000A000 + 0x0FEC, R0000A0FEC ); // MSI.INT.ENA.SET.H
//  
//	ULONG R0000A0FC0 = SA7160_GetRegister( pDevice, 0x0000A000 + 0x0FC0 ); // MSI.INT.STATUS.L
//  
//	ULONG R0000A0FC4 = SA7160_GetRegister( pDevice, 0x0000A000 + 0x0FC4 ); // MSI.INT.STATUS.H
//  
//	if( R0000A0FC0 == 0x00000000 && R0000A0FC4 == 0x00000000 ) { return FALSE ; }
//  
//	if( R0000A0FC0 == 0xFFFFFFFF && R0000A0FC4 == 0xFFFFFFFF ) { return FALSE ; }
//  
//	if( R0000A0FC0 ) { SA7160_SetRegister( pDevice, 0x0000A000 + 0x0FC8, R0000A0FC0 ); } // MSI.INT.STATUS.CLR.L
//  
//	if( R0000A0FC4 ) { SA7160_SetRegister( pDevice, 0x0000A000 + 0x0FCC, R0000A0FC4 ); } // MSI.INT.STATUS.CLR.H

	pDevice->m_nAnalogVideoDecoderStatusProperty = 0;

	if( pDevice->iManufacturer == 0x19 ) { // SC510N1.2ND

		;
	}
	else if( pDevice->iManufacturer == 0x0A ||

			 pDevice->iManufacturer == 0x0D ||

			 pDevice->iManufacturer == 0x18 ||
		
			 pDevice->iManufacturer == 0x1A ) {

		SA7160_ITE6603_HwInitialize( pDevice );
	}
	else if( pDevice->iManufacturer == 0x13 ) { // SC510N2.HDMI.4K2K.ADV7619

		SA7160_ADV7619_HwInitialize( pDevice );
	}
	else if( (pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x01) ||
				   
			 (pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x04) ||
				   
			 (pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x06) ||
			   
			 (pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x07) ||
			   
			 (pDevice->iProduct == 0xF5 && pDevice->iManufacturer == 0x02) ||
				   
			 (pDevice->iManufacturer == 0x08) ||
				   
			 (pDevice->iManufacturer == 0x12) ||

			 (pDevice->iManufacturer == 0x14) ||

			 (pDevice->iManufacturer == 0x1B) ||
				   
			 (pDevice->iManufacturer == 0x1C) ) {

		SA7160_GV7601_HwInitialize( pDevice );
	}
	else {

		if( pDevice->m_nAnalogCrossbarVideoInputProperty == 5 ) { // COMPOSITE

			SA7160_TW9910_HwInitialize( pDevice );

			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x02, 0x0040 );

			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x06, 0x0042 );
		}
		else if( pDevice->m_nAnalogCrossbarVideoInputProperty == 6 ) { // SVIDEO

			SA7160_TW9910_HwInitialize( pDevice );

			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x02, 0x0054 );

			SA7160_SetAnalogVideoDecoderRegister( pDevice, 0x06, 0x0040 );
		}
		else if( pDevice->m_nAnalogCrossbarVideoInputProperty == 4 ) {

			SA7160_GV7601_HwInitialize( pDevice );
		}
		else {

			MST3367_HwInitialize( pDevice );
		}
	}
	if( pDevice->iManufacturer != 0x09 ) { // SC502N1.MC.ADV7181

		ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 );

		if( pDevice->m_nAnalogCrossbarVideoInputProperty == 0 ||  // HDMI (TMDS.B)

			pDevice->m_nAnalogCrossbarVideoInputProperty == 1 ||  // DVI.DIGITAL (TMDS.A)

			pDevice->m_nAnalogCrossbarVideoInputProperty == 4 ) { // SDI

			if( pDevice->m_nAnalogCrossbarAudioInputProperty == 0 ) {

				R0000E004 |=  (1 << 5); // I2S.SEL = 1
			}
			if( pDevice->m_nAnalogCrossbarAudioInputProperty == 1 ) {

				R0000E004 &= ~(1 << 5); // I2S.SEL = 0

				R0000E004 |=  (1 << 3); // CLK.SEL1 = HIGH, USE CLOCK FROM OSC
			}
		}
		if( pDevice->m_nAnalogCrossbarVideoInputProperty == 2 ||  // COMPONENT

			pDevice->m_nAnalogCrossbarVideoInputProperty == 3 ||  // DVI.ANALOG

			pDevice->m_nAnalogCrossbarVideoInputProperty == 5 ||  // COMPOSITE

			pDevice->m_nAnalogCrossbarVideoInputProperty == 6 ) { // SVIDEO

			R0000E004 &= ~(1 << 5); // I2S.SEL = 0

			R0000E004 |= (1 << 3); // CLK.SEL1 = HIGH, USE CLOCK FROM OSC
		}
		SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );
	}

	BOOL is_main_chip = FALSE;

#ifdef SA7160_COPYPORTECT_ARCHITECTURE

	{	
//		SA7160_SetRegister( pDevice, 1, 0x00700000 + 0x00000008, 0x0000000C ); // GPIO
		
		struct timeval ts; wrapper_do_gettimeofday( &ts );

		BYTE codes[ 4 ] = { ((ts.tv_usec / 1) % 0xFF), ((ts.tv_usec / 10) % 0xFF), ((ts.tv_usec / 100) % 0xFF), ((ts.tv_usec / 1000) % 0xFF) };

		BYTE keys[ 4 ] = { 0x00, 0x00, 0x00, 0x00 };

		ULONGLONG delay = 125; // 100NS

		SA7160_I2C_START( pDevice, delay ); SA7160_I2C_WRITE_BYTE( pDevice, 0xA2, delay ); SA7160_I2C_WRITE_BYTE( pDevice, 0x13, delay ); SA7160_I2C_WRITE_BYTE( pDevice, codes[ 0 ], delay ); SA7160_I2C_WRITE_BYTE( pDevice, codes[ 1 ], delay ); SA7160_I2C_WRITE_BYTE( pDevice, codes[ 2 ], delay ); SA7160_I2C_WRITE_BYTE( pDevice, codes[ 3 ], delay ); SA7160_I2C_STOP( pDevice, delay ); 

		wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies( 100 ) );

		SA7160_I2C_START( pDevice, delay ); SA7160_I2C_WRITE_BYTE( pDevice, 0xA3, delay ); keys[ 0 ] = SA7160_I2C_READ_BYTE( pDevice, 0, delay ); keys[ 1 ] = SA7160_I2C_READ_BYTE( pDevice, 0, delay ); keys[ 2 ] = SA7160_I2C_READ_BYTE( pDevice, 0, delay ); keys[ 3 ] = SA7160_I2C_READ_BYTE( pDevice, 0, delay ); SA7160_I2C_STOP( pDevice, delay ); 

		LINUXV4L2_DEBUG( KERN_INFO, "【CODE = %08X | KEY = %08X】\n", *((DWORD *)(codes)), *((DWORD *)(keys)) );

		if( (*((DWORD *)(keys)) != 0x00000000) && (*((DWORD *)(keys)) != 0xFFFFFFFF) ) {

			g_copy_protect_unlock_boradsA[ pDevice->m_nKsDeviceBusNumber ] = 1;

			g_copy_protect_unlock_boradsB[ pDevice->m_nKsDeviceBusNumber ] = 1;

		}
	}

#endif
	//
	// 
	if( pDevice->iManufacturer == 0x1C ) { // SC520Q4
		/*
		ULONG R = pDevice->m_nCustomGpioDirectionProperty & 0xFFFF;
		
		R = ~R; // INPUT PIN IS ALWAYS HIGH

		R |= pDevice->m_nCustomGpioDataProperty & 0xFFFF;

		BYTE TXL[ 2 ] = { 0x40, (BYTE)(R >> 0) }; SA7160_SetSlaveDeviceRegister( pDevice, 0, TXL, 2 );

		BYTE TXH[ 2 ] = { 0x42, (BYTE)(R >> 8) }; SA7160_SetSlaveDeviceRegister( pDevice, 0, TXH, 2 );

		DELAY_100NS( 1250000 );

		KeInitializeTimer( &pDevice->m_hCustomTimer );

		KeInitializeDpc( &pDevice->m_hCustomTimerDPC, (PKDEFERRED_ROUTINE)(SA7160_ON_TIME_DELAY), pDevice );
		*/
	}
	else {

		if( (pDevice->iManufacturer == 0x01 && pDevice->iProduct == 0x07) || // EURESYS.SC510N1.1ST
				
			(pDevice->iManufacturer == 0x10) ) { // SC510N1.1ST
			/*
			SA7160_SetFpgaRegister( pDevice, 0x11, (BYTE)((~(pDevice->m_nCustomGpioDirectionProperty >> 0)) & 0xFF) );

			SA7160_SetFpgaRegister( pDevice, 0x01, (BYTE)((pDevice->m_nCustomGpioDataProperty >> 0) & 0xFF) );

			{	BYTE R = (BYTE)((pDevice->m_nCustomGpioDirectionProperty & 0x0000FF00) >> 8); 

				R = ~R; // INPUT PIN IS ALWAYS HIGH

				R |= (BYTE)((pDevice->m_nCustomGpioDataProperty & 0x0000FF00) >> 8);

				BYTE TX[ 2 ] = { 0x40, R };
				
				SA7160_SetSlaveDeviceRegister( pDevice, 1, TX, 2 );
			}
			if( is_main_chip ) {

				pDevice->m_nCustomGpioSupportProperty = 16;
			}
			*/
		}
		else if( (pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST
				
				 (pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST

				 (pDevice->iManufacturer == 0x12) ||  // SC510N1.SDI.1ST

				 (pDevice->iManufacturer == 0x14) ||  // SC510N1.SDI.1ST

				 (pDevice->iManufacturer == 0x16) ||  // SC512N1.DVI.1ST

				 (pDevice->iManufacturer == 0x17) ||  // SC512N1.DVI.1ST

				 (pDevice->iManufacturer == 0x18) ||  // SC510N1.HDMI.ITE6603.1ST
			
				 (pDevice->iManufacturer == 0x1A) ||  // SC510N4.HDMI.ITE6603
			
				 (pDevice->iManufacturer == 0x1B) ) { // SC510N4.SDI

			BOOLEAN returns = TRUE;
				
			returns = SA7160_SetFpgaRegister( pDevice, 0x11, (BYTE)((~(pDevice->m_nCustomGpioDirectionProperty >> 0)) & 0xFF) );

			returns = SA7160_SetFpgaRegister( pDevice, 0x01, (BYTE)((pDevice->m_nCustomGpioDataProperty >> 0) & 0xFF) );

			if( returns ) {
				
				pDevice->m_nCustomGpioSupportProperty = 8;
			}
		}
		else {

			SA7160_SetFpgaRegister( pDevice, 0x10, (BYTE)((~(pDevice->m_nCustomGpioDirectionProperty >> 0)) & 0xFF) );

			SA7160_SetFpgaRegister( pDevice, 0x11, (BYTE)((~(pDevice->m_nCustomGpioDirectionProperty >> 8)) & 0xFF) );

			SA7160_SetFpgaRegister( pDevice, 0x00, (BYTE)((pDevice->m_nCustomGpioDataProperty >> 0) & 0xFF) );

			SA7160_SetFpgaRegister( pDevice, 0x01, (BYTE)((pDevice->m_nCustomGpioDataProperty >> 8) & 0xFF) );

			if( is_main_chip ) {

				pDevice->m_nCustomGpioSupportProperty = 16;
			}
		}
	}

	LINUXV4L2_DEBUG( KERN_INFO, "[%02d] m_nCustomGpioSupportProperty(0d%d)\n", pDevice->m_nKsDeviceNumber, pDevice->m_nCustomGpioSupportProperty);

	//create 100% YCbCr colorbar pattern
	if(pDevice->m_nKsDeviceNumber == 0)
	{
		BYTE* color_array = COLOR_BAR_720;

		for(i = 0; i < 4; i ++)
		{
			int index = 0;
			int color_segment = sizeof(COLOR_BAR_720)/8;
			
			if( i == 0)
			{
				color_segment = sizeof(COLOR_BAR_720)/8;
				color_array = COLOR_BAR_720;
			}
			else if ( i == 1 )
			{
				color_segment = sizeof(COLOR_BAR_1280)/8;
				color_array = COLOR_BAR_1280;
			}
			else if( i == 2)
			{
				color_segment = sizeof(COLOR_BAR_1920)/8;
				color_array = COLOR_BAR_1920;
			}
			else
			{
				color_segment = sizeof(COLOR_BAR_3840)/8;
				color_array = COLOR_BAR_3840;
			}


			
			//white
			for( index = 0 ; index < color_segment; index++ )
			{
				if( (index % 4 == 0) || (index % 4 == 2) )
				{
					*(color_array + index) = 235;
				}
				if( index % 4 == 1 )
				{
					*(color_array + index) = 128;
				}

				if( index % 4 == 3)
				{
					*(color_array + index) = 128;
				}
			}
			//yellow
			for( index = color_segment ; index < color_segment * 2; index++ )
			{
				if( (index % 4 == 0) || (index % 4 == 2) )
				{
					*(color_array + index) = 210;
				}
				if( index % 4 == 1 )
				{
					*(color_array + index) = 16;
				}

				if( index % 4 == 3)
				{
					*(color_array + index) = 146;
				}
			}
			//cyan
			for( index = color_segment*2 ; index < color_segment * 3; index++ )
			{
				if( (index % 4 == 0) || (index % 4 == 2) )
				{
					*(color_array + index) = 170;
				}
				if( index % 4 == 1 )
				{
					*(color_array + index) = 166;
				}

				if( index % 4 == 3)
				{
					*(color_array + index) = 16;
				}
			}
			//green
			for( index = color_segment*3 ; index < color_segment * 4; index++ )
			{
				if( (index % 4 == 0) || (index % 4 == 2) )
				{
					*(color_array + index) = 145;
				}
				if( index % 4 == 1 )
				{
					*(color_array + index) = 54;
				}

				if( index % 4 == 3)
				{
					*(color_array + index) = 34;
				}
			}
			//magenta
			for( index = color_segment*4 ; index < color_segment * 5; index++ )
			{
				if( (index % 4 == 0) || (index % 4 == 2) )
				{
					*(color_array + index) = 107;
				}
				if( index % 4 == 1 )
				{
					*(color_array + index) = 202;
				}

				if( index % 4 == 3)
				{
					*(color_array + index) = 221;
				}
			}
			//red
			for( index = color_segment*5 ; index < color_segment * 6; index++ )
			{
				if( (index % 4 == 0) || (index % 4 == 2) )
				{
					*(color_array + index) = 82;
				}
				if( index % 4 == 1 )
				{
					*(color_array + index) = 90;
				}

				if( index % 4 == 3)
				{
					*(color_array + index) = 240;
				}
			}
			//blue
			for( index = color_segment*6 ; index < color_segment * 7; index++ )
			{
				if( (index % 4 == 0) || (index % 4 == 2) )
				{
					*(color_array + index) = 41;
				}
				if( index % 4 == 1 )
				{
					*(color_array + index) = 240;
				}

				if( index % 4 == 3)
				{
					*(color_array + index) = 110;
				}
			}
			//black
			for( index = color_segment*7 ; index < color_segment * 8; index++ )
			{
				if( (index % 4 == 0) || (index % 4 == 2) )
				{
					*(color_array + index) = 16;
				}
				if( index % 4 == 1 )
				{
					*(color_array + index) = 128;
				}

				if( index % 4 == 3)
				{
					*(color_array + index) = 128;
				}
			}
		}

		//create black line
		color_array = BLACK_LINE_3840;

		for(i = 0; i < 3840 * 2; i++)
		{
			if( (i % 4 == 0) || (i % 4 == 2) )
			{
				*(color_array + i) = 16;
			}
			if( i % 4 == 1 )
			{
				*(color_array + i) = 128;
			}

			if( i % 4 == 3)
			{
				*(color_array + i) = 128;
			}
		}



	}
	SA7160_HARDWARE_I2C_RESET( pDevice );

//	SA7160_START_THREAD();

	SA7160_StartControlPanelAnalysisThread( pDevice );

	return SA7160_PowerDownPeripherals( pDevice );

ERROR_HARDWARE_INITIALIZE:

//	SA7160_START_THREAD();
	SA7160_StartControlPanelAnalysisThread( pDevice );

	return FALSE;
}

BOOLEAN SA7160_HwUnInitialize( CDevice * pDevice )
{
	ULONG i = 0 ;
	
	SA7160_SYS_CFG * p_sys_cfg = (SA7160_SYS_CFG *)(pDevice->m_pCustomSystemConfigProperty);

	LINUXV4L2_DEBUG( KERN_INFO, "%02d] SA7160_HwUnInitialize()\n", pDevice->m_nKsDeviceNumber );

//	SA7160_CLOSE_THREAD();
	SA7160_StopControlPanelAnalysisThread( pDevice );

	// CGU (CLOCK.SHOP) PROGRAMMING
	// 
	if( p_sys_cfg ) {

		for( i = 0 ; i < C_CGU_CLKS ; i++ ) {

			if( p_sys_cfg->n_boot_clock_divider[ i ] == 0x00000000 ) { continue ; }

			SA7160_SetRegister( pDevice, 0x00013000 + 0x0218 + 0x04 * i, p_sys_cfg->n_boot_clock_divider[ i ] );
		}
	}
	g_pDevice[ pDevice->m_nKsDeviceNumber ] = NULL;
	
	FREE( pDevice->m_pCustomSystemConfigProperty );

	return TRUE;
}

BOOLEAN Combine( BYTE* dest, BYTE* src_Y, BYTE* src_UV, int buffer_size, CVideo * pVideo )
{
	//LINUXV4L2_DEBUG( KERN_INFO, "Combine() buffer_size(0x%x)\n", buffer_size );

	int i = 0;

	int limit = min( buffer_size, 960 * 1080 * 2);

	if( dest && src_Y && src_UV )
	{
		if(pVideo->m_nFramePixelFormat == V4L2_PIX_FMT_UYVY)
		{
			for(i = 0; i < limit; i++)//UYVY
			{
				*dest++ = *src_UV++;

				*dest++ = *src_Y++;
			}
		}
		else
		{
			for(i = 0; i < limit; i++)//YUYV
			{
				*dest++ = *src_Y++;
				
				*dest++ = *src_UV++;
			}
		}
	
	}
	else
	{
		return FALSE;
	}

	return TRUE;
}

BOOLEAN Combine_4chip( BYTE* dest, BYTE* chip0, BYTE* chip1, BYTE* chip2, BYTE* chip3, int pixel, CVideo * pVideo )
{
	//LINUXV4L2_DEBUG( KERN_INFO, "Combine_4chip() pixel(0x%x)\n", pixel );

	int i = 0;

	int limit = min( pixel, 3840 * 2160);

	if( dest && chip0 && chip1 && chip2 && chip3 )
	{
		//Y1U1Y2V1Y3U2Y4V2

		//chip0 Y2 Y4
		//chip1 V1 V2
		//chip2 Y1 Y3
		//chip3 U1 U2
		
		if(pVideo->m_nFramePixelFormat == V4L2_PIX_FMT_UYVY)
		{
			
			for(i = 0; i < limit / 2; i++)//UYVY
			{

				*dest++ = *chip3++;
				
				*dest++ = *chip2++;

				*dest++ = *chip1++;
				
				*dest++ = *chip0++;
			}
			
		}
		else
		{
			for(i = 0; i < limit / 2; i++)//YUYV
			{

				*dest++ = *chip2++;
				
				*dest++ = *chip3++;

				*dest++ = *chip0++;
				
				*dest++ = *chip1++;
			}
		}
	
	}
	else
	{
		return FALSE;
	}

	return TRUE;
}

BYTE getcolorbar(CDevice *pDevice, int cxe)
{
	int i =  pDevice->m_colorbar_pos % (cxe * 2);

	BYTE* po = COLOR_BAR_3840;

	pDevice->m_colorbar_pos++;

	if( cxe == 720 )
	{
		po = COLOR_BAR_720; 
	}

	if( cxe == 1280 )
	{
		po = COLOR_BAR_1280; 
	}

	if( cxe == 1920 )
	{
		po = COLOR_BAR_1920; 
	}

	if( cxe == 3840 )
	{
		po = COLOR_BAR_3840; 
	}

	if(pDevice->m_No_Signal_black_pattern_property)
	{
		po = BLACK_LINE_3840; 
	}

	return *(po + i);


}

BYTE getpo(CDevice *pDevice, int dst_width, int src_width, BYTE* po)
{
	if( (pDevice->m_buf_pos++ % (dst_width * 2)) < (src_width * 2))//video
	{
		return *( po + pDevice->m_src_pos++);
	}
	else//blank
	{
		return 0x00;
	}
}


#define MIN(x,y) (x<y)?x:y

struct timeval previous_ts[16];

BOOLEAN SA7160_HwProcessAnalogPCIVideoPacket( CDevice *pDevice, ULONG status, ULONG mask, CVideo * pVideos[ MAX_SUB_DEVICE_NUM_X_2 ], CVideoBuffer * pVideoBuffers[ MAX_SUB_DEVICE_NUM_X_2 ], BOOLEAN * p_is_completes, BOOLEAN * p_is_drops )
{

	//LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwProcessAnalogPCIVideoPacket() status(0x%x)\n", , pDevice->m_nKsDeviceNumber, status );

	if( status == 0xFFFFFFFF )
	{
		p_is_drops[ 0 ] = FALSE;

		p_is_completes[ 0 ] = TRUE;

		if( pVideos[ 0 ] && pVideoBuffers[ 0 ] )
		{
			#if LINUX_VERSION_CODE >= KERNEL_VERSION(2,6,24)
			{
				BYTE * po = COLOR_BAR_1920;

				//BYTE * pe = wrapper_videobuf_to_vmalloc( &pVideoBuffers[ 0 ]->m_sKsBuffer ); //NOTE: should use videobuf_queue_vmalloc_init, not videobuf_queue_sg_init

				struct videobuf_dmabuf * pKsDMABuffer = videobuf_to_dma( &pVideoBuffers[ 0 ]->m_sKsBuffer );

				struct scatterlist * p_sglist = (struct scatterlist *)(pKsDMABuffer->sglist);
			
				dma_addr_t physical_address = sg_dma_address( p_sglist );
			
				ULONG byte_count = sg_dma_len( p_sglist );//4096

				ULONG count = 0;

				ULONG mapping_count = pKsDMABuffer->sglen; // (remains/byte_count) + 1

				ULONG remains = pVideos[ 0 ]->m_nDstFrameWidth * pVideos[ 0 ]->m_nDstFrameHeight * 2;

				BYTE* pe = (BYTE*)phys_to_virt(physical_address);

				if( pe == NULL ) { LINUXV4L2_DEBUG( KERN_INFO, "[%02d] can not allocate pe()\n", pDevice->m_nKsDeviceNumber ); return TRUE; }

				if( pVideoBuffers[ 0 ]->m_sKsBuffer.state != VIDEOBUF_QUEUED ) { LINUXV4L2_PRINT( KERN_INFO, "[%02d] pe state error(%x)\n", pDevice->m_nKsDeviceNumber, pVideoBuffers[ 0 ]->m_sKsBuffer.state ); return TRUE; }

				// COPY VIDEO FRAME TO VIDEO BUFFER 
				//

				if( pe && po ) 
				{

					ULONG cxe = pVideoBuffers[ 0 ]->m_sKsBuffer.width;

					ULONG cye = pVideoBuffers[ 0 ]->m_sKsBuffer.height;

					if( (cxe * cye * 2) <= pVideoBuffers[ 0 ]->m_sKsBuffer.size )
					{
						/*
						int line = 0;
						for( line = 0; line < cye; line++ )
						{
							
							if( (pDevice->m_nAnalogCaptureStreamPowerReference != 0) && (pVideoBuffers[ 0 ]->m_sKsBuffer.state == VIDEOBUF_QUEUED) )
							{
								if(pDevice->m_No_Signal_black_pattern_property)
								{
									po = BLACK_LINE_3840; 
								}

								memcpy( pe + line * cxe * 2, po, cxe * 2 ); 
							}
							
						}
						*/
						int i = 0;

						pDevice->m_colorbar_pos = 0;//reset colorbar pattern
						
						while( remains ) {

							if( remains < 4096 ) {

								for(i = 0; i < remains; i++)
								{
								   *pe++ = getcolorbar(pDevice, cxe);
								}

								remains = 0;

								break;
							}
							else {

								for(i = 0; i < byte_count; i++)
								{
									*pe++ = getcolorbar(pDevice, cxe);
								}

								remains -= byte_count;

								p_sglist++;

								count++;

								if( count < mapping_count ) {

									pe = sg_dma_address( p_sglist );

									pe = (BYTE*)phys_to_virt(pe);

									byte_count = sg_dma_len( p_sglist );
								}
								else {
									break; 
								}
							}
						}// end of while
						
					}
					else
					{
						//should not go here
						if( (pDevice->m_nAnalogCaptureStreamPowerReference != 0) && (pVideoBuffers[ 0 ]->m_sKsBuffer.state == VIDEOBUF_QUEUED) )
						{
							//memset(pe, 0x00, pVideoBuffers[ 0 ]->m_sKsBuffer.size);
						}
					}
				}
			}
			#endif

			pVideoBuffers[ 0 ]->m_sKsBuffer.input = 0xFFFFFFFF; //
		}
	
		return TRUE;

	}
	
	pDevice->m_nDmaBaseCommonBufferNumber[ 0 ]++;

	LONG i_major = 0;

	if( status & 0x0000000000000001 ) {

		//LINUXV4L2_DEBUG( KERN_INFO, "[%02d] status & 0x0000001\n", (int)(pDevice->m_nKsDeviceNumber) );

		SA7160_SYS_CFG * p_sys_cfg = (SA7160_SYS_CFG *)(pDevice->m_pCustomSystemConfigProperty);
		ULONG R00008000 = SA7160_GetRegister( pDevice, 0x00008000 + 0x00000000 ); // BAM.DMA.BUF.MODE

		//ULONG R00000FE0 = SA7160_GetRegister( pDevice, 0x00000000 + 0x00000FE0 ); // VIP.INT.STATUS
		
		ULONG R00000FE0 = mask; // from ISR

		//prepare for next interrupt, otherwise first a few bytes wil be lost
		ULONG i = (R00008000 & 0x00000038) >> 3; i = ( i + 1 ) % 8;

		if( (p_sys_cfg->n_input_video_resolution_cx ==  720 && p_sys_cfg->n_input_video_resolution_cy == 240) ||

			(p_sys_cfg->n_input_video_resolution_cx ==  720 && p_sys_cfg->n_input_video_resolution_cy == 288) ||

			(p_sys_cfg->n_input_video_resolution_cx ==  768 && p_sys_cfg->n_input_video_resolution_cy == 288) ||
			
			(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy == 540) ||
			
			(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 540) ) {

			if( R00000FE0 & 0x40000000 ) { // INTERLEAVED

				i_major = (R00008000 & 0x00000038) >> 3;
			}
			else {

				i_major = i;
			}
		}
		else {

			i_major = i;
		}

		ULONGLONG physical_address_dummy = pDevice->m_pDmaBaseCommonPhysicalBuffer[ 0 ];

		UINT * pe = (UINT *)(pDevice->m_pDmaBaseCommonBuffer[ 0 ] + 4096 * 2 * i);

		physical_address_dummy += 4096 * 2 * 8;

		ULONG pitch = 0;

		ULONG pages = 0;

		if( (p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy == 240) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy == 288) ) {
		
			pitch = p_sys_cfg->n_input_video_resolution_cx >> 1;
		}
		else{

			pitch = p_sys_cfg->n_input_video_resolution_cx;
		}

		#ifdef ENABLE_1920X1080PX60FPS

		if( (pDevice->iManufacturer == 0x01 && pDevice->iProduct == 0x07) ||
		
			(pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) ||
		
			(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) ||

			(pDevice->iManufacturer == 0x1A && pDevice->m_nCustomGpioSupportProperty == 8) ||
			
			(pDevice->iManufacturer == 0x1B && pDevice->m_nCustomGpioSupportProperty == 8) ||

			(pDevice->iManufacturer == 0x10) ||

			(pDevice->iManufacturer == 0x12) ||

			(pDevice->iManufacturer == 0x13) ||

			(pDevice->iManufacturer == 0x14) ||

			(pDevice->iManufacturer == 0x16) ||

			(pDevice->iManufacturer == 0x17) ||

			(pDevice->iManufacturer == 0x18) ||
		
		   ((pDevice->iManufacturer & 0xF0) == 0x00 &&
		   
			(pDevice->iProduct & 0x0F) == 0x05) )
		{

				if( (p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  768 && p_sys_cfg->n_input_video_resolution_fps ==  85) ||

					(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  800 && p_sys_cfg->n_input_video_resolution_fps ==  85) ||

					(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  960 && p_sys_cfg->n_input_video_resolution_fps ==  75) ||

					(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  960 && p_sys_cfg->n_input_video_resolution_fps ==  85) ||

					(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps ==  75) ||

					(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps ==  85) ||

					(p_sys_cfg->n_input_video_resolution_cx == 1400 && p_sys_cfg->n_input_video_resolution_cy == 1050 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

					(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy ==  900 && p_sys_cfg->n_input_video_resolution_fps ==  75) ||

					(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy ==  900 && p_sys_cfg->n_input_video_resolution_fps ==  85) ||

					(p_sys_cfg->n_input_video_resolution_cx == 1680 && p_sys_cfg->n_input_video_resolution_cy == 1050 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

					(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps ==  61) ||

					(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps ==  60) ||

					(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps ==  50) ||

					(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 120) ||

					(p_sys_cfg->n_input_video_resolution_cx == 1600 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
					
					(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

					(p_sys_cfg->n_input_video_resolution_cx == 3840 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
					
					(p_sys_cfg->n_input_video_resolution_cx >= 3840 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
					
					(p_sys_cfg->n_input_video_resolution_cx == 2800 && p_sys_cfg->n_input_video_resolution_cy == 2100 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

					(p_sys_cfg->n_input_video_resolution_cx == 4096 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

					(p_sys_cfg->n_input_video_resolution_h_total > 0 && 
						
					 p_sys_cfg->b_input_video_resolution_spliter_mode == TRUE) ) {

					if( p_sys_cfg->n_input_video_resolution_cy == 1200 ) {

						pitch /= 1;	
					}
					else {
						
						pitch /= 2;	
					}
				}

		}
		#endif

		ULONG remains = 0;
		
		if(pVideoBuffers[ 0 ])
		{
			remains = pVideoBuffers[ 0 ]->m_sKsBuffer.size;
		}
		else
		{
			p_is_drops[ 0 ] = TRUE;
	
			return TRUE;
		}
		/*
		ULONG remains = pitch * p_sys_cfg->n_input_video_resolution_cy * 2;

		if( p_sys_cfg->n_input_video_resolution_cy == 240 ||

			p_sys_cfg->n_input_video_resolution_cy == 288 ||

			p_sys_cfg->n_input_video_resolution_cy == 540 ) {

			remains = pitch * p_sys_cfg->n_input_video_resolution_cy * 2 * 2;
		}
		else if( p_sys_cfg->n_input_video_resolution_cy == 2160 || p_sys_cfg->n_input_video_resolution_cy == 2100)
		{
			remains = pitch * (p_sys_cfg->n_input_video_resolution_cy / 2)  * 2;
		}
		else {

			remains = pitch * p_sys_cfg->n_input_video_resolution_cy * 2;
		}
		*/

		//if( pDevice->m_nDmaBaseCommonBufferNumber[ 0 ] % 100 == 0 )
		//{
		//	LINUXV4L2_DEBUG( KERN_INFO, "[%02d] status & 1, iManufacturer(0x%x) remains(0d%d)\n", pDevice->m_nKsDeviceNumber, pDevice->iManufacturer, remains );
		//}

		ULONG j = ( p_sys_cfg->n_video_buffer_count ) % SA7160_MAX_BUFFER;

		if(pVideoBuffers[ 0 ])
		{
			pVideoBuffers[ 0 ]->m_sKsBuffer.input = j;
		}

		dma_addr_t physical_address = pDevice->m_SA7160_video_buffer_physical_address[ j ];
			
		ULONG byte_count = 4096;

		ULONG mapping_count = (remains / 4096 ) + 1; 



//		if( j == 0 ) { offset = physical_address & 0x00000FFF; }
		
		while( remains > 0 ) {

//sizeof(ULONG) FC15_X64 is 4, FC14_X64, FC16_X64 is 8

			*pe++ = (UINT)((physical_address >>  0) & 0xFFFFF000);

			//*pe++ = (UINT)(physical_address >>  32);
			*pe++ = 0;
					
			//LINUXV4L2_DEBUG( KERN_INFO, "[%d]physical_address(0x%x)\n", (int)(pDevice->m_nKsDeviceNumber), physical_address );
			//LINUXV4L2_DEBUG( KERN_INFO, "[%d]physical_address >> 32 (0x%x)\n", (int)(pDevice->m_nKsDeviceNumber), physical_address >> 32 );

			pages++;

			if( pages >= 1024 ) { goto LOOP_END_LINES; }

			remains -= byte_count;

			if( pages < mapping_count ) {

				physical_address += 4096;

				byte_count = 4096;

			}
			else {

				//LINUXV4L2_DEBUG( KERN_INFO, "all mapping_count run out \n" );

				physical_address = 0;

				byte_count = 0;

				goto LOOP_END_LINES;
			}

		}//end of while

LOOP_END_LINES:

		for( ; pages < 1024 ; pages++ ) {

			*pe++ = (UINT) (physical_address_dummy);

			*pe++ = 0;

		}
		if( (p_sys_cfg->n_input_video_resolution_cx ==  720 && p_sys_cfg->n_input_video_resolution_cy == 240) ||

			(p_sys_cfg->n_input_video_resolution_cx ==  720 && p_sys_cfg->n_input_video_resolution_cy == 288) ||

			(p_sys_cfg->n_input_video_resolution_cx ==  768 && p_sys_cfg->n_input_video_resolution_cy == 288) ||
			
			(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy == 540) ) {

			SA7160_SetRegister( pDevice, 0x00000000 + 0x0344, pitch * 4 );

			SA7160_SetRegister( pDevice, 0x00000000 + 0x0354, pitch * 2 );

			if(pVideos[ 0 ])
			{
				if( R00000FE0 & 0x40000000 ) { // INTERLEAVED

					if( pVideos[ 0 ]->m_nFrameCopyPolarity == 0x80000000 ) {

						p_is_drops[ 0 ] = FALSE;

						p_is_completes[ 0 ] = TRUE;
	
					}
					pVideos[ 0 ]->m_nFrameCopyPolarity = 0x00000000;

				}
				else {

					pVideos[ 0 ]->m_nFrameCopyPolarity = 0x80000000;
				}
			}

		}
		else if (p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 540) 
		{

			SA7160_SetRegister( pDevice, 0x00000000 + 0x0344, pitch * 4 );

			SA7160_SetRegister( pDevice, 0x00000000 + 0x0354, pitch * 2 );

			if(pVideos[ 0 ])
			{
				//if( R00000FE0 & 0x40000000 ) { // INTERLEAVED

				if( (R00000FE0 & 0x40000000) && ( ((R00000FE0 & 0x3FF0000) >> 16) > 0x21a) ) { // INTERLEAVED

					struct timeval now_ts;
								
					wrapper_do_gettimeofday( &now_ts );

					ULONG diff = 0;
						
					if( now_ts.tv_sec == pDevice->previous_field_ts.tv_sec)
					{
						diff = now_ts.tv_usec - pDevice->previous_field_ts.tv_usec;
					}
					else
					{
						diff = (now_ts.tv_sec - pDevice->previous_field_ts.tv_sec) * 1000000  + now_ts.tv_usec - pDevice->previous_field_ts.tv_usec;
					}
					
					pDevice->previous_field_ts.tv_sec = now_ts.tv_sec;

					pDevice->previous_field_ts.tv_usec = now_ts.tv_usec;

					if( diff > 12000 )
					{
						if( pVideos[ 0 ]->m_nFrameCopyPolarity == 0x80000000 ) {

							p_is_drops[ 0 ] = FALSE;

							p_is_completes[ 0 ] = TRUE;
		
						}
						pVideos[ 0 ]->m_nFrameCopyPolarity = 0x00000000;

						pDevice->field_counter = 0; //reset
					}

				}
				else {

					pVideos[ 0 ]->m_nFrameCopyPolarity = 0x80000000;

					#ifdef DMA_ERROR_1080i 

					pDevice->field_counter++;

					struct timeval now_ts;
								
					wrapper_do_gettimeofday( &now_ts );

					ULONG diff = 0;
						
					if( now_ts.tv_sec == pDevice->previous_field_ts.tv_sec)
					{
						diff = now_ts.tv_usec - pDevice->previous_field_ts.tv_usec;
					}
					else
					{
						diff = (now_ts.tv_sec - pDevice->previous_field_ts.tv_sec) * 1000000  + now_ts.tv_usec - pDevice->previous_field_ts.tv_usec;
					}

					pDevice->previous_field_ts.tv_sec = now_ts.tv_sec;

					pDevice->previous_field_ts.tv_usec = now_ts.tv_usec;


					if( (diff > 12000) && (diff < 28000) )
					{
						if( (pDevice->field_counter % 2 ) == 0 )//only previous filed is odd
						{
							p_is_drops[ 0 ] = FALSE;

							p_is_completes[ 0 ] = TRUE;
		
							pVideos[ 0 ]->m_nFrameCopyPolarity = 0x00000000;

							LINUXV4L2_DEBUG( KERN_INFO, "[%02d] fix interlace\n", (int)(pDevice->m_nKsDeviceNumber) );

						}
					}
					#endif

				}
			}

		}
		else { // PROGRESSIVE

			SA7160_SetRegister( pDevice, 0x00000000 + 0x0344, pitch * 2 );

			SA7160_SetRegister( pDevice, 0x00000000 + 0x0354, pitch * 0 );

			p_is_drops[ 0 ] = FALSE;

			p_is_completes[ 0 ] = TRUE;

		}

//		SA7160_SetRegister( pDevice, 0x00008000 + 0x0004 + 0x04 * (i), offset );

#ifdef ENABLE_1920X1080PX60FPS

	// -----> tmStreamPort::tmIOnInterrupt() -----> tmHWStreamPort_VIP_Video::tmIGetCurrentWritePosition()
	//
	if( (pDevice->iManufacturer == 0x01 && pDevice->iProduct == 0x07) ||
		
		(pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) ||
				
		(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) ||
				 
		(pDevice->iManufacturer == 0x1A && pDevice->m_nCustomGpioSupportProperty == 8) ||
		
		(pDevice->iManufacturer == 0x1B && pDevice->m_nCustomGpioSupportProperty == 8) ||

		(pDevice->iManufacturer == 0x10) ||
		
		(pDevice->iManufacturer == 0x12) ||
		
		(pDevice->iManufacturer == 0x13) ||
		
		(pDevice->iManufacturer == 0x14) ||
		
		(pDevice->iManufacturer == 0x16) ||
		
		(pDevice->iManufacturer == 0x17) ||

		(pDevice->iManufacturer == 0x18) ) {

		SA7160_SYS_CFG * p_sys_cfg = (SA7160_SYS_CFG *)(pDevice->m_pCustomSystemConfigProperty);

		if( (p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  768 && p_sys_cfg->n_input_video_resolution_fps ==  85) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  800 && p_sys_cfg->n_input_video_resolution_fps ==  85) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  960 && p_sys_cfg->n_input_video_resolution_fps ==  75) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  960 && p_sys_cfg->n_input_video_resolution_fps ==  85) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps ==  75) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps ==  85) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1400 && p_sys_cfg->n_input_video_resolution_cy == 1050 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy ==  900 && p_sys_cfg->n_input_video_resolution_fps ==  75) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy ==  900 && p_sys_cfg->n_input_video_resolution_fps ==  85) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1680 && p_sys_cfg->n_input_video_resolution_cy == 1050 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps ==  61) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps ==  60) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps ==  50) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 120) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

			(p_sys_cfg->n_input_video_resolution_cx == 1600 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

			(p_sys_cfg->n_input_video_resolution_cx == 3840 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

			(p_sys_cfg->n_input_video_resolution_cx >= 3840 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

			(p_sys_cfg->n_input_video_resolution_cx >= 2800 && p_sys_cfg->n_input_video_resolution_cy == 2100 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

			(p_sys_cfg->n_input_video_resolution_cx == 4096 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
			
			(p_sys_cfg->n_input_video_resolution_h_total > 0 && 
			
			 p_sys_cfg->b_input_video_resolution_spliter_mode == TRUE) ) {

			ULONG nums = 1;

			if( (p_sys_cfg->n_input_video_resolution_cx == 4096 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
				
				(p_sys_cfg->n_input_video_resolution_cx >= 3840 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
				
				(p_sys_cfg->n_input_video_resolution_cx >= 2800 && p_sys_cfg->n_input_video_resolution_cy == 2100 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
				
				(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 120) ) {

				nums = 3;
			}
			else {

				nums = 1;
			}

//			SA7160_POLLING_DELAY_100NS( pDevice, 5000 ); // 500US	
			
			ULONG n = 0;
			for( n = 0 ; n < nums ; n++ ) {

				CDevice * pBrotherDevice = g_pDevice[ pDevice->m_nKsDeviceNumber + n + 1 ];

				if( pBrotherDevice ) {

					if( status & 0x0000000000000001 ) {

						if( pBrotherDevice->m_nAnalogCaptureStreamPowerReference > 0 ) { break ; } // +SC510N4

						{	ULONG counts = 0;

							ULONG timeouts = (nums == 3) ? 200 : 20;

							ULONG R00000FE0 = 0x00000000;

							while( R00000FE0 == 0x00000000 &&
								
								   counts < timeouts ) {

								R00000FE0 = SA7160_GetRegister( pBrotherDevice, 0x00000000 + 0x00000FE0 ) & 0x00000001;

								counts++;

								udelay(1);
							}
						//	if( counts == timeouts ) { DbgPrint( "%d ---------------------------------------- timeout", n ); }
						}
					}
				}
			}

			for( n = 0 ; n < nums ; n++ ) {

				CDevice * pBrotherDevice = g_pDevice[ pDevice->m_nKsDeviceNumber + n + 1 ];

				if( pBrotherDevice ) {

					if( status & 0x0000000000000001 ) {

						if( pBrotherDevice->m_nAnalogCaptureStreamPowerReference > 0 ) { break ; } // +SC510N4

						ULONG R00008000 = SA7160_GetRegister( pBrotherDevice, 0x00008000 + 0x00000000 ); // BAM.DMA.BUF.MODE

						ULONG i = (R00008000 & 0x00000038) >> 3; i = (i + 1) % 8;

						dma_addr_t physical_address_dummy = pBrotherDevice->m_SA7160_video_buffer_physical_address[ j ];

						UINT * pe = (UINT *)(pBrotherDevice->m_pDmaBaseCommonBuffer[ 0 ] + 4096 * 2 * i);

						physical_address_dummy += 4096 * 2 * 8;

						ULONG pitch = 0;

						ULONG pages = 0;

						pitch = p_sys_cfg->n_input_video_resolution_cx;

						if( (p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy == 240) ||

							(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy == 288) ) {
						
							pitch = p_sys_cfg->n_input_video_resolution_cx >> 2;
						}
						else{

							pitch = p_sys_cfg->n_input_video_resolution_cx / 2;
						}
						if( p_sys_cfg->n_input_video_resolution_cy == 1200 ) {

							pitch <<= 1;
						}
					
						ULONG remains = pVideoBuffers[ 0 ]->m_sKsBuffer.size;
						/*
						ULONG remains = pitch * p_sys_cfg->n_input_video_resolution_cy * 2;

						if( p_sys_cfg->n_input_video_resolution_cy == 240 ||

							p_sys_cfg->n_input_video_resolution_cy == 288 ||

							p_sys_cfg->n_input_video_resolution_cy == 540 ) {

							remains = pitch * p_sys_cfg->n_input_video_resolution_cy * 2 * 2;
						}
						else if( p_sys_cfg->n_input_video_resolution_cy == 2160 || p_sys_cfg->n_input_video_resolution_cy == 2100)
						{
							remains = pitch * (p_sys_cfg->n_input_video_resolution_cy / 2)  * 2;
						}
						else {

							remains = pitch * p_sys_cfg->n_input_video_resolution_cy * 2;
						}
						*/
						dma_addr_t physical_address = pBrotherDevice->m_SA7160_video_buffer_physical_address[ j ];

						ULONG byte_count = 4096;

						ULONG mapping_count = (remains / 4096 ) + 1; 

						//if( j == 0 ) { offset = physical_address.LowPart & 0x00000FFF; }

						while( remains > 0 ) {

							*pe++ = (UINT)((physical_address >>  0) & 0xFFFFF000);

							*pe++ = 0;

							pages++;

							if( pages >= 1024 ) { goto LOOP_END_VIP_MAPPINGS_EX; }

							remains -= byte_count;

							if( pages < mapping_count ) {

								physical_address += 4096;

								byte_count = 4096;

							}
							else {

								//LINUXV4L2_DEBUG( KERN_INFO, "all mapping_count run out \n" );

								physical_address = 0;

								byte_count = 0;

								goto LOOP_END_VIP_MAPPINGS_EX;
							}
						}

LOOP_END_VIP_MAPPINGS_EX:

						for( ; pages < 1024 ; pages++ ) {

						   *pe++ = (UINT) physical_address_dummy;

						   *pe++ = 0;
						}
						if( (p_sys_cfg->n_input_video_resolution_cx ==  720 && p_sys_cfg->n_input_video_resolution_cy == 240) ||

							(p_sys_cfg->n_input_video_resolution_cx ==  720 && p_sys_cfg->n_input_video_resolution_cy == 288) ||

							(p_sys_cfg->n_input_video_resolution_cx ==  768 && p_sys_cfg->n_input_video_resolution_cy == 288) ||
						
							(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy == 540) ||
							
							(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 540) ) {

							SA7160_SetRegister( pBrotherDevice, 0x00000000 + 0x0344, pitch * 4 );

							SA7160_SetRegister( pBrotherDevice, 0x00000000 + 0x0354, pitch * 2 );
						}
						else {

							SA7160_SetRegister( pBrotherDevice, 0x00000000 + 0x0344, pitch * 2 ); // PROGRESSIVE

							SA7160_SetRegister( pBrotherDevice, 0x00000000 + 0x0354, pitch * 0 ); // PROGRESSIVE
						}
						//SA7160_SetRegister( pBrotherDevice, 0x00008000 + 0x0004 + 0x04 * (i), offset );
					}
				}
			}
		}
	}

#endif

		if(	p_is_completes[ 0 ] == TRUE )
		{
			if( pVideoBuffers[ 0 ] == NULL )
			{
				if( (pDevice->iManufacturer == 0x19) ||

					(pDevice->iManufacturer == 0x1A && pDevice->m_nCustomGpioSupportProperty == 0) ||  

					(pDevice->iManufacturer == 0x1B && pDevice->m_nCustomGpioSupportProperty == 0) ||
					
					(pDevice->iManufacturer == 0x18 && SA7160_IS_4K2K_ENABLED( pDevice ) ) )
				{
					NULL;
				}
				else
				{
					LINUXV4L2_DEBUG( KERN_INFO, "[%02d] no pVideoBuffers[ 0 ], return\n", (int)(pDevice->m_nKsDeviceNumber) );
				}

				p_is_drops[ 0 ] = TRUE;
	
				return TRUE;
			}
			
			if( pVideos[ 0 ] == NULL )
			{
				LINUXV4L2_DEBUG( KERN_INFO, "[%02d] no pVideos[ 0 ], return\n", (int)(pDevice->m_nKsDeviceNumber) );

				return TRUE;
			}
			
			//first 2 frames are error
			if(	pVideos[ 0 ]->m_video_preview_frame_number < 2)
			{
				LINUXV4L2_DEBUG( KERN_INFO, "[%02d] FirsttwoFrame, return\n", (int)(pDevice->m_nKsDeviceNumber) );

				pVideos[ 0 ]->m_video_preview_frame_number++;

				p_is_drops[ 0 ] = TRUE;
	
				p_sys_cfg->n_video_buffer_count =  (p_sys_cfg->n_video_buffer_count + 1) % SA7160_MAX_BUFFER;

				return TRUE;
			}
			
//skip frame here
			// CALCULATE OUTPUT FPS 
			//
			ULONGLONG n_video_encoder_frame_fps_mask = 0;
			ULONG n_video_encoder_frame_fps_mask_length = 0;

			n_video_encoder_frame_fps_mask = SA7160_CALCULATE_FPS( pDevice, (pDevice->m_Preview_frame_rate_setting & 0x7FFFFFFF)/1000 );

			n_video_encoder_frame_fps_mask_length = pDevice->m_nCustomAnalogVideoFrameRateProperty;//real fps of signal

			if( pDevice->m_nCustomAnalogVideoInterleavedProperty == 1 )
			{
				n_video_encoder_frame_fps_mask_length /= 2;
			}

			ULONG is_skip = FALSE;
			ULONGLONG bit = 0;

			if(  ( pDevice->iManufacturer == 0x19 ) || (pDevice->iManufacturer == 0x18 && SA7160_IS_4K2K_ENABLED( pDevice ))  )
			{
				NULL;
			}
			else
			{
				if( n_video_encoder_frame_fps_mask_length <= ((pDevice->m_Preview_frame_rate_setting & 0x7FFFFFFF)/1000) )
				{
					is_skip = FALSE;
				}
				else
				{
					
					bit = (ULONG)(pVideos[ 0 ]->m_video_preview_frame_number ) % (n_video_encoder_frame_fps_mask_length);

					is_skip = ((( (ULONGLONG)1 << bit) & (n_video_encoder_frame_fps_mask)) == 0) ? TRUE : FALSE;
				}

				pVideos[ 0 ]->m_video_preview_frame_number++;

			}
			
			if( is_skip ) 
			{
				LINUXV4L2_DEBUG( KERN_INFO, "skip frame, bit(%d)\n", bit );
				
				p_is_drops[ 0 ] = TRUE;
				
				p_sys_cfg->n_video_buffer_count =  (p_sys_cfg->n_video_buffer_count + 1) % SA7160_MAX_BUFFER;

			}
			else
			{
				{
					BYTE * po = NULL;

					//BYTE * pe = wrapper_videobuf_to_vmalloc( &pVideoBuffers[ 0 ]->m_sKsBuffer ); //NOTE: should use videobuf_queue_vmalloc_init, not videobuf_queue_sg_init

					struct videobuf_dmabuf * pKsDMABuffer = videobuf_to_dma( &pVideoBuffers[ 0 ]->m_sKsBuffer );

					struct scatterlist * p_sglist = (struct scatterlist *)(pKsDMABuffer->sglist);
			
					dma_addr_t physical_address = sg_dma_address( p_sglist );
			
					ULONG byte_count = sg_dma_len( p_sglist );//4096, or 4080, update this every time

					ULONG count = 0;

					ULONG mapping_count = pKsDMABuffer->sglen; // (remains/byte_count) + 1

					ULONG remains = pVideos[ 0 ]->m_nDstFrameWidth * pVideos[ 0 ]->m_nDstFrameHeight * 2;

					BYTE* pe = (BYTE*)phys_to_virt(physical_address);

					if( pe == NULL ) { LINUXV4L2_DEBUG( KERN_INFO, "can not allocate pe()\n" ); return TRUE; }

					if( pVideoBuffers[ 0 ]->m_sKsBuffer.state != VIDEOBUF_QUEUED ) { LINUXV4L2_PRINT( KERN_INFO, "pe state error(%x)\n", pVideoBuffers[ 0 ]->m_sKsBuffer.state ); return TRUE; }

					// COPY VIDEO FRAME TO VIDEO BUFFER 
					//
					ULONG cxe = pitch;

					//ULONG cye = pVideos[ 0 ]->m_nDstFrameHeight;

					ULONG cye  = p_sys_cfg->n_input_video_resolution_cy;

					if( pDevice->m_nCustomAnalogVideoInterleavedProperty == 1 )
					{
						cye *= 2;
					}

					ULONG j = (pVideoBuffers[ 0 ]->m_sKsBuffer.input + 1) % SA7160_MAX_BUFFER;// fetch the previous 2 DMA

					po = pDevice->m_SA7160_video_buffer[ j ]; 

					if( pe && po ) {

						if( pDevice->m_nAnalogCopyProtMacrovisionProperty == 1 )//HDCP
						{
							LINUXV4L2_PRINT( KERN_INFO, "[%02d] m_nAnalogCopyProtMacrovisionProperty == 1!!!\n", pDevice->m_nKsDeviceNumber );
							
							if( (pDevice->m_nAnalogCaptureStreamPowerReference != 0) && (pVideoBuffers[ 0 ]->m_sKsBuffer.state == VIDEOBUF_QUEUED) )
							{
								//memset( pe, 0x00, pVideoBuffers[ 0 ]->m_sKsBuffer.size );

								if( (pDevice->m_nAnalogCaptureStreamPowerReference != 0) && (pVideoBuffers[ 0 ]->m_sKsBuffer.state == VIDEOBUF_QUEUED) )
								{
									
									while( remains ) {

										if( remains < 4096 ) {

											memset(pe, 0x00, remains);

											remains -= remains;

											break;
										}
										else {

											memset(pe, 0x00, byte_count);

											po += byte_count;

											remains -= byte_count;

											p_sglist++;

											count++;

											if( count < mapping_count ) {

												pe = sg_dma_address( p_sglist );

												pe = (BYTE*)phys_to_virt(pe);

												byte_count = sg_dma_len( p_sglist );
											}
											else {
												break; 
											}
										}
									}//end of while
								}
							}
						}
						else
						{
							if( (pDevice->iManufacturer == 0x10 ||

								 pDevice->iManufacturer == 0x12 ||

								 pDevice->iManufacturer == 0x13 ||

								 pDevice->iManufacturer == 0x16 ||

								 pDevice->iManufacturer == 0x17 ||
						
								 pDevice->iManufacturer == 0x18 ||
								
								 (pDevice->iManufacturer == 0x1A && pDevice->m_nCustomGpioSupportProperty == 8) ||

								 (pDevice->iManufacturer == 0x1B && pDevice->m_nCustomGpioSupportProperty == 8) ||

								 (pDevice->iManufacturer == 0x01 && pDevice->iProduct == 0x07) ||

								 (pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) ||
								 
								 (pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07)  )  
								 
								 &&	 (pitch != p_sys_cfg->n_input_video_resolution_cx) )
							{

								ULONG vbi_lines = 0;

								ULONG src_cx = p_sys_cfg->n_input_video_resolution_cx;

								ULONG src_cy = p_sys_cfg->n_input_video_resolution_cy;

								ULONG src_fps = p_sys_cfg->n_input_video_resolution_fps;

								{	if( p_sys_cfg->n_input_video_resolution_interleaved ) { // [PROGRAM PATCH] SUPPORT VBI

										src_cy <<= 1;

										src_cy += p_sys_cfg->n_input_video_resolution_vbi_lines << 1;

										vbi_lines = p_sys_cfg->n_input_video_resolution_vbi_lines << 1;
									}
									else {

										src_cy += p_sys_cfg->n_input_video_resolution_vbi_lines;

										vbi_lines = p_sys_cfg->n_input_video_resolution_vbi_lines;
									}
								}
								//LINUXV4L2_DEBUG( KERN_INFO, "src_cx(0d%d) src_cy(0d%d) src_fps(0d%d) vbi_lines(0d%d)\n", src_cx, src_cy, src_fps, vbi_lines);
								
								ULONG  cw = pVideoBuffers[ 0 ]->m_sKsBuffer.width;

								ULONG  cx = pVideoBuffers[ 0 ]->m_sKsBuffer.width;

								ULONG  cy = pVideoBuffers[ 0 ]->m_sKsBuffer.height;

								if( src_cx < cx ) {

									cx = src_cx;
								}
								if( src_cy < cy ) {
			
									cy = src_cy;
								}

								if( (pDevice->iManufacturer == 0x13) && 
									
									((p_sys_cfg->n_input_video_resolution_cx == 4096 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
									
									(p_sys_cfg->n_input_video_resolution_cx >= 3840 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
									
									(p_sys_cfg->n_input_video_resolution_cx >= 2800 && p_sys_cfg->n_input_video_resolution_cy == 2100 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
									
									(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 120)) ) {
								
									CDevice * pBrotherDevice_1 = g_pDevice[ pDevice->m_nKsDeviceNumber + 1 ];
									CDevice * pBrotherDevice_2 = g_pDevice[ pDevice->m_nKsDeviceNumber + 2 ];
									CDevice * pBrotherDevice_3 = g_pDevice[ pDevice->m_nKsDeviceNumber + 3 ];

									if( pBrotherDevice_1 && pBrotherDevice_2 && pBrotherDevice_3) {

										if( (pDevice->m_nAnalogCaptureStreamPowerReference != 0) && (pVideoBuffers[ 0 ]->m_sKsBuffer.state == VIDEOBUF_QUEUED) )
										{
											//Combine_4chip(pe, pDevice->m_SA7160_video_buffer[ j ], pBrotherDevice_1->m_SA7160_video_buffer[ j ], pBrotherDevice_2->m_SA7160_video_buffer[ j ], pBrotherDevice_3->m_SA7160_video_buffer[ j ], pVideoBuffers[ 0 ]->m_sKsBuffer.size / 2, pVideos[ 0 ]);


											BYTE * po_y1 = pBrotherDevice_2->m_SA7160_video_buffer[ j ];

											BYTE * po_cb = pBrotherDevice_1->m_SA7160_video_buffer[ j ];

											BYTE * po_y2 = pDevice->m_SA7160_video_buffer[ j ];

											BYTE * po_cr = pBrotherDevice_3->m_SA7160_video_buffer[ j ];
											/*
											if( pe ) {

												ULONG y = 0;
												for( y = 0 ; y < cy ; y++ ) {

													BYTE * pe_tmp = pe;

													BYTE * po_y1_tmp = po_y1;

													BYTE * po_cb_tmp = po_cb;

													BYTE * po_y2_tmp = po_y2;

													BYTE * po_cr_tmp = po_cr;
								
													ULONG x = 0;
													for( x = 0 ; x < cx ; x += 2 ) {
								
														*pe_tmp++ = *po_y2_tmp++;

														*pe_tmp++ = *po_cr_tmp++;
								
														*pe_tmp++ = *po_y1_tmp++;

														*pe_tmp++ = *po_cb_tmp++;
													}
													po_y1 += src_cx >> 1;

													po_cb += src_cx >> 1;

													po_y2 += src_cx >> 1;

													po_cr += src_cx >> 1;

													pe += cw << 1;
												}
											}
											*/
											BYTE * po_y1_tmp = po_y1;

											BYTE * po_cb_tmp = po_cb;

											BYTE * po_y2_tmp = po_y2;

											BYTE * po_cr_tmp = po_cr;

											while( remains ) {

												if( remains < 4096 ) {

													for(i = 0; i < remains; i+=4)
													{
														*pe++ = *po_y2_tmp++;

														*pe++ = *po_cr_tmp++;
								
														*pe++ = *po_y1_tmp++;

														*pe++ = *po_cb_tmp++;
													}
												
													remains = 0;

													break;
												}
												else {

													for(i = 0; i < byte_count; i+=4)
													{
														*pe++ = *po_y2_tmp++;

														*pe++ = *po_cr_tmp++;
								
														*pe++ = *po_y1_tmp++;

														*pe++ = *po_cb_tmp++;
													}
												
													remains -= byte_count;

													p_sglist++;

													count++;

													if( count < mapping_count ) {

														pe = sg_dma_address( p_sglist );

														pe = (BYTE*)phys_to_virt(pe);

														byte_count = sg_dma_len( p_sglist );
													}
													else {
														break; 
													}
												}
											}// end of while
										}
									}
								}
								else if( (pDevice->iManufacturer == 0x18) && SA7160_IS_4K2K_ENABLED( pDevice ) )
								{
									NULL;
								}
								else
								{
									CDevice * pBrotherDevice = g_pDevice[ pDevice->m_nKsDeviceNumber + 1 ];

									if( pBrotherDevice ) {

										if( (pDevice->m_nAnalogCaptureStreamPowerReference != 0) && (pVideoBuffers[ 0 ]->m_sKsBuffer.state == VIDEOBUF_QUEUED) )
										{
											//Combine(pe, pDevice->m_SA7160_video_buffer[ j ], pBrotherDevice->m_SA7160_video_buffer[ j ], pVideoBuffers[ 0 ]->m_sKsBuffer.size / 2, pVideos[ 0 ]);

											BYTE * po_y = pDevice->m_SA7160_video_buffer[ j ];

											BYTE * po_c = pBrotherDevice->m_SA7160_video_buffer[ j ];//salve SA7160 DMA address

											if( pe ) {
												/*
												ULONG y = 0;
												for( y = 0 ; y < cy ; y++ ) {

													BYTE * pe_tmp = pe;

													BYTE * po_y_tmp = po_y;

													BYTE * po_c_tmp = po_c;

													ULONG x = 0 ;
													for( x = 0 ; x < cx ; x++ ) { // unpack_low / unpack_high
					
														if( y < vbi_lines ) { // [PROGRAM PATCH] SUPPORT VBI

															USHORT H = (*po_y_tmp) & 0x3E; H <<= 4;

															USHORT L = (*po_c_tmp) & 0x3E; L >>= 1;

															USHORT D = H | L;

														   *pe_tmp++ = (BYTE)((D >> 0) & 0xFF);

														   *pe_tmp++ = (BYTE)((D >> 8) & 0x03);

															po_y_tmp++;

															po_c_tmp++;
														}
														else {

														   *pe_tmp++ = *po_y_tmp++;

														   *pe_tmp++ = *po_c_tmp++;
														}
													}
													if( y < vbi_lines ) {

														LINUXV4L2_DEBUG( KERN_INFO, "[%02d] %02X %02X %02X %02X %02X %02X %02X %02X %02X %02X %02X %02X %02X %02X %02X %02X\n", y, po_y[ 0 ], po_c[ 0 ], po_y[ 1 ], po_c[ 1 ], po_y[ 2 ], po_c[ 2 ], po_y[ 3 ], po_c[ 3 ], po_y[ 4 ], po_c[ 4 ], po_y[ 5 ], po_c[ 5 ], po_y[ 6 ], po_c[ 6 ], po_y[ 7 ], po_c[ 7 ] );

														LINUXV4L2_DEBUG( KERN_INFO, "[%02d] %02X %02X %02X %02X %02X %02X %02X %02X %02X %02X %02X %02X %02X %02X %02X %02X\n", y, pe[ 0 ], pe[ 1 ], pe[ 2 ], pe[ 3 ], pe[ 4 ], pe[ 5 ], pe[ 6 ], pe[ 7 ], pe[ 8 ], pe[ 9 ], pe[ 10 ], pe[ 11 ], pe[ 12 ], pe[ 13 ], pe[ 14 ], pe[ 15 ] );
													}
													po_y += src_cx;

													po_c += src_cx;

													pe += cw << 1;
												}
												*/

												BYTE * po_y_tmp = po_y;

												BYTE * po_c_tmp = po_c;

												int vbi_counter = cx * vbi_lines;

												while( remains ) {

													if( remains < 4096 ) {
														
														for(i = 0; i < remains; i+=2)
														{
														   *pe++ = *po_y_tmp++;
														   *pe++ = *po_c_tmp++;
														}

														remains = 0;

														break;
													}
													else {

														for(i = 0; i < byte_count; i+=2)
														{
															if(vbi_counter-- > 0 )
															{
																USHORT H = (*po_y_tmp) & 0x3E; H <<= 4;

																USHORT L = (*po_c_tmp) & 0x3E; L >>= 1;

																USHORT D = H | L;

															   *pe++ = (BYTE)((D >> 0) & 0xFF);

															   *pe++ = (BYTE)((D >> 8) & 0x03);

																po_y_tmp++;

																po_c_tmp++;
															}
															else
															{
																*pe++ = *po_y_tmp++;
																*pe++ = *po_c_tmp++;
															}
														}
												
														remains -= byte_count;

														p_sglist++;

														count++;

														if( count < mapping_count ) {

															pe = sg_dma_address( p_sglist );

															pe = (BYTE*)phys_to_virt(pe);

															byte_count = sg_dma_len( p_sglist );
														}
														else {
															break; 
														}
													}
												}// end of while
											}
										}
									}
								}
							}
							else
							{
	
								//LINUXV4L2_DEBUG( KERN_INFO, "[%02d] width(0d%d) height(0d%d) size(0d%d)\n", pDevice->m_nKsDeviceNumber, pVideoBuffers[ 0 ]->m_sKsBuffer.width, pVideoBuffers[ 0 ]->m_sKsBuffer.height, pVideoBuffers[ 0 ]->m_sKsBuffer.size );

								if( (cxe * cye * 2) == pVideoBuffers[ 0 ]->m_sKsBuffer.size )
								{
									if( (pDevice->m_nAnalogCaptureStreamPowerReference != 0) && (pVideoBuffers[ 0 ]->m_sKsBuffer.state == VIDEOBUF_QUEUED) )
									{
										//memcpy( pe, po, (cxe * cye) * 2 ); 

										while( remains ) {

											if( remains < 4096 ) {
												
												memcpy(pe, po, remains);

												remains = 0;

												break;
											}
											else {
												
												memcpy(pe, po, byte_count);

												po += byte_count;

												remains -= byte_count;

												p_sglist++;

												count++;

												if( count < mapping_count ) {

													pe = sg_dma_address( p_sglist );

													pe = (BYTE*)phys_to_virt(pe);

													byte_count = sg_dma_len( p_sglist );
												}
												else {
													break; 
												}
											}
										}// end of while
									}
								}
								else
								{
									if( (pDevice->m_nAnalogCaptureStreamPowerReference != 0) && (pVideoBuffers[ 0 ]->m_sKsBuffer.state == VIDEOBUF_QUEUED) )
									{

										pDevice->m_buf_pos = 0;

										pDevice->m_src_pos = 0;

										while( remains ) {

											if( remains < 4096 ) {

												for(i = 0; i < remains; i++)
												{
													*pe++ = getpo(pDevice, pVideoBuffers[ 0 ]->m_sKsBuffer.width, cxe, po);
												}

												remains = 0;

												break;
											}
											else {

												for(i = 0; i < byte_count; i++)
												{
													*pe++ = getpo(pDevice, pVideoBuffers[ 0 ]->m_sKsBuffer.width, cxe, po);
												}

												remains -= byte_count;

												p_sglist++;

												count++;

												if( count < mapping_count ) {

													pe = sg_dma_address( p_sglist );

													pe = (BYTE*)phys_to_virt(pe);

													byte_count = sg_dma_len( p_sglist );
												}
												else {
													break; 
												}
											}
										}// end of while
									}
								}

								/*
								//check frame interval
								struct timeval now_ts;
								
								wrapper_do_gettimeofday( &now_ts );

								ULONG diff = 0;
								
								if( now_ts.tv_sec == previous_ts[ pDevice->m_nKsDeviceNumber ].tv_sec)
								{
									diff = now_ts.tv_usec - previous_ts[ pDevice->m_nKsDeviceNumber ].tv_usec;
								}
								else
								{
									diff = (now_ts.tv_sec - previous_ts[ pDevice->m_nKsDeviceNumber ].tv_sec) * 1000000  + now_ts.tv_usec - previous_ts[ pDevice->m_nKsDeviceNumber ].tv_usec;
								}

								previous_ts[ pDevice->m_nKsDeviceNumber ].tv_sec = now_ts.tv_sec;

								previous_ts[ pDevice->m_nKsDeviceNumber ].tv_usec = now_ts.tv_usec;

								if((diff > 56000) || (diff < 24000))
								{
									LINUXV4L2_DEBUG( KERN_INFO, "[%02d] diff(0d%d)\n", pDevice->m_nKsDeviceNumber, diff );
								}
								*/
							}

						}
					}//if( pe && po )
				}

				//move to next video ring buffer 
				p_sys_cfg->n_video_buffer_count =  (p_sys_cfg->n_video_buffer_count + 1) % SA7160_MAX_BUFFER;

				pVideoBuffers[ 0 ]->m_sKsBuffer.input = 0xFFFFFFFF; //
			}
		
		}//end of p_is_completes[ 0 ] == TRUE

	}


	return TRUE;
}

/*
BYTE base_ready = 0;
BYTE print_error = 0;
#define COMPARESIZE		(4*4*12)

short Buffer[1024];
short Buffer1[1024];

int offset[3] = {128, 64, 0};
int counter = 0;
BYTE audio_base[192];
BYTE audio_error[192];
*/

BOOLEAN	SA7160_HwProcessAnalogPCIAudioPacket( CDevice *pDevice, ULONG status, ULONG mask, CAudio * pAudios[ MAX_SUB_DEVICE_NUM_X_2 ], CAudioBuffer * pAudioBuffers[ MAX_SUB_DEVICE_NUM_X_2 ], BOOLEAN * p_is_completes, BOOLEAN * p_is_drops )
{
	// -----> tmStreamPort::tmIOnInterrupt() -----> tmHWStreamPort_Audio::tmIGetCurrentWritePosition()
	//
	CAudio * pAudio = pAudios[ 0 ];

	SA7160_SYS_CFG * p_sys_cfg = (SA7160_SYS_CFG *)(pDevice->m_pCustomSystemConfigProperty);

	BOOLEAN is_complete = FALSE;

	BYTE * pout = NULL;

	if( status == 0xFFFFFFFF )
	{
		if( pAudio )
		{
			pout = (BYTE*) (pAudio->m_pKsSubStream->runtime->dma_area);
		}
		if( pout ) 
		{
			pout += pAudio->m_nFrameNumber * pAudio->m_nFrameSize;
			
			memset( pout, 0x00, 4096 );
		}
		return TRUE;
	}

	if( status & 0x0000000000000C00 ) {

		//LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_HwProcessAnalogPCIAudioPacket() status(0x%x)\n", pDevice->m_nKsDeviceNumber, status );

		ULONG i = 0;

		if( status & 0x0000000000000400 ) {

			ULONG R00008168 = SA7160_GetRegister( pDevice, 0x00008000 + 0x00000168 ); // BAM.DMA.BUF.MODE

			i = (R00008168 & 0x00000038) >> 3; i = ( i + 1 ) % 8;
		}

		if( status & 0x0000000000000800 ) {

			ULONG R0000818C = SA7160_GetRegister( pDevice, 0x00008000 + 0x0000018C ); // BAM.DMA.BUF.MODE

			i = (R0000818C & 0x00000038) >> 3; i = ( i + 1 ) % 8;
		}
		
		
		
		dma_addr_t physical_address_dummy = pDevice->m_pDmaBaseCommonPhysicalBuffer[ 1 ];

		UINT * pe = (UINT *)(pDevice->m_pDmaBaseCommonBuffer[ 1 ] + 4096 * 1 * i );

		physical_address_dummy += 4096 * 1 * 8;

		{	

			dma_addr_t physical_address = pDevice->m_pDmaBaseCommonPhysicalBuffer[ 2 ];  

			physical_address += (4096 * 1 * i); 

			ULONG byte_count = 4096;

			ULONG pages = 0;

			ULONG offset = physical_address & 0x00000FFF;

			while( byte_count > 0 ) {

			   *pe++ = physical_address & 0xFFFFF000;

			   *pe++ = 0;


				pages++;

				if( pages >= 1024 ) { goto LOOP_END_AIP_MAPPINGS; }

				if( byte_count > 4096 ) {

					if( physical_address & 0x0000000000000FFF ) {

						byte_count -= (4096) - (physical_address & 0x00000FFF);
					}
					else {

						byte_count -= (4096);
					}
					physical_address &= 0xFFFFFFFFFFFFF000;

					physical_address += 0x0000000000001000;

					continue ;
				}
				else {

					break ;
				}
			}

LOOP_END_AIP_MAPPINGS:

		//	for( ; pages < 1024 ; pages++ ) {

			for( ; pages < 8 ; pages++ ) {

			   *pe++ = physical_address_dummy;

			   *pe++ = 0;
			}

			if( pAudio ) {
				
				is_complete = TRUE;

			}
			
			if( status & 0x0000000000000400 ) {
			
				SA7160_SetRegister( pDevice, 0x00008000 + 0x016C + 0x04 * (i), offset );
			}

			if( status & 0x0000000000000800 ) {
			
				SA7160_SetRegister( pDevice, 0x00008000 + 0x0190 + 0x04 * (i), offset );
			}
		}

		p_is_completes[ 0 ] = is_complete;


		ULONG * p_buffer = NULL;

//copy buffer to AP for previous channel of interrupt
		if( pDevice->m_pDmaBaseCommonBuffer[ 2 ] )
		{
			p_buffer = (ULONG *)(pDevice->m_pDmaBaseCommonBuffer[ 2 ] + (4096 * 1 * p_sys_cfg->n_previous_audio_channel) );

/*
//check 48000 Hz audio 192 byte
			if(base_ready == 1)
			{
				int block_ptr = 0;

				//LINUXV4L2_DEBUG( KERN_INFO, "n_previous_audio_channel(%d) counter(%d) offset(%d)\n", p_sys_cfg->n_previous_audio_channel, counter, offset[counter % 3] );

				for(block_ptr = offset[counter++ % 3]; block_ptr < 4096 - 192; block_ptr+=192)
				{
					memcpy( (BYTE*)Buffer1, (BYTE*)p_buffer + block_ptr, 192);

					int i = 0;
					int error = 0;

					for(i = 0;i < COMPARESIZE/2;i++)
					{
						if(Buffer[i] != Buffer1[i])
						{
							if(Buffer[i] > Buffer1[i])
								error += Buffer[i] - Buffer1[i];
							else
								error += Buffer1[i] - Buffer[i];
						}
					}
					if(error > 6000)
					{
						LINUXV4L2_DEBUG( KERN_INFO, "error audio() error(%d)\n", error );
		
			
						if(print_error < 5)
						{
							memcpy( audio_error, (BYTE*)Buffer1, 192);
							int i = 0;
							for(i = 0; i < 192; i+=16)
							{
								LINUXV4L2_DEBUG( KERN_INFO, "%02x %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x\n", audio_error[i+0], audio_error[i+1], audio_error[i+2],audio_error[i+3],audio_error[i+4],audio_error[i+5],audio_error[i+6],audio_error[i+7],audio_error[i+8],audio_error[i+9],audio_error[i+10],audio_error[i+11],audio_error[i+12],audio_error[i+13],audio_error[i+14],audio_error[i+15]);
							}

							LINUXV4L2_DEBUG( KERN_INFO, "base audio()\n" );

							memcpy( audio_base, (BYTE*)Buffer, 192);
					
							for(i = 0; i < 192; i+=16)
							{
								LINUXV4L2_DEBUG( KERN_INFO, "%02x %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x %02x\n", audio_base[i+0], audio_base[i+1], audio_base[i+2],audio_base[i+3],audio_base[i+4],audio_base[i+5],audio_base[i+6],audio_base[i+7],audio_base[i+8],audio_base[i+9],audio_base[i+10],audio_base[i+11],audio_base[i+12],audio_base[i+13],audio_base[i+14],audio_base[i+15]);
							}

							print_error ++;

						}


						break;
					}
					else
					{
						//LINUXV4L2_DEBUG( KERN_INFO, "correct audio()\n" );
						//replace base
						memcpy(Buffer, Buffer1, COMPARESIZE);

					}
				}

				LINUXV4L2_DEBUG( KERN_INFO, "finish compare, OK\n" );


			}

			if(p_sys_cfg->n_previous_audio_channel == 2)//first correct
			{
				
				if(base_ready == 0)
				{
					memcpy( (BYTE*)Buffer, (BYTE*)p_buffer, 192);
		
					base_ready = 1;
				}
			}
*/		
		}


		if( pAudio )
		{
			pout = (BYTE*) (pAudio->m_pKsSubStream->runtime->dma_area);
		}


		if( p_buffer && pout ) 
		{

			pout += pAudio->m_nFrameNumber * pAudio->m_nFrameSize;

			if( (pDevice->iManufacturer == 0x1B) && (pDevice->m_nAnalogCrossbarAudioInputProperty == 1) ) // SC510N4.SDI LINE.IN
			{
				USHORT * pe_w = (USHORT *)(pout);

				USHORT * po_w = (USHORT *)(p_buffer);

				if( pDevice->m_nKsDeviceNumber % 2 ) { po_w++; }

				ULONG i = 0;

				for( i = 0 ; i < 1024 ; i++ ) {

				   *pe_w++ = *po_w;

				   *pe_w++ = *po_w;

					po_w++;

					po_w++;
				}
			
			}
			else
			{
				memcpy( pout, p_buffer, 4096 );
			}

//			LINUXV4L2_DEBUG( KERN_INFO, "SA7160_HwProcessAnalogPCIAudioPacket() perform copy, n_previous_audio_channel(%d)\n", p_sys_cfg->n_previous_audio_channel );

		}
		else
		{
//			LINUXV4L2_DEBUG( KERN_INFO, "SA7160_HwProcessAnalogPCIAudioPacket() p_buffer(%x) pout(%x)\n", p_buffer, pout );
		}

		p_sys_cfg->n_previous_audio_channel = (i + 6) % 8; // fetch the previous 2 DMA

	}



	return TRUE;
}

static int SA7160_OnControlPanelAnalysisThread( void * p_context )
{

	CDevice * pDevice = (CDevice *)p_context;

	LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_OnControlPanelAnalysisThread( enter ) - %08X\n", (int)(pDevice->m_nKsDeviceNumber), (unsigned int)(pDevice->m_pControlThread) );

	ULONG resets = 0;

	ULONG errors = 0;

	ULONG counts = 0;

	ULONG mod = 5; 

	ULONG backup_status = -1;

	ULONG no_signals = 0;

	if( pDevice->iManufacturer == 0x1C ) { mod = 50; }; // SWITCHING.CARD

	if( pDevice->iManufacturer == 0x0A ) { mod =  1; };

	if( pDevice->iManufacturer == 0x0D ) { mod =  1; };

	if( pDevice->iManufacturer == 0x18 ) { mod =  1; };

	if( pDevice->iManufacturer == 0x1A ) { mod =  1; };

	while( wrapper_kthread_should_stop() == FALSE ) {

		//LINUXV4L2_DEBUG( KERN_INFO, "[%02d] counts(%d) start\n", (int)(pDevice->m_nKsDeviceNumber), counts );

		SA7160_SYS_CFG * p_sys_cfg = (SA7160_SYS_CFG *)(pDevice->m_pCustomSystemConfigProperty);

		if( (counts % mod) == 0 ) { 

			if( pDevice->bcdDevice == 0x12AB ||
				
				pDevice->bcdDevice == 0x1805 ) { // EURESYS

				// VIDEO FORAMT DETECTION
				//
				if( pDevice->iManufacturer == 0x19 ) { // SC510N1.2ND

					;
				}
				else if( pDevice->iManufacturer == 0x0A ||

						 pDevice->iManufacturer == 0x0D ||
						 
						 pDevice->iManufacturer == 0x18 ||

						 pDevice->iManufacturer == 0x1A ) {

						if( pDevice->iManufacturer == 0x18 ) {

							if( SA7160_IS_4K2K_ENABLED( pDevice ) ) {

								goto EXIT;
							}
						}
						CheckHDMIRX( pDevice );//6603
				}
				else if( pDevice->iManufacturer == 0x13 ) { // SC510N2.HDMI.4K2K.ADV7619

					if( g_pDevice[ pDevice->m_nKsDeviceNumber + 1 ] == NULL ) { goto EXIT; }

					if( g_pDevice[ pDevice->m_nKsDeviceNumber + 2 ] == NULL ) { goto EXIT; }

					if( g_pDevice[ pDevice->m_nKsDeviceNumber + 3 ] == NULL ) { goto EXIT; }

					BYTE R68 = 0x00;
					
					if( SA7160_GetADV7619Register( pDevice, 0x68, 0x04, &R68 ) == TRUE ) {

						if( (R68 & 0x02) == 0x02 ) {

							DWORD n_h_active = 0;

							DWORD n_v_active_1 = 0;

							DWORD n_v_active_2 = 0;

							DWORD n_h_total = 0;

							DWORD n_v_total_1 = 0;

							DWORD n_v_total_2 = 0;

							DWORD n_is_interlace = 0;

							DWORD TMDSFREQ_FRAC = 0;

							DWORD PIXEL_CLOCK = 0;

							DWORD fps = 0;

							DWORD bits = 8;

							BYTE R07 = 0;
							
							BYTE R08 = 0;
							
							BYTE R09 = 0;
							
							BYTE R0A = 0;
							
							BYTE R0B = 0;
							
							BYTE R0C = 0;
							
							BYTE R1E = 0;
							
							BYTE R1F = 0;
							
							BYTE R26 = 0;
							
							BYTE R27 = 0;
							
							BYTE R28 = 0;
							
							BYTE R29 = 0;
							
							BYTE R51 = 0;
							
							BYTE R52 = 0;

							if( SA7160_GetADV7619Register( pDevice, 0x68, 0x07, &R07 ) == FALSE ) { goto EXIT; }

							if( SA7160_GetADV7619Register( pDevice, 0x68, 0x08, &R08 ) == FALSE ) { goto EXIT; }

							n_h_active = ((R07 & 0x1F) << 8) | R08;

							if( SA7160_GetADV7619Register( pDevice, 0x68, 0x09, &R09 ) == FALSE ) { goto EXIT; }

							if( SA7160_GetADV7619Register( pDevice, 0x68, 0x0A, &R0A ) == FALSE ) { goto EXIT; }

							n_v_active_1 = ((R09 & 0x1F) << 8) | R0A;

							if( SA7160_GetADV7619Register( pDevice, 0x68, 0x0B, &R0B ) == FALSE ) { goto EXIT; }

							if( SA7160_GetADV7619Register( pDevice, 0x68, 0x0C, &R0C ) == FALSE ) { goto EXIT; }

							n_v_active_2 = ((R0B & 0x1F) << 8) | R0C;

							if( SA7160_GetADV7619Register( pDevice, 0x68, 0x1E, &R1E ) == FALSE ) { goto EXIT; }

							if( SA7160_GetADV7619Register( pDevice, 0x68, 0x1F, &R1F ) == FALSE ) { goto EXIT; }

							n_h_total = (R1E << 8) | R1F;

							if( SA7160_GetADV7619Register( pDevice, 0x68, 0x26, &R26 ) == FALSE ) { goto EXIT; }

							if( SA7160_GetADV7619Register( pDevice, 0x68, 0x27, &R27 ) == FALSE ) { goto EXIT; }

							n_v_total_1 = ((R26 & 0x3F) << 8) | R27;

							if( SA7160_GetADV7619Register( pDevice, 0x68, 0x28, &R28 ) == FALSE ) { goto EXIT; }

							if( SA7160_GetADV7619Register( pDevice, 0x68, 0x29, &R29 ) == FALSE ) { goto EXIT; }

							n_v_total_2 = ((R28 & 0x3F) << 8) | R29;

							if( SA7160_GetADV7619Register( pDevice, 0x68, 0x0B, &R0B ) == FALSE ) { goto EXIT; }

							n_is_interlace = (R0B & 0x20) >> 5;

							if( (R0B & 0xC0) == 0x00 ) {

								bits = 8;
							}
							else if( (R0B & 0xC0) == 0x40 ) {

								bits = 10;
							}
							else if( (R0B & 0xC0) == 0x80 ) {

								bits = 12;
							}
							else if( (R0B & 0xC0) == 0xC0 ) {

								bits = 16;
							}
							else {

								bits = 8;
							}
							if( SA7160_GetADV7619Register( pDevice, 0x68, 0x52, &R52 ) == FALSE ) { goto EXIT; }

							TMDSFREQ_FRAC = R52 & 0x7F;

							if( SA7160_GetADV7619Register( pDevice, 0x68, 0x51, &R51 ) == FALSE ) { goto EXIT; }

							PIXEL_CLOCK = ((R51 & 0xFF) << 1) | ((R52 & 0x80) >> 7);

							PIXEL_CLOCK *= 1000000;

							PIXEL_CLOCK += ((TMDSFREQ_FRAC * 1000000) / 128);

							if( bits == 12 ) {

								PIXEL_CLOCK = (PIXEL_CLOCK * 2) / 3;
							}
							else if( bits == 10 ) {

								PIXEL_CLOCK = (PIXEL_CLOCK * 4) / 5;
							}
							else if( bits == 16 ) {

								PIXEL_CLOCK /= 2;
							}
							else {

								;
							}
							if( n_h_total && n_v_total_1 ) {

								if( n_is_interlace ) {
			
									ULONG tmp = n_h_total * ((n_v_total_1 + n_v_total_2) >> 1);

									if( tmp ) {

										if( PIXEL_CLOCK % tmp ) {

											fps = (PIXEL_CLOCK / tmp) + 1;
										}
										else {

											fps = (PIXEL_CLOCK / tmp);
										}
										fps *= 2;
									}
								}
								else {

									n_v_total_1 >>= 1;

									ULONG tmp = n_h_total * n_v_total_1;

									if( tmp > 0 ) {

										if( PIXEL_CLOCK % tmp ) {

											fps = (PIXEL_CLOCK / tmp) + 1;
										}
										else {

											fps = (PIXEL_CLOCK / tmp);
										}
									}
								}
							}
							LINUXV4L2_DEBUG( KERN_INFO, "HACTIVE = %d, VACTIVE1 = %d, VACTIVE2 = %d, HTOTAL = %d, VTOTAL1 = %d, VTOTAL2 = %d, TMDSFREQ_FRAC = %d, PIXEL_CLOCK = %d, FPS = %d, INTERLACE = %d\n", 
								
											 n_h_active, n_v_active_1, n_v_active_2, 
											
											 n_h_total, n_v_total_1, n_v_total_2, 
											
											 TMDSFREQ_FRAC, PIXEL_CLOCK, 
											 
											 fps, n_is_interlace);
							
							ULONG x = n_h_active;

							ULONG y = n_v_active_1;

							if( x == 4096 && y == 2160 ) { x = 0; y = 0; }

							if( x != 0 && y != 0 ) {

								BYTE R05 = 0x00;

								if( SA7160_GetADV7619Register( pDevice, 0x68, 0x05, &R05 ) ) {

									pDevice->m_nAnalogCopyProtMacrovisionProperty = (R05 & 0x40) ? 1 : 0;
								}
								//should put here
								pDevice->m_nAnalogVideoDecoderStatusProperty = 1;
							}
							else {

								pDevice->m_nAnalogCopyProtMacrovisionProperty = 0;
							}
							if( p_sys_cfg->n_input_video_resolution_cx != x ||
									
								p_sys_cfg->n_input_video_resolution_cy != y ||

								p_sys_cfg->n_input_video_resolution_fps != fps ) {

								if( (x == 4096 && y == 2160 && fps >    0) ||
									
									(x >= 3840 && y == 2160 && fps >    0) ||
									
									(x >= 2800 && y == 2100 && fps >    0) ||
									
									(x == 1920 && y == 1080 && fps == 120) ) {

									p_sys_cfg->n_input_video_resolution_cx = x;

									p_sys_cfg->n_input_video_resolution_cy = y;

									p_sys_cfg->n_input_video_resolution_fps = fps;

									p_sys_cfg->n_input_video_resolution_fps_m = 0;

									p_sys_cfg->n_input_video_resolution_interleaved = 0;

									p_sys_cfg->n_input_video_resolution_h_total = 0;

									SA7160_SetADV7619Register( pDevice, 0x9A, 0x02, 0xF2 );

									SA7160_SetADV7619Register( pDevice, 0x9A, 0x05, 0x28 ); // EXTERNAL SYNC

									SA7160_SetADV7619Register( pDevice, 0x9A, 0x06, 0xA0 );

									SA7160_SetADV7619Register( pDevice, 0x9A, 0x03, 0x94 );
									
									SA7160_SetADV7619Register( pDevice, 0x4C, 0xC3, 0x80 );
									
									SA7160_SetADV7619Register( pDevice, 0x4C, 0xCF, 0x03 );
									
									SA7160_SetADV7619Register( pDevice, 0x9A, 0xDD, 0xA0 );

									SA7160_SetFpgaRegister( pDevice, 0x24, 0x01 );

									SA7160_SetFpgaRegister( pDevice, 0x25, 0x01 ); // EXTERNAL SYNC -> EMBEDDED SYNC
		
									CDevice * p_brother_device = g_pDevice[ pDevice->m_nKsDeviceNumber + 2 ];

									if( p_brother_device ) {
										
										LINUXV4L2_DEBUG( KERN_INFO, "[%02d] thread() setting FPGA(ITE6603) for 4K2K\n", (int)(pDevice->m_nKsDeviceNumber) );

										ULONG R0000E004 = SA7160_GetRegister( p_brother_device, 0x0000E000 + 0x0004 ); // GPIO.WR
										
										R0000E004 &=  0xFFFFFFF3; // 

									//	R0000E004 |=  0x00000004; // BYPASS

										R0000E004 &= ~0x00000004; // SPLIT

										SA7160_SetRegister( p_brother_device, 0x0000E000 + 0x0004, R0000E004 ); wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(50) ); // GPIO.WR (HARDWARE.RESET)

										SA7160_SetFpgaRegister( p_brother_device, 0x20, 0x01 ); // PORT#01

										SA7160_SetFpgaRegister( p_brother_device, 0x24, 0x01 );

										SA7160_SetFpgaRegister( p_brother_device, 0x25, 0x01 ); // EXTERNAL SYNC -> EMBEDDED SYNC
									}
								}
								else {

									LINUXV4L2_DEBUG( KERN_INFO, "[%02d] thread() ADV7619 not 4K2K ---\n", (int)(pDevice->m_nKsDeviceNumber) );
									
									SA7160_SetADV7619Register( pDevice, 0x9A, 0x02, 0xF5 ); //

									SA7160_SetADV7619Register( pDevice, 0x9A, 0x05, 0x2C ); // EMBEDDED SYNC

									SA7160_SetADV7619Register( pDevice, 0x9A, 0x06, 0xA6 ); //

									SA7160_SetADV7619Register( pDevice, 0x9A, 0x03, 0x80 );
									
									SA7160_SetADV7619Register( pDevice, 0x4C, 0xC3, 0x00 );
									
									SA7160_SetADV7619Register( pDevice, 0x4C, 0xCF, 0x00 );
									
									SA7160_SetADV7619Register( pDevice, 0x9A, 0xDD, 0x00 );
									
									if( y == 1200 ) {

										SA7160_SetFpgaRegister( pDevice, 0x24, 0x01 );
									}
									else {

										SA7160_SetFpgaRegister( pDevice, 0x24, 0x00 );
									}
									SA7160_SetFpgaRegister( pDevice, 0x25, 0x01 );

									if( SA7160_IS_4K2K_ENABLED( pDevice ) ) {

										CDevice * p_brother_device = g_pDevice[ pDevice->m_nKsDeviceNumber + 2 ];

										if( p_brother_device ) {
											
											SA7160_SetFpgaRegister( p_brother_device, 0x20, 0x00 ); // PORT#00

											SA7160_SetFpgaRegister( p_brother_device, 0x24, 0x00 );

											SA7160_SetFpgaRegister( p_brother_device, 0x25, 0x00 );

											SA7160_SYS_CFG * p_brother_sys_cfg = (SA7160_SYS_CFG *)(p_brother_device->m_pCustomSystemConfigProperty);

											p_brother_sys_cfg->n_input_video_resolution_cx = 0;

											p_brother_sys_cfg->n_input_video_resolution_cy = 0;

											p_brother_sys_cfg->n_input_video_resolution_fps = 0;

											p_brother_sys_cfg->n_input_video_resolution_fps_m = 0;

											p_brother_sys_cfg->n_input_video_resolution_interleaved = 0;
										}
									}
								}
								p_sys_cfg->n_input_video_resolution_cx = x;

								p_sys_cfg->n_input_video_resolution_cy = y;

								p_sys_cfg->n_input_video_resolution_fps = fps;

								p_sys_cfg->n_input_video_resolution_fps_m = 0;

								p_sys_cfg->n_input_video_resolution_interleaved = n_is_interlace;

								p_sys_cfg->n_input_video_resolution_h_total = 0;

								if( (x * y * fps) > (80000000) ||
							
									(x * y) > (2073600) ) {

									p_sys_cfg->b_input_video_resolution_spliter_mode = TRUE;
								}
								else {

									p_sys_cfg->b_input_video_resolution_spliter_mode = FALSE;
								}
								p_sys_cfg->b_input_video_signal_changed = TRUE;	

								pDevice->m_nCustomAnalogVideoResolutionProperty = (p_sys_cfg->n_input_video_resolution_cx << 16) | 

																				  (p_sys_cfg->n_input_video_resolution_cy <<  0);

								pDevice->m_nCustomAnalogVideoFrameRateProperty = (p_sys_cfg->n_input_video_resolution_fps);

								pDevice->m_nCustomAnalogVideoInterleavedProperty = (p_sys_cfg->n_input_video_resolution_interleaved);

								pDevice->m_nCustomAnalogAudioSampleFrequencyProperty = 48000;

								//pDevice->m_nAnalogVideoDecoderStatusProperty = 1;
								
								#ifdef ENABLE_1920X1080PX60FPS // +SC500

								// FPGA
								// 
								if( (pDevice->iManufacturer == 0x01 && pDevice->iProduct == 0x07) ||
						
									(pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) ||
										
									(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) ||

									(pDevice->iManufacturer == 0x1A && pDevice->m_nCustomGpioSupportProperty == 8) ||
									
									(pDevice->iManufacturer == 0x1B && pDevice->m_nCustomGpioSupportProperty == 8) ||
								
									(pDevice->iManufacturer == 0x10) ||
			
									(pDevice->iManufacturer == 0x12) ||
			
									(pDevice->iManufacturer == 0x13) ||
			
									(pDevice->iManufacturer == 0x14) ||
			
									(pDevice->iManufacturer == 0x16) ||
			
									(pDevice->iManufacturer == 0x17) ||

									(pDevice->iManufacturer == 0x18) ||
					
								   ((pDevice->iManufacturer & 0xF0) == 0x00 &&
								   
									(pDevice->iProduct & 0x0F) == 0x05) ) {

									if( (p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  768 && p_sys_cfg->n_input_video_resolution_fps ==  85) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  800 && p_sys_cfg->n_input_video_resolution_fps ==  85) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  960 && p_sys_cfg->n_input_video_resolution_fps ==  75) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  960 && p_sys_cfg->n_input_video_resolution_fps ==  85) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps ==  75) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps ==  85) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1400 && p_sys_cfg->n_input_video_resolution_cy == 1050 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy ==  900 && p_sys_cfg->n_input_video_resolution_fps ==  75) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy ==  900 && p_sys_cfg->n_input_video_resolution_fps ==  85) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1680 && p_sys_cfg->n_input_video_resolution_cy == 1050 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps ==  61) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps ==  60) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps ==  50) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 120) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1600 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
	 
										(p_sys_cfg->n_input_video_resolution_cx == 3840 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

										(p_sys_cfg->n_input_video_resolution_cx >= 3840 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
										
										(p_sys_cfg->n_input_video_resolution_cx >= 2800 && p_sys_cfg->n_input_video_resolution_cy == 2100 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
										
										(p_sys_cfg->n_input_video_resolution_cx == 4096 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

										(p_sys_cfg->n_input_video_resolution_h_total > 0 && 
										
										 p_sys_cfg->b_input_video_resolution_spliter_mode == TRUE) ) {

										if( ((pDevice->iManufacturer & 0xF0) == 0x00 &&
										   
											 (pDevice->iProduct & 0x0F) == 0x05) ) {

											SA7160_SetFpgaRegister( pDevice, 0x21, 0x01 ); // BYPASS.MODE

											SA7160_SetFpgaRegister( pDevice, 0x21, 0x00 ); // SPLIT.MODE
										}
										else if( pDevice->iManufacturer == 0x12 ||
											
												 pDevice->iManufacturer == 0x14 ) {

											SA7160_SetFpgaRegister( pDevice, 0x21, 0x01 ); // BYPASS.MODE

											SA7160_SetFpgaRegister( pDevice, 0x21, 0x00 ); // SPLIT.MODE
										}
										else if( pDevice->iManufacturer == 0x13 ||
											
												 pDevice->iManufacturer == 0x18 ||
											
												 pDevice->iManufacturer == 0x1A ) {

											LINUXV4L2_DEBUG( KERN_INFO, "[%02d] thread() setting FPGA(ADV7619) split for 4K2K\n", (int)(pDevice->m_nKsDeviceNumber) );

											ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
											
											R0000E004 |=  0x00000004; // BYPASS.MODE

											SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );

											R0000E004 &= ~0x00000004; // SPLITER.MODE

											SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );
										}
										else {

											ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
											
											R0000E004 |=  0x00020000; // BYPASS.MODE

											SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );

											R0000E004 &= ~0x00020000; // SPLITER.MODE

											SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );
										}
									}
									else {

										if( ((pDevice->iManufacturer & 0xF0) == 0x00 &&
										   
											 (pDevice->iProduct & 0x0F) == 0x05) ) {

											SA7160_SetFpgaRegister( pDevice, 0x21, 0x00 ); // SPLIT.MODE

											SA7160_SetFpgaRegister( pDevice, 0x21, 0x01 ); // BYPASS.MODE
										}
										else if( pDevice->iManufacturer == 0x12 ||
											
												 pDevice->iManufacturer == 0x14 ) {

											SA7160_SetFpgaRegister( pDevice, 0x21, 0x00 ); // SPLIT.MODE

											SA7160_SetFpgaRegister( pDevice, 0x21, 0x01 ); // BYPASS.MODE
										}
										else if( pDevice->iManufacturer == 0x13 ||
											
												 pDevice->iManufacturer == 0x18 ||
											
												 pDevice->iManufacturer == 0x1A ) {

											ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
											
											R0000E004 &= ~0x00000004; // SPLIT.MODE

											SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );

											R0000E004 |=  0x00000004; // BYPASS.MODE

											SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );
										}
										else {

											ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
											
											R0000E004 &= ~0x00020000; // SPLIT.MODE

											SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );

											R0000E004 |=  0x00020000; // BYPASS.MODE

											SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );
										}
									}
								}
								#endif
							}
						}
						else {

							if( SA7160_IS_4K2K_ENABLED( pDevice ) ) {

								CDevice * p_brother_device = g_pDevice[ pDevice->m_nKsDeviceNumber + 2 ];

								if( p_brother_device ) {
																
									SA7160_SetFpgaRegister( p_brother_device, 0x20, 0x00 ); // PORT#00

									SA7160_SetFpgaRegister( p_brother_device, 0x24, 0x00 );

									SA7160_SetFpgaRegister( p_brother_device, 0x25, 0x00 );

									SA7160_SYS_CFG * p_brother_sys_cfg = (SA7160_SYS_CFG *)(p_brother_device->m_pCustomSystemConfigProperty);

									p_brother_sys_cfg->n_input_video_resolution_cx = 0;

									p_brother_sys_cfg->n_input_video_resolution_cy = 0;

									p_brother_sys_cfg->n_input_video_resolution_fps = 0;

									p_brother_sys_cfg->n_input_video_resolution_fps_m = 0;

									p_brother_sys_cfg->n_input_video_resolution_interleaved = 0;
								}
							}
							pDevice->m_nCustomAnalogVideoResolutionProperty = 0;

							pDevice->m_nCustomAnalogVideoFrameRateProperty = 0;

							pDevice->m_nCustomAnalogVideoInterleavedProperty = 0;

							pDevice->m_nCustomAnalogAudioSampleFrequencyProperty = 0;

							pDevice->m_nAnalogCopyProtMacrovisionProperty = 0;

							pDevice->m_nAnalogVideoDecoderStatusProperty = 0;

							p_sys_cfg->n_input_video_resolution_cx = 0;

							p_sys_cfg->n_input_video_resolution_cy = 0;

							p_sys_cfg->n_input_video_resolution_fps = 0;

							p_sys_cfg->n_input_video_resolution_fps_m = 0;

							p_sys_cfg->n_input_video_resolution_interleaved = 0;
						}
					}
				}
				else {

					if( (pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x01) ||
					   
						(pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x04) ||
					   
						(pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x06) ||
						   
						(pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x07) ||
						   
						(pDevice->iProduct == 0xF5 && pDevice->iManufacturer == 0x02) ||
					   
						(pDevice->iManufacturer == 0x08) ||

						(pDevice->iManufacturer == 0x12) ||

						(pDevice->iManufacturer == 0x14) ||

						(pDevice->iManufacturer == 0x1B) ||
					   
						(pDevice->iManufacturer == 0x1C) ||
						
						(pDevice->m_nAnalogCrossbarVideoInputProperty == 4) ) {

						USHORT R00006 = SA7160_GSPI_READ_WORD( pDevice, 0x0006, 10 ) & 0x3F00; R00006 >>= 8; // VD_STD

						USHORT R0001F = SA7160_GSPI_READ_WORD( pDevice, 0x001F, 10 ) & 0x3FFF; // WORDS PER ACTIVE LINE

						USHORT R00022 = SA7160_GSPI_READ_WORD( pDevice, 0x0022, 10 ) & 0x2000; // M

						ULONG x = 0;

						ULONG y = 0;

						ULONG fps = 0;

						ULONG m = (R00022 & 0x2000) ? 1 : 0; // EX: 29.97 / 30.00

						ULONG n_blank_lines = 0;

						if( R00006 == 0x16 || R00006 == 0x17 ) { x =  720; y =  240; fps = 60; n_blank_lines =  525 -  480; }
	
						if( R00006 == 0x19 || R00006 == 0x1B ) { x =  720; y =  240; fps = 60; n_blank_lines =  525 -  480; }
	
						if( R00006 == 0x18 || R00006 == 0x1A ) { x =  720; y =  288; fps = 50; n_blank_lines =  625 -  576; }

						if( R00006 == 0x1E ) { 
							
							USHORT R00021 = SA7160_GSPI_READ_WORD( pDevice, 0x0021, 10 ) & 0x07FF; // LINES PER FRAME 

							if( R00021 == 525 ) {

							x = 720; y = 288; fps = 50; n_blank_lines = 625 - 576;
							}
							else {

							x = 720; y = 240; fps = 60; n_blank_lines = 525 - 480;
							}
						}
						if( R00006 == 0x20 || R00006 == 0x00 ) { x = 1280; y =  720; fps = 60; n_blank_lines =  750 -  720; }
	
						if( R00006 == 0x24 || R00006 == 0x04 ) { x = 1280; y =  720; fps = 50; n_blank_lines =  750 -  720; }
	
						if( R00006 == 0x22 || R00006 == 0x02 ) { x = 1280; y =  720; fps = 30; n_blank_lines =  750 -  720; }
	
						if( R00006 == 0x26 || R00006 == 0x06 ) { x = 1280; y =  720; fps = 25; n_blank_lines =  750 -  720; }
	
						if( R00006 == 0x28 || R00006 == 0x08 ) { x = 1280; y =  720; fps = 24; n_blank_lines =  750 -  720; }
	
						if( R00006 == 0x2A || R00006 == 0x0A ) { x = 1920; y =  540; fps = 60; n_blank_lines = 1125 - 1080; }
	
						if( R00006 == 0x2C || R00006 == 0x0C ) { x = 1920; y =  540; fps = 50; n_blank_lines = 1250 - 1080; }
	
						if( R00006 == 0x2B || R00006 == 0x0B ) { x = 1920; y = 1080; fps = 30; n_blank_lines = 1125 - 1080; }
	
						if( R00006 == 0x2D || R00006 == 0x0D ) { x = 1920; y = 1080; fps = 25; n_blank_lines = 1125 - 1080; }
	
						if( R00006 == 0x30 || R00006 == 0x10 ) { x = 1920; y = 1080; fps = 24; n_blank_lines = 1125 - 1080; }
	
						if( R00006 == 0x2B && R0001F == 1920 ) { x = 1920; y = 1080; fps = 60; n_blank_lines = 1125 - 1080; }
	
						if( R00006 == 0x2D && R0001F == 1920 ) { x = 1920; y = 1080; fps = 50; n_blank_lines = 1125 - 1080; }
					
						
						if( x != 0 && y != 0 ) {

							if( p_sys_cfg->n_input_video_resolution_cx != x ||

								p_sys_cfg->n_input_video_resolution_cy != y ||

								p_sys_cfg->n_input_video_resolution_fps != fps ) {

								p_sys_cfg->n_input_video_resolution_cx = x;

								p_sys_cfg->n_input_video_resolution_cy = y;

								p_sys_cfg->n_input_video_resolution_fps = fps;

								p_sys_cfg->n_input_video_resolution_fps_m = m;
	
								if( p_sys_cfg->n_input_video_resolution_cy == 240 ||
	
									p_sys_cfg->n_input_video_resolution_cy == 288 ||
	
									p_sys_cfg->n_input_video_resolution_cy == 540 ) {
	
									p_sys_cfg->n_input_video_resolution_interleaved = 1;
								}
								else {
	
									p_sys_cfg->n_input_video_resolution_interleaved = 0;
								}
								p_sys_cfg->b_input_video_signal_changed = TRUE;
	
								p_sys_cfg->n_input_audio_sampling_frequency = 48000;

								#ifdef ENABLE_1920X1080PX60FPS	// +SC500

								// FPGA
								// 
								if( (pDevice->iManufacturer == 0x01 && pDevice->iProduct == 0x07) ||
									
									(pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) ||
									
									(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) ||
	
									(pDevice->iManufacturer == 0x1A && pDevice->m_nCustomGpioSupportProperty == 8) ||
									
									(pDevice->iManufacturer == 0x1B && pDevice->m_nCustomGpioSupportProperty == 8) ||

									pDevice->iManufacturer == 0x10 ||
			
									pDevice->iManufacturer == 0x12 ||

									pDevice->iManufacturer == 0x13 ||

									pDevice->iManufacturer == 0x14 ||

									pDevice->iManufacturer == 0x16 ||

									pDevice->iManufacturer == 0x17 ||

									pDevice->iManufacturer == 0x18 ||

								   ((pDevice->iManufacturer & 0xF0) == 0x00 &&
								   
									(pDevice->iProduct & 0x0F) == 0x05) ) {

									ULONG n_skip_even_lines = 0;
	
									ULONG n_skip_odd_lines = 0;
	
									if( pDevice->m_nCustomAnalogVideoVbiLinesEnableProperty == TRUE &&
										
										pDevice->m_nCustomAnalogVideoVbiLinesProperty > 0 && 
										
										n_blank_lines > pDevice->m_nCustomAnalogVideoVbiLinesProperty ) {
	
										if( p_sys_cfg->n_input_video_resolution_interleaved ) {
	
											p_sys_cfg->n_input_video_resolution_vbi_lines = (pDevice->m_nCustomAnalogVideoVbiLinesProperty >> 1);
	
											n_skip_even_lines = ((n_blank_lines - pDevice->m_nCustomAnalogVideoVbiLinesProperty) + 1) >> 1;
	
											n_skip_odd_lines = ((n_blank_lines - pDevice->m_nCustomAnalogVideoVbiLinesProperty) + 0) >> 1;
										}
										else {
	
											p_sys_cfg->n_input_video_resolution_vbi_lines = pDevice->m_nCustomAnalogVideoVbiLinesProperty;
	
											n_skip_even_lines = n_blank_lines - pDevice->m_nCustomAnalogVideoVbiLinesProperty;
	
											n_skip_odd_lines = n_blank_lines - pDevice->m_nCustomAnalogVideoVbiLinesProperty;
										}
										p_sys_cfg->b_input_video_resolution_spliter_mode = TRUE;
	
										p_sys_cfg->n_input_video_resolution_h_total = 1;	
									}
									else {
	
										p_sys_cfg->n_input_video_resolution_vbi_lines = 0;
											
										p_sys_cfg->n_input_video_resolution_h_total = 0;
	
										p_sys_cfg->b_input_video_resolution_spliter_mode = FALSE;
	
										n_skip_even_lines = 0;
	
										n_skip_odd_lines = 0;
									}
									SA7160_SetFpgaRegister( pDevice, 0x26, (BYTE)(n_skip_even_lines) ); // [PROGRAM PATCH] SUPPORT VBI

									SA7160_SetFpgaRegister( pDevice, 0x27, (BYTE)(n_skip_odd_lines) ); // [PROGRAM PATCH] SUPPORT VBI

									if( (p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  768 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  800 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  960 && p_sys_cfg->n_input_video_resolution_fps == 75) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  960 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps == 75) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1400 && p_sys_cfg->n_input_video_resolution_cy == 1050 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy ==  900 && p_sys_cfg->n_input_video_resolution_fps == 75) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy ==  900 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1680 && p_sys_cfg->n_input_video_resolution_cy == 1050 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 61) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 60) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 50) ||

										(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 120) ||
	
										(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
	
										(p_sys_cfg->n_input_video_resolution_cx == 1600 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
	
										(p_sys_cfg->n_input_video_resolution_cx == 3840 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
	
										(p_sys_cfg->n_input_video_resolution_cx >= 3840 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
										
										(p_sys_cfg->n_input_video_resolution_cx >= 2800 && p_sys_cfg->n_input_video_resolution_cy == 2100 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
	
										(p_sys_cfg->n_input_video_resolution_cx == 4096 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
	
										(p_sys_cfg->n_input_video_resolution_h_total > 0 && 

									 	p_sys_cfg->b_input_video_resolution_spliter_mode == TRUE) ) {

										if( ((pDevice->iManufacturer & 0xF0) == 0x00 &&
										   
											 (pDevice->iProduct & 0x0F) == 0x05) ) {

											SA7160_SetFpgaRegister( pDevice, 0x21, 0x01 ); // BYPASS.MODE

											SA7160_SetFpgaRegister( pDevice, 0x21, 0x00 ); // SPLIT.MODE
										}
										else if( pDevice->iManufacturer == 0x12 || 
										
												pDevice->iManufacturer == 0x14) {

											SA7160_SetFpgaRegister( pDevice, 0x21, 0x01 ); // BYPASS.MODE

											SA7160_SetFpgaRegister( pDevice, 0x21, 0x00 ); // SPLIT.MODE
										}
										else if( pDevice->iManufacturer == 0x13 ||
												
												pDevice->iManufacturer == 0x18 ||

												pDevice->iManufacturer == 0x1A	) {

											ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
											
											R0000E004 |=  0x00000004; // BYPASS.MODE

											SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );

											R0000E004 &= ~0x00000004; // SPLITER.MODE

											SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );
										}
										else {

											ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
											
											R0000E004 |=  0x00020000; // BYPASS.MODE

											SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );

											R0000E004 &= ~0x00020000; // SPLITER.MODE

											SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );
										}
									}
									else {

										if( ((pDevice->iManufacturer & 0xF0) == 0x00 &&
										   
											 (pDevice->iProduct & 0x0F) == 0x05) ) {

											SA7160_SetFpgaRegister( pDevice, 0x21, 0x00 ); // SPLIT.MODE

											SA7160_SetFpgaRegister( pDevice, 0x21, 0x01 ); // BYPASS.MODE
										}
										else if( pDevice->iManufacturer == 0x12 ||
											
												pDevice->iManufacturer == 0x14 ) {

											SA7160_SetFpgaRegister( pDevice, 0x21, 0x00 ); // SPLIT.MODE

											SA7160_SetFpgaRegister( pDevice, 0x21, 0x01 ); // BYPASS.MODE
										}
										else if( pDevice->iManufacturer == 0x13 ||
												
												pDevice->iManufacturer == 0x18 ||

												pDevice->iManufacturer == 0x1A	) {

											ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
											
											R0000E004 &= ~0x00000004; // SPLIT.MODE

											SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );

											R0000E004 |=  0x00000004; // BYPASS.MODE

											SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );
										}
										else {

											ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
											
											R0000E004 &= ~0x00020000; // SPLIT.MODE

											SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );

											R0000E004 |=  0x00020000; // BYPASS.MODE

											SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );
										}
									}
								}
								#endif
							}
							LINUXV4L2_DEBUG( KERN_INFO, "[%d] GV7601_SDI_MODE_DETECT( %d x %d x %d )\n", pDevice->m_nKsDeviceNumber, (ULONG)(x), (ULONG)(y), (ULONG)(fps) );

							pDevice->m_nCustomAnalogVideoResolutionProperty = (p_sys_cfg->n_input_video_resolution_cx << 16) | 
	
																			  (p_sys_cfg->n_input_video_resolution_cy <<  0);
	
							pDevice->m_nCustomAnalogVideoFrameRateProperty = (p_sys_cfg->n_input_video_resolution_fps);
	
							pDevice->m_nCustomAnalogVideoInterleavedProperty = (p_sys_cfg->n_input_video_resolution_interleaved);

							pDevice->m_nCustomAnalogAudioSampleFrequencyProperty = 48000;

							pDevice->m_nAnalogCopyProtMacrovisionProperty = 0;

							pDevice->m_nAnalogVideoDecoderStatusProperty = 1;
						}
						else {


							p_sys_cfg->n_input_video_resolution_cx = 0;
							p_sys_cfg->n_input_video_resolution_cy = 0;
							p_sys_cfg->n_input_video_resolution_fps = 0;

							LINUXV4L2_DEBUG(  KERN_INFO, "\n" );
							LINUXV4L2_DEBUG(  KERN_INFO, "[%d]GV7601_SDI_MODE_DETECT() R00006(0x%x)\n", pDevice->m_nKsDeviceNumber, R00006 );
							LINUXV4L2_DEBUG(  KERN_INFO, "[%d]GV7601_SDI_MODE_DETECT() R0001F(0x%x)\n", pDevice->m_nKsDeviceNumber, R0001F );
							LINUXV4L2_DEBUG(  KERN_INFO, "[%d]GV7601_SDI_MODE_DETECT() R00020(0x%x)\n", pDevice->m_nKsDeviceNumber, SA7160_GSPI_READ_WORD( pDevice, 0x0020, 10 ) );
							LINUXV4L2_DEBUG(  KERN_INFO, "[%d]GV7601_SDI_MODE_DETECT() R00021(0x%x)\n", pDevice->m_nKsDeviceNumber, SA7160_GSPI_READ_WORD( pDevice, 0x0021, 10 ) );
							LINUXV4L2_DEBUG(  KERN_INFO, "[%d]GV7601_SDI_MODE_DETECT() R00022(0x%x)\n", pDevice->m_nKsDeviceNumber, SA7160_GSPI_READ_WORD( pDevice, 0x0022, 10 ) );
							LINUXV4L2_DEBUG(  KERN_INFO, "[%d]GV7601_SDI_MODE_DETECT() R00023(0x%x)\n", pDevice->m_nKsDeviceNumber, SA7160_GSPI_READ_WORD( pDevice, 0x0023, 10 ) );
							LINUXV4L2_DEBUG(  KERN_INFO, "[%d]GV7601_SDI_MODE_DETECT() R00024(0x%x)\n", pDevice->m_nKsDeviceNumber, SA7160_GSPI_READ_WORD( pDevice, 0x0024, 10 ) );
							LINUXV4L2_DEBUG(  KERN_INFO, "[%d]GV7601_SDI_MODE_DETECT() R00025(0x%x)\n", pDevice->m_nKsDeviceNumber, SA7160_GSPI_READ_WORD( pDevice, 0x0025, 10 ) );
							LINUXV4L2_DEBUG(  KERN_INFO, "[%d]GV7601_SDI_MODE_DETECT() R00026(0x%x)\n", pDevice->m_nKsDeviceNumber, SA7160_GSPI_READ_WORD( pDevice, 0x0026, 10 ) );
							LINUXV4L2_DEBUG(  KERN_INFO, "\n" );

							if( (pDevice->iManufacturer == 0x1B && 
							
								pDevice->m_nCustomGpioSupportProperty == 8) ) { // +SC510N4
							
								if( p_sys_cfg->n_input_video_resolution_cx != 0 || 
									
									p_sys_cfg->n_input_video_resolution_cy != 0 ) {

									p_sys_cfg->n_input_video_resolution_cx = 0;

									p_sys_cfg->n_input_video_resolution_cy = 0;

									p_sys_cfg->n_input_video_resolution_fps = 0;

									p_sys_cfg->n_input_video_resolution_fps_m = 0;

									p_sys_cfg->n_input_video_resolution_interleaved = 0;

									ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
									
									if( (R0000E004 & 0x00020000) == 0x00000000 ) {

										R0000E004 &= ~0x00020000; // SPLIT.MODE

										SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );

										R0000E004 |=  0x00020000; // BYPASS.MODE

										SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );
									}
								}
							}
							pDevice->m_nCustomAnalogVideoResolutionProperty = 0;

							pDevice->m_nCustomAnalogVideoFrameRateProperty = 0;

							pDevice->m_nCustomAnalogVideoInterleavedProperty = 0;

							pDevice->m_nCustomAnalogAudioSampleFrequencyProperty = 0;

							pDevice->m_nAnalogCopyProtMacrovisionProperty = 0;

							pDevice->m_nAnalogVideoDecoderStatusProperty = 0;
						}
					}
					else {

						if( pDevice->m_nAnalogCrossbarVideoInputProperty == 5 || 
							
							pDevice->m_nAnalogCrossbarVideoInputProperty == 6 ) {
							
							if( (pDevice->iManufacturer == 0x10 && pDevice->iProduct == 0xE5) || // NINTENDO SC510N1.1ST

								(pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST
										
								(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) || // EURESYS.SC512N1.DVI.1ST

								(pDevice->iManufacturer == 0x17) ) { // SC512N1.DVI.1ST
								
								//if( pDevice->m_nAnalogVideoDecoderStandardProperty & SUPPORTED_ANALOG_VIDEO_STANDARDS_60HZ ) {
								if( pDevice->m_nCustomVideoStandardProperty & V4L2_STD_525_60 ) {

									pDevice->m_nAnalogVideoDecoderStatusProperty = ((SA7160_GetAnalogVideoDecoderRegister( pDevice, 0x01 ) & 0xC9) == 0x48) ? 1 : 0; wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(1) );
								}

								//if( pDevice->m_nAnalogVideoDecoderStandardProperty & SUPPORTED_ANALOG_VIDEO_STANDARDS_50HZ ) {
								if( pDevice->m_nCustomVideoStandardProperty & V4L2_STD_625_50 ) {

									pDevice->m_nAnalogVideoDecoderStatusProperty = ((SA7160_GetAnalogVideoDecoderRegister( pDevice, 0x01 ) & 0xC9) == 0x49) ? 1 : 0; wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(1) );
								}
								if( pDevice->m_nAnalogVideoDecoderStatusProperty == 1 ) {

									BYTE R30 = 0;
									
									R30 = (BYTE)(SA7160_GetAnalogVideoDecoderRegister( pDevice, 0x30 )) & 0x0F;
									
									if( (R30 & 0x06) == 0x04 ) {

										pDevice->m_nAnalogCopyProtMacrovisionProperty = 1;
									}
									else if( (R30 & 0x07) == 0x07 ) {

										pDevice->m_nAnalogCopyProtMacrovisionProperty = 2;
									}
									else if( (R30 & 0x07) == 0x06 ) {

										pDevice->m_nAnalogCopyProtMacrovisionProperty = 3;
									}
									else {

										pDevice->m_nAnalogCopyProtMacrovisionProperty = 0;
									}
									if( pDevice->m_nAnalogCopyProtMacrovisionProperty == 0 ) {

										BYTE R53 = 0x80;

										BYTE R54 = 0x00;
										
										R53 = (BYTE)(SA7160_GetAnalogVideoDecoderRegister( pDevice, 0x53 ));

										if( R53 & 0x80 ) {

											;
										}
										else {

											R54 = (BYTE)(SA7160_GetAnalogVideoDecoderRegister( pDevice, 0x54 ));

											if( R54 & 0xC0 ) {

												pDevice->m_nAnalogCopyProtMacrovisionProperty = 3;
											}
										}
									}
								}
								else {

									pDevice->m_nAnalogCopyProtMacrovisionProperty = 0;
								}
							}
							else {

								pDevice->m_nAnalogVideoDecoderStatusProperty = 0;

								pDevice->m_nAnalogCopyProtMacrovisionProperty = 0;
							}
						}
						else {

							MST3367_VideoFormatDetection( pDevice );

						}
					}
				}
			}
		}

		if( pDevice->iManufacturer == 0x0A ||

			pDevice->iManufacturer == 0x0D ||

			pDevice->iManufacturer == 0x18 ||
			
			pDevice->iManufacturer == 0x1A ) {

			if( pDevice->m_nAnalogCaptureStreamPowerReference > 0 &&
				
				pDevice->m_nAnalogVideoDecoderStatusProperty == 1 ) {

				if( pDevice->m_nDmaBaseCommonBufferNumber[ 0 ] > 0 ) {

					pDevice->m_nDmaBaseCommonBufferNumber[ 0 ] = 0;
				}
				else {

					ULONG R0000AFC0 = SA7160_GetRegister( pDevice, 0x0000A000 + 0x0FC0 );

					ULONG R0000AFC4 = SA7160_GetRegister( pDevice, 0x0000A000 + 0x0FC4 );

					if( R0000AFC0 ) { SA7160_SetRegister( pDevice, 0x0000A000 + 0x0FC8, R0000AFC0 ); } //

					if( R0000AFC4 ) { SA7160_SetRegister( pDevice, 0x0000A000 + 0x0FCC, R0000AFC4 ); } //

					LINUXV4L2_PRINT( KERN_INFO, "[%02d] [PCI.RESET] [%08X x %08X]\n", pDevice->m_nKsDeviceNumber, R0000AFC0, R0000AFC4);

					pDevice->m_hInterruptAccessLock = TRUE;

				}
			}
		}
		BOOL is_dma_reset = FALSE;

		if( pDevice->m_nAnalogCaptureStreamPowerReference > 0 ) {

			if( pDevice->m_nAnalogVideoDecoderStatusProperty == 1 &&

				backup_status == 0 ) {

				is_dma_reset = TRUE;
			}
			backup_status = pDevice->m_nAnalogVideoDecoderStatusProperty;
		}
		if( pDevice->m_nAnalogCaptureStreamPowerReference > 0 ) {

			// FORMAT EXCHANGE
			//
			SA7160_SYS_CFG * p_sys_cfg = (SA7160_SYS_CFG *)(pDevice->m_pCustomSystemConfigProperty);
			
			if( p_sys_cfg->b_input_video_signal_changed == TRUE ) {

				p_sys_cfg->b_input_video_signal_changed = FALSE;

				is_dma_reset = TRUE;

			//	ULONG j = -1;

				ULONG j = 0;

				ULONG cx = p_sys_cfg->n_input_video_resolution_cx;

				ULONG cy = p_sys_cfg->n_input_video_resolution_cy;

				ULONG fps = p_sys_cfg->n_input_video_resolution_fps;

				ULONG interleaved = p_sys_cfg->n_input_video_resolution_interleaved;

				ULONG h_total = p_sys_cfg->n_input_video_resolution_h_total;

				if( cx == 0 || cy == 0 ) {

					cx = 720;

					cy = 240;

					fps = 60;

					interleaved = 1;

					h_total = 0;
				}
				if( cx ==  720 && cy ==  240 && fps == 60 ) { j =  0; } 

				if( cx ==  720 && cy ==  288 && fps == 50 ) { j =  1; }

				if( cx ==  720 && cy ==  480 && fps == 60 ) { j =  2; }

				if( cx ==  720 && cy ==  576 && fps == 50 ) { j =  3; }

				if( cx == 1280 && cy ==  720 && fps == 30 ) { j =  4; }

				if( cx == 1280 && cy ==  720 && fps == 25 ) { j =  5; }

				if( cx == 1280 && cy ==  720 && fps == 24 ) { j =  6; }

				if( cx == 1280 && cy ==  720 && fps == 60 ) { j =  7; }

				if( cx == 1280 && cy ==  720 && fps == 50 ) { j =  8; }

				if( cx == 1920 && cy ==  540 && fps == 60 ) { j =  9; }

				if( cx == 1920 && cy ==  540 && fps == 50 ) { j = 10; }

				if( cx == 1920 && cy == 1080 && fps == 30 ) { j = 11; }

				if( cx == 1920 && cy == 1080 && fps == 25 ) { j = 12; }

				if( cx == 1920 && cy == 1080 && fps == 24 ) { j = 13; }

				if( cx == 1920 && cy == 1080 && fps == 60 ) { j = 14; }

				if( cx == 1920 && cy == 1080 && fps == 50 ) { j = 15; }

				///////////////////////////////////////////////////////

				if( cx ==  640 && cy ==  480 && fps == 60 ) { j = 16; }

				if( cx ==  800 && cy ==  600 && fps == 60 ) { j = 17; }

				if( cx == 1024 && cy ==  768 && fps == 60 ) { j = 18; }

				if( cx == 1280 && cy ==  960 && fps == 60 ) { j = 19; }

				if( cx == 1280 && cy == 1024 && fps == 60 ) { j = 20; }

				if( cx == 1440 && cy ==  900 && fps == 60 ) { j = 21; }

				if( cx == 1440 && cy ==  240 && fps == 60 ) { j = 22; }

				if( cx == 1440 && cy ==  288 && fps == 50 ) { j = 23; }

				if( cx ==  640 && cy ==  400 && fps == 60 ) { j = 24; }

				if( cx ==  640 && cy ==  384 && fps == 60 ) { j = 25; }

				if( cx == 1280 && cy ==  768 && fps == 60 ) { j = 26; }

				if( cx == 1280 && cy ==  800 && fps == 60 ) { j = 27; }

				if( cx == 1360 && cy ==  768 && fps == 60 ) { j = 28; }

				if( cx ==  800 && cy ==  600 && fps == 75 ) { j = 29; }

				if( cx ==  800 && cy ==  600 && fps == 85 ) { j = 30; }

				if( cx == 1024 && cy ==  768 && fps == 75 ) { j = 31; }

				if( cx == 1024 && cy ==  768 && fps == 85 ) { j = 32; }

				if( cx == 1280 && cy ==  768 && fps == 75 ) { j = 33; }

				if( cx == 1280 && cy ==  768 && fps == 85 ) { j = 34; }

				if( cx == 1280 && cy ==  800 && fps == 75 ) { j = 35; }

				if( cx == 1280 && cy ==  800 && fps == 85 ) { j = 36; }

				if( cx == 1280 && cy ==  960 && fps == 75 ) { j = 37; }

				if( cx == 1280 && cy ==  960 && fps == 85 ) { j = 38; }

				if( cx == 1280 && cy == 1024 && fps == 75 ) { j = 39; }

				if( cx == 1280 && cy == 1024 && fps == 85 ) { j = 40; }

				if( cx == 1440 && cy ==  900 && fps == 75 ) { j = 41; }

				if( cx == 1440 && cy ==  900 && fps == 85 ) { j = 42; }

				if( cx == 3840 && cy == 1024 && fps == 30 ) { j = 43; }

				if( cx == 1280 && cy ==  720 && fps == 61 ) { j = 44; }

				if( cx == 1920 && cy == 1080 && fps == 61 ) { j = 45; }

				if( cx == 1280 && cy == 1024 && fps == 50 ) { j = 46; }

				if( cx == 1280 && cy ==  720 && fps == 59 ) { j = 47; }

				if( cx == 1280 && cy == 1024 && fps == 59 ) { j = 48; }

				if( cx ==  800 && cy ==  600 && fps == 56 ) { j = 49; }

				if( cx ==  640 && cy ==  480 && fps == 72 ) { j = 50; }
				
				if( cx ==  640 && cy ==  480 && fps == 75 ) { j = 51; }
				
				if( cx ==  640 && cy ==  480 && fps == 85 ) { j = 52; }
				
				if( cx ==  800 && cy ==  600 && fps == 72 ) { j = 53; }
				
				if( cx == 1024 && cy ==  768 && fps == 70 ) { j = 54; }
				
				if( cx == 1152 && cy ==  864 && fps == 75 ) { j = 55; }
				
				if( cx == 1400 && cy == 1050 && fps == 60 ) { j = 56; }
				
				if( cx == 1024 && cy ==  768 && fps == 50 ) { j = 57; }
				
				if( cx ==  720 && cy ==  400 && fps == 85 ) { j = 58; }
				
				if( cx ==  832 && cy ==  624 && fps == 75 ) { j = 59; }

				if( cx == 1064 && cy ==  600 && fps == 60 ) { j = 60; }

				if( cx == 1400 && cy == 1050 && fps == 61 ) { j = 61; }

				if( cx == 1024 && cy ==  600 && fps == 60 ) { j = 62; }

				if( cx == 1360 && cy ==  768 && fps == 61 ) { j = 63; }

				if( cx == 1440 && cy ==  540 && fps == 50 ) { j = 64; }

				if( cx == 1680 && cy == 1050 && fps >   0 ) { j = 65; }

				if( cx ==  800 && cy ==  600 && fps == 76 ) { j = 66; }

				if( cx == 1920 && cy == 1200 && fps >   0 ) { j = 67; }

				if( cx == 1600 && cy == 1200 && fps >   0 ) { j = 68; }

				if( cx == 3840 && cy == 2160 && fps >   0 ) { j = 69; }

				if( cx ==  768 && cy ==  288 && fps == 50 ) { j = 70; }

				if( cx ==  800 && cy ==  600 && fps == 55 ) { j = 71; }

				if( cx ==  768 && cy ==  512 && fps == 55 ) { j = 72; }

				if( cx ==  800 && cy ==  500 && fps == 75 ) { j = 73; }
				
				if( cx == 2800 && cy == 2100 && fps >   0 ) { j = 74; }

				ULONG REG_RESOLUTION_TABLE_CLONE[ 1 ][ 7 ][ 2 ] = { { { 0x0140, 0x00000000 + 0x00000000 }, 
				
																	  { 0x0144, 0x00000000 + 0x00000000 }, 
				
																	  { 0x0304, 0x00000000 }, 
				
																	  { 0x0300, 0x000020A0 }, 
				
																	  { 0x0100, 0x01004201 }, 
				
																	  { 0x0344, 0x00000000 }, 
				
																	  { 0x0354, 0x00000000 } } 
				};
				SA7160_SetRegister( pDevice, 0x00000000 + 0x00000000, 0x00010000 );	// VIP.MODE


				if( pDevice->iManufacturer == 0x0A ||

					pDevice->iManufacturer == 0x0D ||

					pDevice->iManufacturer == 0x13 ||

					pDevice->iManufacturer == 0x18 ||
						
					pDevice->iManufacturer == 0x1A ) {

					ULONG REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE [ 7 ] = {
						
						0x00040000, 

					   ((cx << 16) | (cy - 1)) + 0x00040000, 

					   ((cx << 16) | (cy - 0)), 

						0x000020A0 | (interleaved ?  0x80000000 : 0x00000000), 

						0x01004201 & (interleaved ? ~0x00000200 : 0xFFFFFFFF), 

						0x00000000 | (interleaved ?  cx << 2 : cx << 1),

						0x00000000 | (interleaved ?  cx << 1 : 0x00000000)
					};
					if( p_sys_cfg->b_input_video_resolution_spliter_mode == TRUE ) {

						REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 1 ] = ((cx >> 1) << 16 | (cy - 1)) + 0x00040000,
						
						REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 2 ] = ((cx >> 1) << 16 | (cy - 0)); 

						REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 5 ] = ((cx >> 1) << 1);

						REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 6 ] = 0x00000000;

						if( cy == 1200 ) {

							REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 1 ] = ((cx << 16) | ((cy >> 1) - 1)) + 0x00040000,
							
							REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 2 ] = ((cx << 16) | ((cy >> 1) - 0)); 

							REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 5 ] = ((cx << 1));

							REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 6 ] = 0x00000000;
						}
						if( (cx >= 3840 && cy == 2160) ||
							
							(cx == 4096 && cy == 2160) ||
							
							(cx == 2800 && cy == 2100) ) {

							REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 1 ] = ((cx >> 1) << 16 | ((cy >> 1) - 1)) + 0x00040000,
							
							REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 2 ] = ((cx >> 1) << 16 | ((cy >> 1) - 0)); 

							REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 5 ] = ((cx >> 1) << 1);

							REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 6 ] = 0x00000000;
						}
						if( cx == 1920 && 
							
							cy == 1080 && 
							
							fps == 120 ) {

							REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 1 ] = ((cx >> 1) << 16 | ((cy >> 1) - 1)) + 0x00040000,
							
							REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 2 ] = ((cx >> 1) << 16 | ((cy >> 1) - 0)); 

							REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 5 ] = ((cx >> 1) << 1);

							REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 6 ] = 0x00000000;
						}
					}
					else {

						if( pDevice->iManufacturer == 0x13 ) {

							REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 0 ] = REG_RESOLUTION_TABLE[ j ][ 0 ][ 1 ];

							REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 1 ] = REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ 0 ] + ((cx << 16) | 
								
																														   (cy - 1));
						}
					}
					ULONG i = 0;
					for( i = 0 ; i < 7 ; i++ ) {

						SA7160_SetRegister( pDevice, REG_RESOLUTION_TABLE_AUTO_ITE6603[ i ], REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ i ]);

						LINUXV4L2_DEBUG( KERN_INFO, "[%02d] reg(0x%x) value(0x%x) 1--\n", pDevice->m_nKsDeviceNumber, REG_RESOLUTION_TABLE_AUTO_ITE6603[ i ], REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ i ] );


						REG_RESOLUTION_TABLE_CLONE[ 0 ][ i ][ 1 ] = REG_RESOLUTION_TABLE_AUTO_ITE6603_VALUE[ i ];
					}
				}
				else if( h_total > 0 ) {

					if( p_sys_cfg->b_input_video_resolution_spliter_mode == FALSE ) {

						REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 0 ][ 1 ] = ((h_total - cx - 4) << 16);

						REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 2 ][ 1 ] = ((cx) << 16) + 

																	 ((cy) << 0);

						REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 1 ][ 1 ] = (REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 0 ][ 1 ]) +

																	 (REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 2 ][ 1 ]);

						REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 5 ][ 1 ] = ((cx) << 1);
					}
					else {

						ULONG lines = p_sys_cfg->n_input_video_resolution_vbi_lines; // [PROGRAM PATCH] SUPPORT VBI
						
						REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 0 ][ 1 ] = 0x00040000;

						REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 2 ][ 1 ] = ((cx >> 1) << 16) + 

																	 ((cy + lines) << 0);

						REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 1 ][ 1 ] = (REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 0 ][ 1 ]) +

																	 (REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 2 ][ 1 ]);

						REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 5 ][ 1 ] = ((cx >> 1) << 1);

						if( cy == 1200 ||
							
							cy == 2160 ||
							
							cy == 2100 ) {

							REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 2 ][ 1 ] = ((cx) << 16) + 

																		 ((cy) >> 1);

							REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 1 ][ 1 ] = (REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 0 ][ 1 ]) +

																		 (REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 2 ][ 1 ]);

							REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 5 ][ 1 ] = (cx << 1);
						}

						// [PROGRAM PATCH] SUPPORT VBI
						// 
						{	REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 3 ][ 1 ] = 0x000020A0 | (interleaved ?  0x80000000 : 0x00000000); 

							REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 4 ][ 1 ] = 0x01004201 & (interleaved ? ~0x00000200 : 0xFFFFFFFF); 

							REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ 6 ][ 1 ] = 0x00000000 | (interleaved ?  cx >> 2 : 0x00000000);
						}
					}
					ULONG i = 0;
					for( i = 0 ; i < 7 ; i++ ) { 

						ULONG INDEX = REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ i ][ 0 ];

						ULONG VALUE = REG_RESOLUTION_TABLE_CUSTOM[ 0 ][ i ][ 1 ];

						SA7160_SetRegister( pDevice, INDEX, VALUE );

						LINUXV4L2_DEBUG( KERN_INFO, "[%02d] j(0x%x) INDEX(0x%x) VALUE(0x%x) 3\n", (int)(pDevice->m_nKsDeviceNumber), j, INDEX, VALUE);	
			
						REG_RESOLUTION_TABLE_CLONE[ 0 ][ i ][ 1 ] = VALUE;
					}
				}
				else {

					ULONG i = 0;
					for( i = 0 ; i < 7 ; i++ ) {

						ULONG INDEX = REG_RESOLUTION_TABLE[ j ][ i ][ 0 ];

						ULONG VALUE = REG_RESOLUTION_TABLE[ j ][ i ][ 1 ];

						if( j == 0 || j == 1 ) {

							if( (pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x01) ||
				   
								(pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x04) ||
								   
								(pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x06) ||
								   
								(pDevice->iProduct == 0xC5 && pDevice->iManufacturer == 0x07) ||
								   
								(pDevice->iProduct == 0xF5 && pDevice->iManufacturer == 0x02) ||

								(pDevice->iManufacturer == 0x08) ||
								   
								(pDevice->iManufacturer == 0x12) ||
								   
								(pDevice->iManufacturer == 0x14) ||

								(pDevice->iManufacturer == 0x1B) ||
								   
								(pDevice->iManufacturer == 0x1C) ||
								
								(pDevice->m_nAnalogCrossbarVideoInputProperty == 4) ) { // SDI.SD

								INDEX = REG_RESOLUTION_TABLE_GV7601[ j ][ i ][ 0 ];

								VALUE = REG_RESOLUTION_TABLE_GV7601[ j ][ i ][ 1 ];
							}
							else if( pDevice->m_nAnalogCrossbarVideoInputProperty == 5 ||  // COMPOSITE

									 pDevice->m_nAnalogCrossbarVideoInputProperty == 6 ) { // SVIDEO

								if( pDevice->iManufacturer == 0x09 ) {

									INDEX = REG_RESOLUTION_TABLE_ADV7181[ j ][ i ][ 0 ];

									VALUE = REG_RESOLUTION_TABLE_ADV7181[ j ][ i ][ 1 ];
								}
								else {

									INDEX = REG_RESOLUTION_TABLE_TW9910[ j ][ i ][ 0 ];

									VALUE = REG_RESOLUTION_TABLE_TW9910[ j ][ i ][ 1 ];
								}
							}
							else if( pDevice->iManufacturer == 0x09 ) {

								INDEX = REG_RESOLUTION_TABLE_ADV7181[ j + 2 ][ i ][ 0 ];

								VALUE = REG_RESOLUTION_TABLE_ADV7181[ j + 2 ][ i ][ 1 ];
							}
						}
						if( j == 4 || j == 5 || j == 6 ) {

							if( pDevice->m_nCustomCompanyIvsProperty ) {

								INDEX = REG_RESOLUTION_TABLE_IVS_SONY_CAMERA[ j - 4 ][ i ][ 0 ];

								VALUE = REG_RESOLUTION_TABLE_IVS_SONY_CAMERA[ j - 4 ][ i ][ 1 ];
							}
							if( p_sys_cfg->b_input_video_resolution_external_sync == TRUE ) {

								INDEX = REG_RESOLUTION_TABLE_IVS_SONY_CAMERA[ j - 4 ][ i ][ 0 ];

								VALUE = REG_RESOLUTION_TABLE_IVS_SONY_CAMERA[ j - 4 ][ i ][ 1 ];
							}
						}		
						if( j == 7 || j == 8 ) {

							if( pDevice->m_nCustomCompanyIvsProperty ) {

								INDEX = REG_RESOLUTION_TABLE_IVS_SONY_CAMERA[ j - 4 ][ i ][ 0 ];

								VALUE = REG_RESOLUTION_TABLE_IVS_SONY_CAMERA[ j - 4 ][ i ][ 1 ];
							}
						}		
						if( j == 7 || j == 8 || j == 9 || j == 10 || j == 11 || j == 12 ) {

							if( pDevice->m_nCustomSpecialCameraInputProperty == 1 ) {

								INDEX = REG_RESOLUTION_TABLE_ISMART_CAHC_CAMERA[ j - 7 ][ i ][ 0 ];

								VALUE = REG_RESOLUTION_TABLE_ISMART_CAHC_CAMERA[ j - 7 ][ i ][ 1 ];
							}
						}
						SA7160_SetRegister( pDevice, INDEX, VALUE );

						REG_RESOLUTION_TABLE_CLONE[ 0 ][ i ][ 1 ] = VALUE;
					}
				}
				SA7160_SetRegister( pDevice, 0x00000000 + 0x00000000, 0xD0020000 ); // VIP.MODE

				LINUXV4L2_DEBUG( KERN_INFO, "[%02d] [01] [FORMAT.EXCHANGE.%02d] [%d x %d x %d]\n", pDevice->m_nKsDeviceNumber, j, p_sys_cfg->n_input_video_resolution_cx, p_sys_cfg->n_input_video_resolution_cy, p_sys_cfg->n_input_video_resolution_fps );

				#ifdef ENABLE_1920X1080PX60FPS // X

				if( (pDevice->iManufacturer == 0x01 && pDevice->iProduct == 0x07) ||
					
					(pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) ||

					(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) ||

					(pDevice->iManufacturer == 0x1A && pDevice->m_nCustomGpioSupportProperty == 8) ||
					
					(pDevice->iManufacturer == 0x1B && pDevice->m_nCustomGpioSupportProperty == 8) ||

					pDevice->iManufacturer == 0x10 ||
		
					pDevice->iManufacturer == 0x12 ||

					pDevice->iManufacturer == 0x13 ||

					pDevice->iManufacturer == 0x14 ||

					pDevice->iManufacturer == 0x16 ||

					pDevice->iManufacturer == 0x17 ||

					pDevice->iManufacturer == 0x18 ) {

					if( (cx == 1280 && cy ==  768 && fps ==  85) ||

						(cx == 1280 && cy ==  800 && fps ==  85) ||

						(cx == 1280 && cy ==  960 && fps ==  75) ||

						(cx == 1280 && cy ==  960 && fps ==  85) ||

						(cx == 1280 && cy == 1024 && fps ==  75) ||

						(cx == 1280 && cy == 1024 && fps ==  85) ||

						(cx == 1400 && cy == 1050 && fps >    0) ||

						(cx == 1440 && cy ==  900 && fps ==  75) ||

						(cx == 1440 && cy ==  900 && fps ==  85) ||

						(cx == 1680 && cy == 1050 && fps >    0) ||

						(cx == 1920 && cy == 1080 && fps ==  61) ||

						(cx == 1920 && cy == 1080 && fps ==  60) ||

						(cx == 1920 && cy == 1080 && fps ==  50) ||

						(cx == 1920 && cy == 1080 && fps == 120) ||

						(cx == 1920 && cy == 1200 && fps >    0) ||

						(cx == 1600 && cy == 1200 && fps >    0) ||

						(cx == 3840 && cy == 1024 && fps >    0) ||

						(cx >= 3840 && cy == 2160 && fps >    0) ||
						
						(cx >= 2800 && cy == 2100 && fps >    0) ||

						(cx == 4096 && cy == 2160 && fps >    0) ||
						
						(h_total > 0 && 
						
						 p_sys_cfg->b_input_video_resolution_spliter_mode == TRUE) ) {

						ULONG nums = 1;

						if( (cx == 4096 && cy == 2160 && fps >    0) ||
							
							(cx >= 3840 && cy == 2160 && fps >    0) ||
							
							(cx >= 2800 && cy == 2100 && fps >    0) ||
							
							(cx == 1920 && cy == 1080 && fps == 120) ) {

							nums = 3;
						}
						else {

							nums = 1;
						}
						ULONG n = 0;
						for( n = 0 ; n < nums ; n++ ) {

							CDevice * pBrotherDevice = g_pDevice[ pDevice->m_nKsDeviceNumber + n + 1 ];

							if( pBrotherDevice ) {

								if( pBrotherDevice->m_nAnalogCaptureStreamPowerReference > 0 ) { break ; } // +SC510N4
							
								SA7160_SetRegister( pBrotherDevice, 0x00000000 + 0x00000000, 0x00010000 );	// VIP.MODE

								ULONG i = 0 ;
								for( i = 0 ; i < 7 ; i++ ) {

									ULONG INDEX = REG_RESOLUTION_TABLE_CLONE[ 0 ][ i ][ 0 ];

									ULONG VALUE = REG_RESOLUTION_TABLE_CLONE[ 0 ][ i ][ 1 ];

									SA7160_SetRegister( pBrotherDevice, INDEX, VALUE );

									LINUXV4L2_DEBUG( KERN_INFO, "[%02d] reg(0x%x) value(0x%x) 1!!\n", n + 1, INDEX, VALUE );
								}
								SA7160_SetRegister( pBrotherDevice, 0x00000000 + 0x00000000, 0xD0020000 ); // VIP.MODE
							}
						}
					}
				}
				#endif
			}
			
			if( pDevice->m_nAnalogVideoDecoderStatusProperty == 0 )
			{
				
				if(pDevice->iManufacturer == 0x18 && SA7160_IS_4K2K_ENABLED( pDevice ))
				{
					NULL;
				}
				else if(pDevice->iManufacturer == 0x19)
				{
					NULL;
				}
				else
				{
					pDevice->m_hInterruptAccessLock = 0x00000000;

					pDevice->m_nTaskletExtraParameterB = 0xFFFFFFFF;

					pDevice->m_nTaskletExtraParameterA = 0xFFFFFFFF; 

					wrapper_tasklet_hi_schedule( &(pDevice->m_sTasklet) );

					LINUXV4L2_DEBUG(  KERN_INFO, "[%02d] throw a colorbar pattern --\n", pDevice->m_nKsDeviceNumber );
				}
			}

			//since only one SA7160 can not handle below resolution, throw colorbar
			if( (p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  768 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

				(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  800 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

				(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  960 && p_sys_cfg->n_input_video_resolution_fps == 75) ||

				(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  960 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

				(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps == 75) ||

				(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

				(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy ==  900 && p_sys_cfg->n_input_video_resolution_fps == 75) ||

				(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy ==  900 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

				(p_sys_cfg->n_input_video_resolution_cx == 1680 && p_sys_cfg->n_input_video_resolution_cy == 1050 && p_sys_cfg->n_input_video_resolution_fps == 60) ||

				(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 61) ||

				(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 60) ||

				(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 50) ||

				(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps == 30) ||

				(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps == 50) ||

				(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps == 60) ||

				(p_sys_cfg->n_input_video_resolution_cx == 3840 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps == 30) ) {
				
					if( ( (pDevice->iManufacturer & 0xF0) == 0x00 && (pDevice->iProduct & 0x0F) == 0x05) ||
						
							(pDevice->iManufacturer == 0x00 && (pDevice->iProduct & 0x0F) == 0x07 ) ||
																								
							(pDevice->iManufacturer == 0x03 && (pDevice->iProduct & 0x0F) == 0x07) )
					{
						pDevice->m_hInterruptAccessLock = 0x00000000;

						pDevice->m_nTaskletExtraParameterB = 0xFFFFFFFF;

						pDevice->m_nTaskletExtraParameterA = 0xFFFFFFFF; 

						wrapper_tasklet_hi_schedule( &(pDevice->m_sTasklet) );

						LINUXV4L2_DEBUG(  KERN_INFO, "[%d]throw a colorbar pattern ++\n", pDevice->m_nKsDeviceNumber );
					}
			}

			if( pDevice->m_nAnalogCaptureStreamPowerReference > 0 ) {
					
				// ERROR CHECKING
				// 
				if( (pDevice->iManufacturer == 0x01 && pDevice->iProduct == 0x07) ||
			
					(pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) ||
								
					(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) ||

					(pDevice->iManufacturer == 0x1A && pDevice->m_nCustomGpioSupportProperty == 8) ||
							
					(pDevice->iManufacturer == 0x1B && pDevice->m_nCustomGpioSupportProperty == 8) ||
					
					(pDevice->iManufacturer == 0x10) ||

					(pDevice->iManufacturer == 0x12) ||

					(pDevice->iManufacturer == 0x13) ||

					(pDevice->iManufacturer == 0x14) ||

					(pDevice->iManufacturer == 0x16) ||

					(pDevice->iManufacturer == 0x17) ||

					(pDevice->iManufacturer == 0x18) ||
			
				   ((pDevice->iManufacturer & 0xF0) == 0x00 &&
				   
					(pDevice->iProduct & 0x0F) == 0x05) ) {

					if( (p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  768 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

						(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  800 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

						(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  960 && p_sys_cfg->n_input_video_resolution_fps == 75) ||

						(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  960 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

						(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps == 75) ||

						(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

						(p_sys_cfg->n_input_video_resolution_cx == 1400 && p_sys_cfg->n_input_video_resolution_cy == 1050 && p_sys_cfg->n_input_video_resolution_fps >   0) ||

						(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy ==  900 && p_sys_cfg->n_input_video_resolution_fps == 75) ||

						(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy ==  900 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

						(p_sys_cfg->n_input_video_resolution_cx == 1680 && p_sys_cfg->n_input_video_resolution_cy == 1050 && p_sys_cfg->n_input_video_resolution_fps >   0) ||

						(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 61) ||

						(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 60) ||

						(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 50) ||

						(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 120) ||

						(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps >   0) ||

						(p_sys_cfg->n_input_video_resolution_cx == 1600 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps >   0) ||

						(p_sys_cfg->n_input_video_resolution_cx == 3840 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps >   0) ||

						(p_sys_cfg->n_input_video_resolution_cx >= 3840 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

						(p_sys_cfg->n_input_video_resolution_cx >= 2800 && p_sys_cfg->n_input_video_resolution_cy == 2100 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

						(p_sys_cfg->n_input_video_resolution_cx == 4096 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
						
						(p_sys_cfg->n_input_video_resolution_h_total > 0 && 
						
						 p_sys_cfg->b_input_video_resolution_spliter_mode == TRUE) ) {
						
						BYTE CPLD_RF7 = SA7160_GetFpgaRegister( pDevice, 0xF7 );

						SA7160_SetFpgaRegister( pDevice, 0xF7, 0x00 );

						if( CPLD_RF7 == 0xA0 && resets++ >= 3 ) {

							resets = 0;
							
							is_dma_reset = TRUE;

							LINUXV4L2_PRINT( KERN_INFO, "[CH%02d] [FPGA.RESET.#X] $$$\n", pDevice->m_nKsDeviceNumber);
						}
					}
				}
				// ERROR CHECKING
				// 
				{	ULONG R00000FE0 = SA7160_GetRegister( pDevice, 0x00000000 + 0x00000FE0 ); // VIP.INT.STATUS
			
					if( pDevice->m_nAnalogVideoDecoderStatusProperty == 1 ) {

						if( (R00000FE0 & 0x00000080) ) {

							errors++;
							
							if( errors == 10 ) {

								errors = 0;

								ULONG R00000140 = SA7160_GetRegister( pDevice, 0x00000000 + 0x00000140 );

								ULONG R00000144 = SA7160_GetRegister( pDevice, 0x00000000 + 0x00000144 );

								ULONG xo = (R00000140 & 0xFFFF0000) >> 16;

								ULONG xe = (R00000144 & 0xFFFF0000) >> 16;

								LINUXV4L2_PRINT( KERN_INFO, "FROM( xo = %d, xe = %d )\n", xo, xe);

								if( xo >= 4 && 
									
									xe >= 4 ) {

									xo -= 4;

									xe -= 4;
								}
								LINUXV4L2_PRINT( KERN_INFO, "TO( xo = %d, xe = %d )\n", xo, xe);

								SA7160_SetRegister( pDevice, 0x00000000 + 0x00000140, (R00000140 & 0x0000FFFF) | (xo << 16) );

								SA7160_SetRegister( pDevice, 0x00000000 + 0x00000144, (R00000144 & 0x0000FFFF) | (xe << 16) );
							}
							
						}
						else {

							errors = 0;
						}
					}
					if( (R00000FE0 & 0x00000080) || 
						
						(is_dma_reset) ) {
			
						#ifdef ENABLE_1920X1080PX60FPS // +SC500

						// FPGA
						// 
						if( (pDevice->iManufacturer == 0x01 && pDevice->iProduct == 0x07) ||
						
							(pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) ||
					
							(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) ||

							(pDevice->iManufacturer == 0x1A && pDevice->m_nCustomGpioSupportProperty == 8) ||
											
							(pDevice->iManufacturer == 0x1B && pDevice->m_nCustomGpioSupportProperty == 8) ||
					
							(pDevice->iManufacturer == 0x10) ||
			
							(pDevice->iManufacturer == 0x12) ||
			
							(pDevice->iManufacturer == 0x13) ||
			
							(pDevice->iManufacturer == 0x14) ||
			
							(pDevice->iManufacturer == 0x16) ||
			
							(pDevice->iManufacturer == 0x17) ||

							(pDevice->iManufacturer == 0x18) ||
					
						   ((pDevice->iManufacturer & 0xF0) == 0x00 &&
						   
							(pDevice->iProduct & 0x0F) == 0x05) ) {

							if( (p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  768 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

								(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  800 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

								(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  960 && p_sys_cfg->n_input_video_resolution_fps == 75) ||

								(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  960 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

								(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps == 75) ||

								(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

								(p_sys_cfg->n_input_video_resolution_cx == 1400 && p_sys_cfg->n_input_video_resolution_cy == 1050 && p_sys_cfg->n_input_video_resolution_fps >   0) ||

								(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy ==  900 && p_sys_cfg->n_input_video_resolution_fps == 75) ||

								(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy ==  900 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

								(p_sys_cfg->n_input_video_resolution_cx == 1680 && p_sys_cfg->n_input_video_resolution_cy == 1050 && p_sys_cfg->n_input_video_resolution_fps >   0) ||

								(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 61) ||

								(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 60) ||

								(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 50) ||

								(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 120) ||

								(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps >   0) ||

								(p_sys_cfg->n_input_video_resolution_cx == 1600 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps >   0) ||

								(p_sys_cfg->n_input_video_resolution_cx == 3840 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps >   0) ||
								
								(p_sys_cfg->n_input_video_resolution_cx >= 3840 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
								
								(p_sys_cfg->n_input_video_resolution_cx >= 2800 && p_sys_cfg->n_input_video_resolution_cy == 2100 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

								(p_sys_cfg->n_input_video_resolution_cx == 4096 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
								
								(p_sys_cfg->n_input_video_resolution_h_total > 0 && 
								
								 p_sys_cfg->b_input_video_resolution_spliter_mode == TRUE) ) {

								if( ((pDevice->iManufacturer & 0xF0) == 0x00 &&
											   
									 (pDevice->iProduct & 0x0F) == 0x05) ) {

									SA7160_SetFpgaRegister( pDevice, 0x21, 0x01 ); // BYPASS.MODE

									SA7160_SetFpgaRegister( pDevice, 0x21, 0x00 ); // SPLIT.MODE
								}
								else if( pDevice->iManufacturer == 0x12 ||
									
										 pDevice->iManufacturer == 0x14 ) {

									SA7160_SetFpgaRegister( pDevice, 0x21, 0x01 ); // BYPASS.MODE

									SA7160_SetFpgaRegister( pDevice, 0x21, 0x00 ); // SPLIT.MODE
								}
								else if( pDevice->iManufacturer == 0x13 ||
									
										 pDevice->iManufacturer == 0x18 ||
									
										 pDevice->iManufacturer == 0x1A ) {

									ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
									
									R0000E004 |=  0x00000004; // BYPASS.MODE

									SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );

									R0000E004 &= ~0x00000004; // SPLITER.MODE

									SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );
								}
								else {

									ULONG R0000E004 = SA7160_GetRegister( pDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
									
									R0000E004 |=  0x00020000; // BYPASS.MODE

									SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );

									R0000E004 &= ~0x00020000; // SPLITER.MODE

									SA7160_SetRegister( pDevice, 0x0000E000 + 0x0004, R0000E004 );
								}
								LINUXV4L2_PRINT( KERN_INFO, "[CH%02d] [FPGA.RESET.#1]>>\n", pDevice->m_nKsDeviceNumber);
							}
						}
						#endif

						SA7160_SetRegister( pDevice, 0x00000000 + 0x00000FE8, 0x000003FE );	// VIP.INT.CLEAR
			
						SA7160_SetRegister( pDevice, 0x00000000 + 0x00000000, 0x00010000 );	// VIP.MODE
			
						SA7160_SetRegister( pDevice, 0x00000000 + 0x00000000, 0xD0020000 ); // VIP.MODE
						
						LINUXV4L2_PRINT( KERN_INFO, "[CH%02d] [HARDWARE.RESET.#1]<<\n", pDevice->m_nKsDeviceNumber);
					}
					#ifdef ENABLE_1920X1080PX60FPS // X

					if( (pDevice->iManufacturer == 0x01 && pDevice->iProduct == 0x07) ||
						
						(pDevice->iManufacturer == 0x04 && pDevice->iProduct == 0x07) ||
					
						(pDevice->iManufacturer == 0x0A && pDevice->iProduct == 0x07) ||

						(pDevice->iManufacturer == 0x1A && pDevice->m_nCustomGpioSupportProperty == 8) ||
									
						(pDevice->iManufacturer == 0x1B && pDevice->m_nCustomGpioSupportProperty == 8) ||
						
						(pDevice->iManufacturer == 0x10) ||
			
						(pDevice->iManufacturer == 0x12) ||
			
						(pDevice->iManufacturer == 0x13) ||
			
						(pDevice->iManufacturer == 0x14) ||
			
						(pDevice->iManufacturer == 0x16) ||
			
						(pDevice->iManufacturer == 0x17) ||

						(pDevice->iManufacturer == 0x18) ) {

						if( (p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  768 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

							(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  800 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

							(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  960 && p_sys_cfg->n_input_video_resolution_fps == 75) ||

							(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy ==  960 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

							(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps == 75) ||

							(p_sys_cfg->n_input_video_resolution_cx == 1280 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

							(p_sys_cfg->n_input_video_resolution_cx == 1400 && p_sys_cfg->n_input_video_resolution_cy == 1050 && p_sys_cfg->n_input_video_resolution_fps >   0) ||

							(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy ==  900 && p_sys_cfg->n_input_video_resolution_fps == 75) ||

							(p_sys_cfg->n_input_video_resolution_cx == 1440 && p_sys_cfg->n_input_video_resolution_cy ==  900 && p_sys_cfg->n_input_video_resolution_fps == 85) ||

							(p_sys_cfg->n_input_video_resolution_cx == 1680 && p_sys_cfg->n_input_video_resolution_cy == 1050 && p_sys_cfg->n_input_video_resolution_fps >   0) ||

							(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 61) ||

							(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 60) ||

							(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 50) ||

							(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 120) ||

							(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps >   0) ||

							(p_sys_cfg->n_input_video_resolution_cx == 1600 && p_sys_cfg->n_input_video_resolution_cy == 1200 && p_sys_cfg->n_input_video_resolution_fps >   0) ||

							(p_sys_cfg->n_input_video_resolution_cx == 3840 && p_sys_cfg->n_input_video_resolution_cy == 1024 && p_sys_cfg->n_input_video_resolution_fps >   0) ||

							(p_sys_cfg->n_input_video_resolution_cx >= 3840 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
							
							(p_sys_cfg->n_input_video_resolution_cx >= 2800 && p_sys_cfg->n_input_video_resolution_cy == 2100 && p_sys_cfg->n_input_video_resolution_fps >    0) ||

							(p_sys_cfg->n_input_video_resolution_cx == 4096 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
							
							(p_sys_cfg->n_input_video_resolution_h_total > 0 && 
							
							 p_sys_cfg->b_input_video_resolution_spliter_mode == TRUE) ) {

							ULONG nums = 1;

							if( (p_sys_cfg->n_input_video_resolution_cx == 4096 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
								
								(p_sys_cfg->n_input_video_resolution_cx >= 3840 && p_sys_cfg->n_input_video_resolution_cy == 2160 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
								
								(p_sys_cfg->n_input_video_resolution_cx >= 2800 && p_sys_cfg->n_input_video_resolution_cy == 2100 && p_sys_cfg->n_input_video_resolution_fps >    0) ||
								
								(p_sys_cfg->n_input_video_resolution_cx == 1920 && p_sys_cfg->n_input_video_resolution_cy == 1080 && p_sys_cfg->n_input_video_resolution_fps == 120) ) {

								nums = 3;
							}
							else {

								nums = 1;
							}

							ULONG n = 0;
							for( n = 0 ; n < nums ; n++ ) {

								CDevice * pBrotherDevice = g_pDevice[ pDevice->m_nKsDeviceNumber + n + 1 ];

								if( pBrotherDevice ) {
									
									if( pBrotherDevice->m_nAnalogCaptureStreamPowerReference > 0 ) { break ; } // +SC510N4

									ULONG R00000FE0 = SA7160_GetRegister( pBrotherDevice, 0x00000000 + 0x00000FE0 ); // VIP.INT.STATUS

									if( (R00000FE0 & 0x00000080) || 
							
										(is_dma_reset) ) {
							
										if( pDevice->iManufacturer == 0x13 && n == 1 ) {

											ULONG R0000E004 = SA7160_GetRegister( pBrotherDevice, 0x0000E000 + 0x0004 ); // GPIO.WR
											
											R0000E004 |=  0x00000004; // BYPASS.MODE

											SA7160_SetRegister( pBrotherDevice, 0x0000E000 + 0x0004, R0000E004 );

											R0000E004 &= ~0x00000004; // SPLITER.MODE

											SA7160_SetRegister( pBrotherDevice, 0x0000E000 + 0x0004, R0000E004 );
											
											LINUXV4L2_PRINT( KERN_INFO, "[CH%02d] [FPGA.RESET.#%d] **\n", pDevice->m_nKsDeviceNumber, n + 2);
										}
										SA7160_SetRegister( pBrotherDevice, 0x00000000 + 0x00000FE8, 0x000003FE ); // VIP.INT.CLEAR
							
										SA7160_SetRegister( pBrotherDevice, 0x00000000 + 0x00000000, 0x00010000 ); // VIP.MODE
							
										SA7160_SetRegister( pBrotherDevice, 0x00000000 + 0x00000000, 0xD0020000 ); // VIP.MODE
							
										LINUXV4L2_PRINT( KERN_INFO, "[CH%02d] [HARDWARE.RESET.#%d] mmm\n", pDevice->m_nKsDeviceNumber, n + 2);
									}
								}
							}
						}
					}
					#endif
				}
			}



		}
		//LINUXV4L2_DEBUG( KERN_INFO, "[%02d] m_nAnalogVideoDecoderStatusProperty(0d%d)\n", (int)(pDevice->m_nKsDeviceNumber), pDevice->m_nAnalogVideoDecoderStatusProperty );

EXIT:
		//LINUXV4L2_DEBUG( KERN_INFO, "[%02d] counts(%d) end\n", (int)(pDevice->m_nKsDeviceNumber), counts );

		counts++;

		wrapper_schedule_timeout_interruptible( wrapper_msecs_to_jiffies(100) );
		
	}
	LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_OnControlPanelAnalysisThread( exit ) - %08X\n", (int)(pDevice->m_nKsDeviceNumber), (unsigned int)(pDevice->m_pControlThread) );

	return 0;	
}

static int SA7160_StartControlPanelAnalysisThread( CDevice * pDevice )
{

	if( pDevice->m_pControlThread == NULL )
	{
		LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_StartControlPanelAnalysisThread()\n", (int)(pDevice->m_nKsDeviceNumber) );
	
		pDevice->m_pControlThread = wrapper_kthread_run( SA7160_OnControlPanelAnalysisThread, pDevice, "SA7160_OnControlPanelAnalysisThread" );

		if( wrapper_IS_ERR( pDevice->m_pControlThread ) ) {

			int ret = wrapper_PTR_ERR( pDevice->m_pControlThread );

			pDevice->m_pControlThread = NULL;

			return ret;
		}
	}
	return 0;
}

static int SA7160_StopControlPanelAnalysisThread( CDevice * pDevice )
{

	if( pDevice->m_pControlThread ) {

		if( pDevice->m_ReadyToStopControlThread == 0 )
		{
			pDevice->m_ReadyToStopControlThread = 1;

			LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_StopControlPanelAnalysisThread()\n", (int)(pDevice->m_nKsDeviceNumber) );

			wrapper_kthread_stop( pDevice->m_pControlThread ); // GOOD NEWS!! LINUX HAD ALREADY HELPED TO FINISH THE "STOP" SYNC.

			pDevice->m_pControlThread = NULL;

			pDevice->m_ReadyToStopControlThread = 0;

			LINUXV4L2_DEBUG( KERN_INFO, "[%02d] SA7160_StopControlPanelAnalysisThread() complete\n", (int)(pDevice->m_nKsDeviceNumber) );
		}

	}
	return 0;
}

